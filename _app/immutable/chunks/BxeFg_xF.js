import{bh as Ic,as as Cc,u as Tc,p as Mc,h as Dc,aS as In,bk as Oc}from"./Dw_raXzk.js";import{w as Te,q as de,g as ge}from"./Dy4L3Tb7.js";import{_ as Bs}from"./CLDCoJG6.js";import{k as Pi}from"./DHvfXG5j.js";function Cp(t,e,n=e){var r=new WeakSet;Ic(t,"input",async s=>{var i=s?t.defaultValue:t.value;if(i=Es(t)?ks(i):i,n(i),In!==null&&r.add(In),await Cc(),i!==(i=e())){var c=t.selectionStart,h=t.selectionEnd,f=t.value.length;if(t.value=i??"",h!==null){var g=t.value.length;c===h&&h===f&&g>f?(t.selectionStart=g,t.selectionEnd=g):(t.selectionStart=c,t.selectionEnd=Math.min(h,g))}}}),(Dc&&t.defaultValue!==t.value||Tc(e)==null&&t.value)&&(n(Es(t)?ks(t.value):t.value),In!==null&&r.add(In)),Mc(()=>{var s=e();if(t===document.activeElement){var i=Oc??In;if(r.has(i))return}Es(t)&&s===ks(t.value)||t.type==="date"&&!s&&!t.value||s!==t.value&&(t.value=s??"")})}function Es(t){var e=t.type;return e==="number"||e==="range"}function ks(t){return t===""?null:+t}function Rc(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Uo={exports:{}},ne=Uo.exports={},He,Ge;function Fs(){throw new Error("setTimeout has not been defined")}function $s(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?He=setTimeout:He=Fs}catch{He=Fs}try{typeof clearTimeout=="function"?Ge=clearTimeout:Ge=$s}catch{Ge=$s}})();function Lo(t){if(He===setTimeout)return setTimeout(t,0);if((He===Fs||!He)&&setTimeout)return He=setTimeout,setTimeout(t,0);try{return He(t,0)}catch{try{return He.call(null,t,0)}catch{return He.call(this,t,0)}}}function Uc(t){if(Ge===clearTimeout)return clearTimeout(t);if((Ge===$s||!Ge)&&clearTimeout)return Ge=clearTimeout,clearTimeout(t);try{return Ge(t)}catch{try{return Ge.call(null,t)}catch{return Ge.call(this,t)}}}var rt=[],Zt=!1,_t,xr=-1;function Lc(){!Zt||!_t||(Zt=!1,_t.length?rt=_t.concat(rt):xr=-1,rt.length&&No())}function No(){if(!Zt){var t=Lo(Lc);Zt=!0;for(var e=rt.length;e;){for(_t=rt,rt=[];++xr<e;)_t&&_t[xr].run();xr=-1,e=rt.length}_t=null,Zt=!1,Uc(t)}}ne.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];rt.push(new Bo(t,e)),rt.length===1&&!Zt&&Lo(No)};function Bo(t,e){this.fun=t,this.array=e}Bo.prototype.run=function(){this.fun.apply(null,this.array)};ne.title="browser";ne.browser=!0;ne.env={};ne.argv=[];ne.version="";ne.versions={};function at(){}ne.on=at;ne.addListener=at;ne.once=at;ne.off=at;ne.removeListener=at;ne.removeAllListeners=at;ne.emit=at;ne.prependListener=at;ne.prependOnceListener=at;ne.listeners=function(t){return[]};ne.binding=function(t){throw new Error("process.binding is not supported")};ne.cwd=function(){return"/"};ne.chdir=function(t){throw new Error("process.chdir is not supported")};ne.umask=function(){return 0};var Nc=Uo.exports;const St=Rc(Nc);var Bc={},Xr={};Xr.byteLength=Pc;Xr.toByteArray=jc;Xr.fromByteArray=Gc;var We=[],De=[],Fc=typeof Uint8Array<"u"?Uint8Array:Array,Ss="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Ht=0,$c=Ss.length;Ht<$c;++Ht)We[Ht]=Ss[Ht],De[Ss.charCodeAt(Ht)]=Ht;De[45]=62;De[95]=63;function Fo(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function Pc(t){var e=Fo(t),n=e[0],r=e[1];return(n+r)*3/4-r}function Vc(t,e,n){return(e+n)*3/4-n}function jc(t){var e,n=Fo(t),r=n[0],s=n[1],i=new Fc(Vc(t,r,s)),c=0,h=s>0?r-4:r,f;for(f=0;f<h;f+=4)e=De[t.charCodeAt(f)]<<18|De[t.charCodeAt(f+1)]<<12|De[t.charCodeAt(f+2)]<<6|De[t.charCodeAt(f+3)],i[c++]=e>>16&255,i[c++]=e>>8&255,i[c++]=e&255;return s===2&&(e=De[t.charCodeAt(f)]<<2|De[t.charCodeAt(f+1)]>>4,i[c++]=e&255),s===1&&(e=De[t.charCodeAt(f)]<<10|De[t.charCodeAt(f+1)]<<4|De[t.charCodeAt(f+2)]>>2,i[c++]=e>>8&255,i[c++]=e&255),i}function qc(t){return We[t>>18&63]+We[t>>12&63]+We[t>>6&63]+We[t&63]}function Hc(t,e,n){for(var r,s=[],i=e;i<n;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(qc(r));return s.join("")}function Gc(t){for(var e,n=t.length,r=n%3,s=[],i=16383,c=0,h=n-r;c<h;c+=i)s.push(Hc(t,c,c+i>h?h:c+i));return r===1?(e=t[n-1],s.push(We[e>>2]+We[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(We[e>>10]+We[e>>4&63]+We[e<<2&63]+"=")),s.join("")}var ni={};ni.read=function(t,e,n,r,s){var i,c,h=s*8-r-1,f=(1<<h)-1,g=f>>1,l=-7,m=n?s-1:0,d=n?-1:1,w=t[e+m];for(m+=d,i=w&(1<<-l)-1,w>>=-l,l+=h;l>0;i=i*256+t[e+m],m+=d,l-=8);for(c=i&(1<<-l)-1,i>>=-l,l+=r;l>0;c=c*256+t[e+m],m+=d,l-=8);if(i===0)i=1-g;else{if(i===f)return c?NaN:(w?-1:1)*(1/0);c=c+Math.pow(2,r),i=i-g}return(w?-1:1)*c*Math.pow(2,i-r)};ni.write=function(t,e,n,r,s,i){var c,h,f,g=i*8-s-1,l=(1<<g)-1,m=l>>1,d=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,w=r?0:i-1,k=r?1:-1,A=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(h=isNaN(e)?1:0,c=l):(c=Math.floor(Math.log(e)/Math.LN2),e*(f=Math.pow(2,-c))<1&&(c--,f*=2),c+m>=1?e+=d/f:e+=d*Math.pow(2,1-m),e*f>=2&&(c++,f/=2),c+m>=l?(h=0,c=l):c+m>=1?(h=(e*f-1)*Math.pow(2,s),c=c+m):(h=e*Math.pow(2,m-1)*Math.pow(2,s),c=0));s>=8;t[n+w]=h&255,w+=k,h/=256,s-=8);for(c=c<<s|h,g+=s;g>0;t[n+w]=c&255,w+=k,c/=256,g-=8);t[n+w-k]|=A*128};(function(t){const e=Xr,n=ni,r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=l,t.SlowBuffer=V,t.INSPECT_MAX_BYTES=50;const s=2147483647;t.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:c,SharedArrayBuffer:h}=globalThis;l.TYPED_ARRAY_SUPPORT=f(),!l.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function f(){try{const u=new i(1),o={foo:function(){return 42}};return Object.setPrototypeOf(o,i.prototype),Object.setPrototypeOf(u,o),u.foo()===42}catch{return!1}}Object.defineProperty(l.prototype,"parent",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.buffer}}),Object.defineProperty(l.prototype,"offset",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.byteOffset}});function g(u){if(u>s)throw new RangeError('The value "'+u+'" is invalid for option "size"');const o=new i(u);return Object.setPrototypeOf(o,l.prototype),o}function l(u,o,a){if(typeof u=="number"){if(typeof o=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return k(u)}return m(u,o,a)}l.poolSize=8192;function m(u,o,a){if(typeof u=="string")return A(u,o);if(c.isView(u))return F(u);if(u==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof u);if(je(u,c)||u&&je(u.buffer,c)||typeof h<"u"&&(je(u,h)||u&&je(u.buffer,h)))return W(u,o,a);if(typeof u=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const p=u.valueOf&&u.valueOf();if(p!=null&&p!==u)return l.from(p,o,a);const y=I(u);if(y)return y;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof u[Symbol.toPrimitive]=="function")return l.from(u[Symbol.toPrimitive]("string"),o,a);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof u)}l.from=function(u,o,a){return m(u,o,a)},Object.setPrototypeOf(l.prototype,i.prototype),Object.setPrototypeOf(l,i);function d(u){if(typeof u!="number")throw new TypeError('"size" argument must be of type number');if(u<0)throw new RangeError('The value "'+u+'" is invalid for option "size"')}function w(u,o,a){return d(u),u<=0?g(u):o!==void 0?typeof a=="string"?g(u).fill(o,a):g(u).fill(o):g(u)}l.alloc=function(u,o,a){return w(u,o,a)};function k(u){return d(u),g(u<0?0:v(u)|0)}l.allocUnsafe=function(u){return k(u)},l.allocUnsafeSlow=function(u){return k(u)};function A(u,o){if((typeof o!="string"||o==="")&&(o="utf8"),!l.isEncoding(o))throw new TypeError("Unknown encoding: "+o);const a=we(u,o)|0;let p=g(a);const y=p.write(u,o);return y!==a&&(p=p.slice(0,y)),p}function D(u){const o=u.length<0?0:v(u.length)|0,a=g(o);for(let p=0;p<o;p+=1)a[p]=u[p]&255;return a}function F(u){if(je(u,i)){const o=new i(u);return W(o.buffer,o.byteOffset,o.byteLength)}return D(u)}function W(u,o,a){if(o<0||u.byteLength<o)throw new RangeError('"offset" is outside of buffer bounds');if(u.byteLength<o+(a||0))throw new RangeError('"length" is outside of buffer bounds');let p;return o===void 0&&a===void 0?p=new i(u):a===void 0?p=new i(u,o):p=new i(u,o,a),Object.setPrototypeOf(p,l.prototype),p}function I(u){if(l.isBuffer(u)){const o=v(u.length)|0,a=g(o);return a.length===0||u.copy(a,0,0,o),a}if(u.length!==void 0)return typeof u.length!="number"||bs(u.length)?g(0):D(u);if(u.type==="Buffer"&&Array.isArray(u.data))return D(u.data)}function v(u){if(u>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return u|0}function V(u){return+u!=u&&(u=0),l.alloc(+u)}l.isBuffer=function(o){return o!=null&&o._isBuffer===!0&&o!==l.prototype},l.compare=function(o,a){if(je(o,i)&&(o=l.from(o,o.offset,o.byteLength)),je(a,i)&&(a=l.from(a,a.offset,a.byteLength)),!l.isBuffer(o)||!l.isBuffer(a))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(o===a)return 0;let p=o.length,y=a.length;for(let b=0,E=Math.min(p,y);b<E;++b)if(o[b]!==a[b]){p=o[b],y=a[b];break}return p<y?-1:y<p?1:0},l.isEncoding=function(o){switch(String(o).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(o,a){if(!Array.isArray(o))throw new TypeError('"list" argument must be an Array of Buffers');if(o.length===0)return l.alloc(0);let p;if(a===void 0)for(a=0,p=0;p<o.length;++p)a+=o[p].length;const y=l.allocUnsafe(a);let b=0;for(p=0;p<o.length;++p){let E=o[p];if(je(E,i))b+E.length>y.length?(l.isBuffer(E)||(E=l.from(E)),E.copy(y,b)):i.prototype.set.call(y,E,b);else if(l.isBuffer(E))E.copy(y,b);else throw new TypeError('"list" argument must be an Array of Buffers');b+=E.length}return y};function we(u,o){if(l.isBuffer(u))return u.length;if(c.isView(u)||je(u,c))return u.byteLength;if(typeof u!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof u);const a=u.length,p=arguments.length>2&&arguments[2]===!0;if(!p&&a===0)return 0;let y=!1;for(;;)switch(o){case"ascii":case"latin1":case"binary":return a;case"utf8":case"utf-8":return ys(u).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return a*2;case"hex":return a>>>1;case"base64":return $i(u).length;default:if(y)return p?-1:ys(u).length;o=(""+o).toLowerCase(),y=!0}}l.byteLength=we;function bt(u,o,a){let p=!1;if((o===void 0||o<0)&&(o=0),o>this.length||((a===void 0||a>this.length)&&(a=this.length),a<=0)||(a>>>=0,o>>>=0,a<=o))return"";for(u||(u="utf8");;)switch(u){case"hex":return Be(this,o,a);case"utf8":case"utf-8":return _(this,o,a);case"ascii":return ye(this,o,a);case"latin1":case"binary":return ce(this,o,a);case"base64":return G(this,o,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return j(this,o,a);default:if(p)throw new TypeError("Unknown encoding: "+u);u=(u+"").toLowerCase(),p=!0}}l.prototype._isBuffer=!0;function Se(u,o,a){const p=u[o];u[o]=u[a],u[a]=p}l.prototype.swap16=function(){const o=this.length;if(o%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let a=0;a<o;a+=2)Se(this,a,a+1);return this},l.prototype.swap32=function(){const o=this.length;if(o%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let a=0;a<o;a+=4)Se(this,a,a+3),Se(this,a+1,a+2);return this},l.prototype.swap64=function(){const o=this.length;if(o%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let a=0;a<o;a+=8)Se(this,a,a+7),Se(this,a+1,a+6),Se(this,a+2,a+5),Se(this,a+3,a+4);return this},l.prototype.toString=function(){const o=this.length;return o===0?"":arguments.length===0?_(this,0,o):bt.apply(this,arguments)},l.prototype.toLocaleString=l.prototype.toString,l.prototype.equals=function(o){if(!l.isBuffer(o))throw new TypeError("Argument must be a Buffer");return this===o?!0:l.compare(this,o)===0},l.prototype.inspect=function(){let o="";const a=t.INSPECT_MAX_BYTES;return o=this.toString("hex",0,a).replace(/(.{2})/g,"$1 ").trim(),this.length>a&&(o+=" ... "),"<Buffer "+o+">"},r&&(l.prototype[r]=l.prototype.inspect),l.prototype.compare=function(o,a,p,y,b){if(je(o,i)&&(o=l.from(o,o.offset,o.byteLength)),!l.isBuffer(o))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof o);if(a===void 0&&(a=0),p===void 0&&(p=o?o.length:0),y===void 0&&(y=0),b===void 0&&(b=this.length),a<0||p>o.length||y<0||b>this.length)throw new RangeError("out of range index");if(y>=b&&a>=p)return 0;if(y>=b)return-1;if(a>=p)return 1;if(a>>>=0,p>>>=0,y>>>=0,b>>>=0,this===o)return 0;let E=b-y,U=p-a;const Q=Math.min(E,U),K=this.slice(y,b),ee=o.slice(a,p);for(let q=0;q<Q;++q)if(K[q]!==ee[q]){E=K[q],U=ee[q];break}return E<U?-1:U<E?1:0};function Vt(u,o,a,p,y){if(u.length===0)return-1;if(typeof a=="string"?(p=a,a=0):a>2147483647?a=2147483647:a<-2147483648&&(a=-2147483648),a=+a,bs(a)&&(a=y?0:u.length-1),a<0&&(a=u.length+a),a>=u.length){if(y)return-1;a=u.length-1}else if(a<0)if(y)a=0;else return-1;if(typeof o=="string"&&(o=l.from(o,p)),l.isBuffer(o))return o.length===0?-1:Et(u,o,a,p,y);if(typeof o=="number")return o=o&255,typeof i.prototype.indexOf=="function"?y?i.prototype.indexOf.call(u,o,a):i.prototype.lastIndexOf.call(u,o,a):Et(u,[o],a,p,y);throw new TypeError("val must be string, number or Buffer")}function Et(u,o,a,p,y){let b=1,E=u.length,U=o.length;if(p!==void 0&&(p=String(p).toLowerCase(),p==="ucs2"||p==="ucs-2"||p==="utf16le"||p==="utf-16le")){if(u.length<2||o.length<2)return-1;b=2,E/=2,U/=2,a/=2}function Q(ee,q){return b===1?ee[q]:ee.readUInt16BE(q*b)}let K;if(y){let ee=-1;for(K=a;K<E;K++)if(Q(u,K)===Q(o,ee===-1?0:K-ee)){if(ee===-1&&(ee=K),K-ee+1===U)return ee*b}else ee!==-1&&(K-=K-ee),ee=-1}else for(a+U>E&&(a=E-U),K=a;K>=0;K--){let ee=!0;for(let q=0;q<U;q++)if(Q(u,K+q)!==Q(o,q)){ee=!1;break}if(ee)return K}return-1}l.prototype.includes=function(o,a,p){return this.indexOf(o,a,p)!==-1},l.prototype.indexOf=function(o,a,p){return Vt(this,o,a,p,!0)},l.prototype.lastIndexOf=function(o,a,p){return Vt(this,o,a,p,!1)};function jt(u,o,a,p){a=Number(a)||0;const y=u.length-a;p?(p=Number(p),p>y&&(p=y)):p=y;const b=o.length;p>b/2&&(p=b/2);let E;for(E=0;E<p;++E){const U=parseInt(o.substr(E*2,2),16);if(bs(U))return E;u[a+E]=U}return E}function S(u,o,a,p){return gr(ys(o,u.length-a),u,a,p)}function x(u,o,a,p){return gr(Ac(o),u,a,p)}function O(u,o,a,p){return gr($i(o),u,a,p)}function N(u,o,a,p){return gr(xc(o,u.length-a),u,a,p)}l.prototype.write=function(o,a,p,y){if(a===void 0)y="utf8",p=this.length,a=0;else if(p===void 0&&typeof a=="string")y=a,p=this.length,a=0;else if(isFinite(a))a=a>>>0,isFinite(p)?(p=p>>>0,y===void 0&&(y="utf8")):(y=p,p=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const b=this.length-a;if((p===void 0||p>b)&&(p=b),o.length>0&&(p<0||a<0)||a>this.length)throw new RangeError("Attempt to write outside buffer bounds");y||(y="utf8");let E=!1;for(;;)switch(y){case"hex":return jt(this,o,a,p);case"utf8":case"utf-8":return S(this,o,a,p);case"ascii":case"latin1":case"binary":return x(this,o,a,p);case"base64":return O(this,o,a,p);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,o,a,p);default:if(E)throw new TypeError("Unknown encoding: "+y);y=(""+y).toLowerCase(),E=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function G(u,o,a){return o===0&&a===u.length?e.fromByteArray(u):e.fromByteArray(u.slice(o,a))}function _(u,o,a){a=Math.min(u.length,a);const p=[];let y=o;for(;y<a;){const b=u[y];let E=null,U=b>239?4:b>223?3:b>191?2:1;if(y+U<=a){let Q,K,ee,q;switch(U){case 1:b<128&&(E=b);break;case 2:Q=u[y+1],(Q&192)===128&&(q=(b&31)<<6|Q&63,q>127&&(E=q));break;case 3:Q=u[y+1],K=u[y+2],(Q&192)===128&&(K&192)===128&&(q=(b&15)<<12|(Q&63)<<6|K&63,q>2047&&(q<55296||q>57343)&&(E=q));break;case 4:Q=u[y+1],K=u[y+2],ee=u[y+3],(Q&192)===128&&(K&192)===128&&(ee&192)===128&&(q=(b&15)<<18|(Q&63)<<12|(K&63)<<6|ee&63,q>65535&&q<1114112&&(E=q))}}E===null?(E=65533,U=1):E>65535&&(E-=65536,p.push(E>>>10&1023|55296),E=56320|E&1023),p.push(E),y+=U}return X(p)}const T=4096;function X(u){const o=u.length;if(o<=T)return String.fromCharCode.apply(String,u);let a="",p=0;for(;p<o;)a+=String.fromCharCode.apply(String,u.slice(p,p+=T));return a}function ye(u,o,a){let p="";a=Math.min(u.length,a);for(let y=o;y<a;++y)p+=String.fromCharCode(u[y]&127);return p}function ce(u,o,a){let p="";a=Math.min(u.length,a);for(let y=o;y<a;++y)p+=String.fromCharCode(u[y]);return p}function Be(u,o,a){const p=u.length;(!o||o<0)&&(o=0),(!a||a<0||a>p)&&(a=p);let y="";for(let b=o;b<a;++b)y+=_c[u[b]];return y}function j(u,o,a){const p=u.slice(o,a);let y="";for(let b=0;b<p.length-1;b+=2)y+=String.fromCharCode(p[b]+p[b+1]*256);return y}l.prototype.slice=function(o,a){const p=this.length;o=~~o,a=a===void 0?p:~~a,o<0?(o+=p,o<0&&(o=0)):o>p&&(o=p),a<0?(a+=p,a<0&&(a=0)):a>p&&(a=p),a<o&&(a=o);const y=this.subarray(o,a);return Object.setPrototypeOf(y,l.prototype),y};function B(u,o,a){if(u%1!==0||u<0)throw new RangeError("offset is not uint");if(u+o>a)throw new RangeError("Trying to access beyond buffer length")}l.prototype.readUintLE=l.prototype.readUIntLE=function(o,a,p){o=o>>>0,a=a>>>0,p||B(o,a,this.length);let y=this[o],b=1,E=0;for(;++E<a&&(b*=256);)y+=this[o+E]*b;return y},l.prototype.readUintBE=l.prototype.readUIntBE=function(o,a,p){o=o>>>0,a=a>>>0,p||B(o,a,this.length);let y=this[o+--a],b=1;for(;a>0&&(b*=256);)y+=this[o+--a]*b;return y},l.prototype.readUint8=l.prototype.readUInt8=function(o,a){return o=o>>>0,a||B(o,1,this.length),this[o]},l.prototype.readUint16LE=l.prototype.readUInt16LE=function(o,a){return o=o>>>0,a||B(o,2,this.length),this[o]|this[o+1]<<8},l.prototype.readUint16BE=l.prototype.readUInt16BE=function(o,a){return o=o>>>0,a||B(o,2,this.length),this[o]<<8|this[o+1]},l.prototype.readUint32LE=l.prototype.readUInt32LE=function(o,a){return o=o>>>0,a||B(o,4,this.length),(this[o]|this[o+1]<<8|this[o+2]<<16)+this[o+3]*16777216},l.prototype.readUint32BE=l.prototype.readUInt32BE=function(o,a){return o=o>>>0,a||B(o,4,this.length),this[o]*16777216+(this[o+1]<<16|this[o+2]<<8|this[o+3])},l.prototype.readBigUInt64LE=ft(function(o){o=o>>>0,qt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&vn(o,this.length-8);const y=a+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24,b=this[++o]+this[++o]*2**8+this[++o]*2**16+p*2**24;return BigInt(y)+(BigInt(b)<<BigInt(32))}),l.prototype.readBigUInt64BE=ft(function(o){o=o>>>0,qt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&vn(o,this.length-8);const y=a*2**24+this[++o]*2**16+this[++o]*2**8+this[++o],b=this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+p;return(BigInt(y)<<BigInt(32))+BigInt(b)}),l.prototype.readIntLE=function(o,a,p){o=o>>>0,a=a>>>0,p||B(o,a,this.length);let y=this[o],b=1,E=0;for(;++E<a&&(b*=256);)y+=this[o+E]*b;return b*=128,y>=b&&(y-=Math.pow(2,8*a)),y},l.prototype.readIntBE=function(o,a,p){o=o>>>0,a=a>>>0,p||B(o,a,this.length);let y=a,b=1,E=this[o+--y];for(;y>0&&(b*=256);)E+=this[o+--y]*b;return b*=128,E>=b&&(E-=Math.pow(2,8*a)),E},l.prototype.readInt8=function(o,a){return o=o>>>0,a||B(o,1,this.length),this[o]&128?(255-this[o]+1)*-1:this[o]},l.prototype.readInt16LE=function(o,a){o=o>>>0,a||B(o,2,this.length);const p=this[o]|this[o+1]<<8;return p&32768?p|4294901760:p},l.prototype.readInt16BE=function(o,a){o=o>>>0,a||B(o,2,this.length);const p=this[o+1]|this[o]<<8;return p&32768?p|4294901760:p},l.prototype.readInt32LE=function(o,a){return o=o>>>0,a||B(o,4,this.length),this[o]|this[o+1]<<8|this[o+2]<<16|this[o+3]<<24},l.prototype.readInt32BE=function(o,a){return o=o>>>0,a||B(o,4,this.length),this[o]<<24|this[o+1]<<16|this[o+2]<<8|this[o+3]},l.prototype.readBigInt64LE=ft(function(o){o=o>>>0,qt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&vn(o,this.length-8);const y=this[o+4]+this[o+5]*2**8+this[o+6]*2**16+(p<<24);return(BigInt(y)<<BigInt(32))+BigInt(a+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24)}),l.prototype.readBigInt64BE=ft(function(o){o=o>>>0,qt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&vn(o,this.length-8);const y=(a<<24)+this[++o]*2**16+this[++o]*2**8+this[++o];return(BigInt(y)<<BigInt(32))+BigInt(this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+p)}),l.prototype.readFloatLE=function(o,a){return o=o>>>0,a||B(o,4,this.length),n.read(this,o,!0,23,4)},l.prototype.readFloatBE=function(o,a){return o=o>>>0,a||B(o,4,this.length),n.read(this,o,!1,23,4)},l.prototype.readDoubleLE=function(o,a){return o=o>>>0,a||B(o,8,this.length),n.read(this,o,!0,52,8)},l.prototype.readDoubleBE=function(o,a){return o=o>>>0,a||B(o,8,this.length),n.read(this,o,!1,52,8)};function z(u,o,a,p,y,b){if(!l.isBuffer(u))throw new TypeError('"buffer" argument must be a Buffer instance');if(o>y||o<b)throw new RangeError('"value" argument is out of bounds');if(a+p>u.length)throw new RangeError("Index out of range")}l.prototype.writeUintLE=l.prototype.writeUIntLE=function(o,a,p,y){if(o=+o,a=a>>>0,p=p>>>0,!y){const U=Math.pow(2,8*p)-1;z(this,o,a,p,U,0)}let b=1,E=0;for(this[a]=o&255;++E<p&&(b*=256);)this[a+E]=o/b&255;return a+p},l.prototype.writeUintBE=l.prototype.writeUIntBE=function(o,a,p,y){if(o=+o,a=a>>>0,p=p>>>0,!y){const U=Math.pow(2,8*p)-1;z(this,o,a,p,U,0)}let b=p-1,E=1;for(this[a+b]=o&255;--b>=0&&(E*=256);)this[a+b]=o/E&255;return a+p},l.prototype.writeUint8=l.prototype.writeUInt8=function(o,a,p){return o=+o,a=a>>>0,p||z(this,o,a,1,255,0),this[a]=o&255,a+1},l.prototype.writeUint16LE=l.prototype.writeUInt16LE=function(o,a,p){return o=+o,a=a>>>0,p||z(this,o,a,2,65535,0),this[a]=o&255,this[a+1]=o>>>8,a+2},l.prototype.writeUint16BE=l.prototype.writeUInt16BE=function(o,a,p){return o=+o,a=a>>>0,p||z(this,o,a,2,65535,0),this[a]=o>>>8,this[a+1]=o&255,a+2},l.prototype.writeUint32LE=l.prototype.writeUInt32LE=function(o,a,p){return o=+o,a=a>>>0,p||z(this,o,a,4,4294967295,0),this[a+3]=o>>>24,this[a+2]=o>>>16,this[a+1]=o>>>8,this[a]=o&255,a+4},l.prototype.writeUint32BE=l.prototype.writeUInt32BE=function(o,a,p){return o=+o,a=a>>>0,p||z(this,o,a,4,4294967295,0),this[a]=o>>>24,this[a+1]=o>>>16,this[a+2]=o>>>8,this[a+3]=o&255,a+4};function Z(u,o,a,p,y){Fi(o,p,y,u,a,7);let b=Number(o&BigInt(4294967295));u[a++]=b,b=b>>8,u[a++]=b,b=b>>8,u[a++]=b,b=b>>8,u[a++]=b;let E=Number(o>>BigInt(32)&BigInt(4294967295));return u[a++]=E,E=E>>8,u[a++]=E,E=E>>8,u[a++]=E,E=E>>8,u[a++]=E,a}function se(u,o,a,p,y){Fi(o,p,y,u,a,7);let b=Number(o&BigInt(4294967295));u[a+7]=b,b=b>>8,u[a+6]=b,b=b>>8,u[a+5]=b,b=b>>8,u[a+4]=b;let E=Number(o>>BigInt(32)&BigInt(4294967295));return u[a+3]=E,E=E>>8,u[a+2]=E,E=E>>8,u[a+1]=E,E=E>>8,u[a]=E,a+8}l.prototype.writeBigUInt64LE=ft(function(o,a=0){return Z(this,o,a,BigInt(0),BigInt("0xffffffffffffffff"))}),l.prototype.writeBigUInt64BE=ft(function(o,a=0){return se(this,o,a,BigInt(0),BigInt("0xffffffffffffffff"))}),l.prototype.writeIntLE=function(o,a,p,y){if(o=+o,a=a>>>0,!y){const Q=Math.pow(2,8*p-1);z(this,o,a,p,Q-1,-Q)}let b=0,E=1,U=0;for(this[a]=o&255;++b<p&&(E*=256);)o<0&&U===0&&this[a+b-1]!==0&&(U=1),this[a+b]=(o/E>>0)-U&255;return a+p},l.prototype.writeIntBE=function(o,a,p,y){if(o=+o,a=a>>>0,!y){const Q=Math.pow(2,8*p-1);z(this,o,a,p,Q-1,-Q)}let b=p-1,E=1,U=0;for(this[a+b]=o&255;--b>=0&&(E*=256);)o<0&&U===0&&this[a+b+1]!==0&&(U=1),this[a+b]=(o/E>>0)-U&255;return a+p},l.prototype.writeInt8=function(o,a,p){return o=+o,a=a>>>0,p||z(this,o,a,1,127,-128),o<0&&(o=255+o+1),this[a]=o&255,a+1},l.prototype.writeInt16LE=function(o,a,p){return o=+o,a=a>>>0,p||z(this,o,a,2,32767,-32768),this[a]=o&255,this[a+1]=o>>>8,a+2},l.prototype.writeInt16BE=function(o,a,p){return o=+o,a=a>>>0,p||z(this,o,a,2,32767,-32768),this[a]=o>>>8,this[a+1]=o&255,a+2},l.prototype.writeInt32LE=function(o,a,p){return o=+o,a=a>>>0,p||z(this,o,a,4,2147483647,-2147483648),this[a]=o&255,this[a+1]=o>>>8,this[a+2]=o>>>16,this[a+3]=o>>>24,a+4},l.prototype.writeInt32BE=function(o,a,p){return o=+o,a=a>>>0,p||z(this,o,a,4,2147483647,-2147483648),o<0&&(o=4294967295+o+1),this[a]=o>>>24,this[a+1]=o>>>16,this[a+2]=o>>>8,this[a+3]=o&255,a+4},l.prototype.writeBigInt64LE=ft(function(o,a=0){return Z(this,o,a,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),l.prototype.writeBigInt64BE=ft(function(o,a=0){return se(this,o,a,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ie(u,o,a,p,y,b){if(a+p>u.length)throw new RangeError("Index out of range");if(a<0)throw new RangeError("Index out of range")}function le(u,o,a,p,y){return o=+o,a=a>>>0,y||ie(u,o,a,4),n.write(u,o,a,p,23,4),a+4}l.prototype.writeFloatLE=function(o,a,p){return le(this,o,a,!0,p)},l.prototype.writeFloatBE=function(o,a,p){return le(this,o,a,!1,p)};function Me(u,o,a,p,y){return o=+o,a=a>>>0,y||ie(u,o,a,8),n.write(u,o,a,p,52,8),a+8}l.prototype.writeDoubleLE=function(o,a,p){return Me(this,o,a,!0,p)},l.prototype.writeDoubleBE=function(o,a,p){return Me(this,o,a,!1,p)},l.prototype.copy=function(o,a,p,y){if(!l.isBuffer(o))throw new TypeError("argument should be a Buffer");if(p||(p=0),!y&&y!==0&&(y=this.length),a>=o.length&&(a=o.length),a||(a=0),y>0&&y<p&&(y=p),y===p||o.length===0||this.length===0)return 0;if(a<0)throw new RangeError("targetStart out of bounds");if(p<0||p>=this.length)throw new RangeError("Index out of range");if(y<0)throw new RangeError("sourceEnd out of bounds");y>this.length&&(y=this.length),o.length-a<y-p&&(y=o.length-a+p);const b=y-p;return this===o&&typeof i.prototype.copyWithin=="function"?this.copyWithin(a,p,y):i.prototype.set.call(o,this.subarray(p,y),a),b},l.prototype.fill=function(o,a,p,y){if(typeof o=="string"){if(typeof a=="string"?(y=a,a=0,p=this.length):typeof p=="string"&&(y=p,p=this.length),y!==void 0&&typeof y!="string")throw new TypeError("encoding must be a string");if(typeof y=="string"&&!l.isEncoding(y))throw new TypeError("Unknown encoding: "+y);if(o.length===1){const E=o.charCodeAt(0);(y==="utf8"&&E<128||y==="latin1")&&(o=E)}}else typeof o=="number"?o=o&255:typeof o=="boolean"&&(o=Number(o));if(a<0||this.length<a||this.length<p)throw new RangeError("Out of range index");if(p<=a)return this;a=a>>>0,p=p===void 0?this.length:p>>>0,o||(o=0);let b;if(typeof o=="number")for(b=a;b<p;++b)this[b]=o;else{const E=l.isBuffer(o)?o:l.from(o,y),U=E.length;if(U===0)throw new TypeError('The value "'+o+'" is invalid for argument "value"');for(b=0;b<p-a;++b)this[b+a]=E[b%U]}return this};const be={};function _e(u,o,a){be[u]=class extends a{constructor(){super(),Object.defineProperty(this,"message",{value:o.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${u}]`,this.stack,delete this.name}get code(){return u}set code(y){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:y,writable:!0})}toString(){return`${this.name} [${u}]: ${this.message}`}}}_e("ERR_BUFFER_OUT_OF_BOUNDS",function(u){return u?`${u} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),_e("ERR_INVALID_ARG_TYPE",function(u,o){return`The "${u}" argument must be of type number. Received type ${typeof o}`},TypeError),_e("ERR_OUT_OF_RANGE",function(u,o,a){let p=`The value of "${u}" is out of range.`,y=a;return Number.isInteger(a)&&Math.abs(a)>2**32?y=dr(String(a)):typeof a=="bigint"&&(y=String(a),(a>BigInt(2)**BigInt(32)||a<-(BigInt(2)**BigInt(32)))&&(y=dr(y)),y+="n"),p+=` It must be ${o}. Received ${y}`,p},RangeError);function dr(u){let o="",a=u.length;const p=u[0]==="-"?1:0;for(;a>=p+4;a-=3)o=`_${u.slice(a-3,a)}${o}`;return`${u.slice(0,a)}${o}`}function pr(u,o,a){qt(o,"offset"),(u[o]===void 0||u[o+a]===void 0)&&vn(o,u.length-(a+1))}function Fi(u,o,a,p,y,b){if(u>a||u<o){const E=typeof o=="bigint"?"n":"";let U;throw o===0||o===BigInt(0)?U=`>= 0${E} and < 2${E} ** ${(b+1)*8}${E}`:U=`>= -(2${E} ** ${(b+1)*8-1}${E}) and < 2 ** ${(b+1)*8-1}${E}`,new be.ERR_OUT_OF_RANGE("value",U,u)}pr(p,y,b)}function qt(u,o){if(typeof u!="number")throw new be.ERR_INVALID_ARG_TYPE(o,"number",u)}function vn(u,o,a){throw Math.floor(u)!==u?(qt(u,a),new be.ERR_OUT_OF_RANGE("offset","an integer",u)):o<0?new be.ERR_BUFFER_OUT_OF_BOUNDS:new be.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${o}`,u)}const kc=/[^+/0-9A-Za-z-_]/g;function Sc(u){if(u=u.split("=")[0],u=u.trim().replace(kc,""),u.length<2)return"";for(;u.length%4!==0;)u=u+"=";return u}function ys(u,o){o=o||1/0;let a;const p=u.length;let y=null;const b=[];for(let E=0;E<p;++E){if(a=u.charCodeAt(E),a>55295&&a<57344){if(!y){if(a>56319){(o-=3)>-1&&b.push(239,191,189);continue}else if(E+1===p){(o-=3)>-1&&b.push(239,191,189);continue}y=a;continue}if(a<56320){(o-=3)>-1&&b.push(239,191,189),y=a;continue}a=(y-55296<<10|a-56320)+65536}else y&&(o-=3)>-1&&b.push(239,191,189);if(y=null,a<128){if((o-=1)<0)break;b.push(a)}else if(a<2048){if((o-=2)<0)break;b.push(a>>6|192,a&63|128)}else if(a<65536){if((o-=3)<0)break;b.push(a>>12|224,a>>6&63|128,a&63|128)}else if(a<1114112){if((o-=4)<0)break;b.push(a>>18|240,a>>12&63|128,a>>6&63|128,a&63|128)}else throw new Error("Invalid code point")}return b}function Ac(u){const o=[];for(let a=0;a<u.length;++a)o.push(u.charCodeAt(a)&255);return o}function xc(u,o){let a,p,y;const b=[];for(let E=0;E<u.length&&!((o-=2)<0);++E)a=u.charCodeAt(E),p=a>>8,y=a%256,b.push(y),b.push(p);return b}function $i(u){return e.toByteArray(Sc(u))}function gr(u,o,a,p){let y;for(y=0;y<p&&!(y+a>=o.length||y>=u.length);++y)o[y+a]=u[y];return y}function je(u,o){return u instanceof o||u!=null&&u.constructor!=null&&u.constructor.name!=null&&u.constructor.name===o.name}function bs(u){return u!==u}const _c=(function(){const u="0123456789abcdef",o=new Array(256);for(let a=0;a<16;++a){const p=a*16;for(let y=0;y<16;++y)o[p+y]=u[a]+u[y]}return o})();function ft(u){return typeof BigInt>"u"?vc:u}function vc(){throw new Error("BigInt not supported")}})(Bc);const Ae=()=>new Map,Ps=t=>{const e=Ae();return t.forEach((n,r)=>{e.set(r,n)}),e},ct=(t,e,n)=>{let r=t.get(e);return r===void 0&&t.set(e,r=n()),r},Jc=(t,e)=>{const n=[];for(const[r,s]of t)n.push(e(s,r));return n},Wc=(t,e)=>{for(const[n,r]of t)if(e(r,n))return!0;return!1},Mt=()=>new Set,As=t=>t[t.length-1],zc=(t,e)=>{for(let n=0;n<e.length;n++)t.push(e[n])},mt=Array.from,ri=(t,e)=>{for(let n=0;n<t.length;n++)if(!e(t[n],n,t))return!1;return!0},$o=(t,e)=>{for(let n=0;n<t.length;n++)if(e(t[n],n,t))return!0;return!1},Yc=(t,e)=>{const n=new Array(t);for(let r=0;r<t;r++)n[r]=e(r,n);return n},Zr=Array.isArray;class Kc{constructor(){this._observers=Ae()}on(e,n){return ct(this._observers,e,Mt).add(n),n}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return mt((this._observers.get(e)||Ae()).values()).forEach(r=>r(...n))}destroy(){this._observers=Ae()}}class Xc{constructor(){this._observers=Ae()}on(e,n){ct(this._observers,e,Mt).add(n)}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return mt((this._observers.get(e)||Ae()).values()).forEach(r=>r(...n))}destroy(){this._observers=Ae()}}const Ke=Math.floor,_r=Math.abs,Po=(t,e)=>t<e?t:e,Nt=(t,e)=>t>e?t:e,Vo=t=>t!==0?t<0:1/t<0,Vi=1,ji=2,xs=4,_s=8,$n=32,st=64,Ce=128,Qr=31,Vs=63,Ct=127,Zc=2147483647,Nr=Number.MAX_SAFE_INTEGER,qi=Number.MIN_SAFE_INTEGER,Qc=Number.isInteger||(t=>typeof t=="number"&&isFinite(t)&&Ke(t)===t),el=String.fromCharCode,tl=t=>t.toLowerCase(),nl=/^\s*/g,rl=t=>t.replace(nl,""),sl=/([A-Z])/g,Hi=(t,e)=>rl(t.replace(sl,n=>`${e}${tl(n)}`)),il=t=>{const e=unescape(encodeURIComponent(t)),n=e.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=e.codePointAt(s);return r},Pn=typeof TextEncoder<"u"?new TextEncoder:null,ol=t=>Pn.encode(t),al=Pn?ol:il;let Nn=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Nn&&Nn.decode(new Uint8Array).length===1&&(Nn=null);const cl=(t,e)=>Yc(e,()=>t).join("");class or{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const es=()=>new or,ll=t=>{let e=t.cpos;for(let n=0;n<t.bufs.length;n++)e+=t.bufs[n].length;return e},ze=t=>{const e=new Uint8Array(ll(t));let n=0;for(let r=0;r<t.bufs.length;r++){const s=t.bufs[r];e.set(s,n),n+=s.length}return e.set(new Uint8Array(t.cbuf.buffer,0,t.cpos),n),e},ul=(t,e)=>{const n=t.cbuf.length;n-t.cpos<e&&(t.bufs.push(new Uint8Array(t.cbuf.buffer,0,t.cpos)),t.cbuf=new Uint8Array(Nt(n,e)*2),t.cpos=0)},he=(t,e)=>{const n=t.cbuf.length;t.cpos===n&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(n*2),t.cpos=0),t.cbuf[t.cpos++]=e},js=he,$=(t,e)=>{for(;e>Ct;)he(t,Ce|Ct&e),e=Ke(e/128);he(t,Ct&e)},si=(t,e)=>{const n=Vo(e);for(n&&(e=-e),he(t,(e>Vs?Ce:0)|(n?st:0)|Vs&e),e=Ke(e/64);e>0;)he(t,(e>Ct?Ce:0)|Ct&e),e=Ke(e/128)},qs=new Uint8Array(3e4),hl=qs.length/3,fl=(t,e)=>{if(e.length<hl){const n=Pn.encodeInto(e,qs).written||0;$(t,n);for(let r=0;r<n;r++)he(t,qs[r])}else ve(t,al(e))},dl=(t,e)=>{const n=unescape(encodeURIComponent(e)),r=n.length;$(t,r);for(let s=0;s<r;s++)he(t,n.codePointAt(s))},Qt=Pn&&Pn.encodeInto?fl:dl,ts=(t,e)=>{const n=t.cbuf.length,r=t.cpos,s=Po(n-r,e.length),i=e.length-s;t.cbuf.set(e.subarray(0,s),r),t.cpos+=s,i>0&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(Nt(n*2,i)),t.cbuf.set(e.subarray(s)),t.cpos=i)},ve=(t,e)=>{$(t,e.byteLength),ts(t,e)},ii=(t,e)=>{ul(t,e);const n=new DataView(t.cbuf.buffer,t.cpos,e);return t.cpos+=e,n},pl=(t,e)=>ii(t,4).setFloat32(0,e,!1),gl=(t,e)=>ii(t,8).setFloat64(0,e,!1),ml=(t,e)=>ii(t,8).setBigInt64(0,e,!1),Gi=new DataView(new ArrayBuffer(4)),wl=t=>(Gi.setFloat32(0,t),Gi.getFloat32(0)===t),Vn=(t,e)=>{switch(typeof e){case"string":he(t,119),Qt(t,e);break;case"number":Qc(e)&&_r(e)<=Zc?(he(t,125),si(t,e)):wl(e)?(he(t,124),pl(t,e)):(he(t,123),gl(t,e));break;case"bigint":he(t,122),ml(t,e);break;case"object":if(e===null)he(t,126);else if(Zr(e)){he(t,117),$(t,e.length);for(let n=0;n<e.length;n++)Vn(t,e[n])}else if(e instanceof Uint8Array)he(t,116),ve(t,e);else{he(t,118);const n=Object.keys(e);$(t,n.length);for(let r=0;r<n.length;r++){const s=n[r];Qt(t,s),Vn(t,e[s])}}break;case"boolean":he(t,e?120:121);break;default:he(t,127)}};class Ji extends or{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&$(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}const Wi=t=>{t.count>0&&(si(t.encoder,t.count===1?t.s:-t.s),t.count>1&&$(t.encoder,t.count-2))};class vr{constructor(){this.encoder=new or,this.s=0,this.count=0}write(e){this.s===e?this.count++:(Wi(this),this.count=1,this.s=e)}toUint8Array(){return Wi(this),ze(this.encoder)}}const zi=t=>{if(t.count>0){const e=t.diff*2+(t.count===1?0:1);si(t.encoder,e),t.count>1&&$(t.encoder,t.count-2)}};class vs{constructor(){this.encoder=new or,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(zi(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return zi(this),ze(this.encoder)}}class yl{constructor(){this.sarr=[],this.s="",this.lensE=new vr}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new or;return this.sarr.push(this.s),this.s="",Qt(e,this.sarr.join("")),ts(e,this.lensE.toUint8Array()),ze(e)}}const Ve=t=>new Error(t),$e=()=>{throw Ve("Method unimplemented")},Ne=()=>{throw Ve("Unexpected case")},jo=Ve("Unexpected end of array"),qo=Ve("Integer out of Range");class ns{constructor(e){this.arr=e,this.pos=0}}const wn=t=>new ns(t),bl=t=>t.pos!==t.arr.length,El=(t,e)=>{const n=new Uint8Array(t.arr.buffer,t.pos+t.arr.byteOffset,e);return t.pos+=e,n},Ie=t=>El(t,R(t)),an=t=>t.arr[t.pos++],R=t=>{let e=0,n=1;const r=t.arr.length;for(;t.pos<r;){const s=t.arr[t.pos++];if(e=e+(s&Ct)*n,n*=128,s<Ce)return e;if(e>Nr)throw qo}throw jo},oi=t=>{let e=t.arr[t.pos++],n=e&Vs,r=64;const s=(e&st)>0?-1:1;if((e&Ce)===0)return s*n;const i=t.arr.length;for(;t.pos<i;){if(e=t.arr[t.pos++],n=n+(e&Ct)*r,r*=128,e<Ce)return s*n;if(n>Nr)throw qo}throw jo},kl=t=>{let e=R(t);if(e===0)return"";{let n=String.fromCodePoint(an(t));if(--e<100)for(;e--;)n+=String.fromCodePoint(an(t));else for(;e>0;){const r=e<1e4?e:1e4,s=t.arr.subarray(t.pos,t.pos+r);t.pos+=r,n+=String.fromCodePoint.apply(null,s),e-=r}return decodeURIComponent(escape(n))}},Sl=t=>Nn.decode(Ie(t)),en=Nn?Sl:kl,ai=(t,e)=>{const n=new DataView(t.arr.buffer,t.arr.byteOffset+t.pos,e);return t.pos+=e,n},Al=t=>ai(t,4).getFloat32(0,!1),xl=t=>ai(t,8).getFloat64(0,!1),_l=t=>ai(t,8).getBigInt64(0,!1),vl=[t=>{},t=>null,oi,Al,xl,_l,t=>!1,t=>!0,en,t=>{const e=R(t),n={};for(let r=0;r<e;r++){const s=en(t);n[s]=jn(t)}return n},t=>{const e=R(t),n=[];for(let r=0;r<e;r++)n.push(jn(t));return n},Ie],jn=t=>vl[127-an(t)](t);class Yi extends ns{constructor(e,n){super(e),this.reader=n,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),bl(this)?this.count=R(this)+1:this.count=-1),this.count--,this.s}}class Ir extends ns{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=oi(this);const e=Vo(this.s);this.count=1,e&&(this.s=-this.s,this.count=R(this)+2)}return this.count--,this.s}}class Is extends ns{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const e=oi(this),n=e&1;this.diff=Ke(e/2),this.count=1,n&&(this.count=R(this)+2)}return this.s+=this.diff,this.count--,this.s}}class Il{constructor(e){this.decoder=new Ir(e),this.str=en(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),n=this.str.slice(this.spos,e);return this.spos=e,n}}const Cl=crypto.getRandomValues.bind(crypto),Ho=()=>Cl(new Uint32Array(1))[0],Tl="10000000-1000-4000-8000"+-1e11,Ml=()=>Tl.replace(/[018]/g,t=>(t^Ho()&15>>t/4).toString(16)),cn=t=>new Promise(t);Promise.all.bind(Promise);const Ki=t=>t===void 0?null:t;class Dl{constructor(){this.map=new Map}setItem(e,n){this.map.set(e,n)}getItem(e){return this.map.get(e)}}let Go=new Dl,Ol=!0;try{typeof localStorage<"u"&&localStorage&&(Go=localStorage,Ol=!1)}catch{}const Rl=Go,qn=Symbol("Equality"),Jo=(t,e)=>t===e||!!t?.[qn]?.(e)||!1,Ul=t=>typeof t=="object",Ll=Object.assign,Nl=Object.keys,Bl=(t,e)=>{for(const n in t)e(t[n],n)},Br=t=>Nl(t).length,Fl=t=>{for(const e in t)return!1;return!0},ar=(t,e)=>{for(const n in t)if(!e(t[n],n))return!1;return!0},ci=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),$l=(t,e)=>t===e||Br(t)===Br(e)&&ar(t,(n,r)=>(n!==void 0||ci(e,r))&&Jo(e[r],n)),Pl=Object.freeze,Wo=t=>{for(const e in t){const n=t[e];(typeof n=="object"||typeof n=="function")&&Wo(t[e])}return Pl(t)},li=(t,e,n=0)=>{try{for(;n<t.length;n++)t[n](...e)}finally{n<t.length&&li(t,e,n+1)}},Vl=t=>t,Cr=(t,e)=>{if(t===e)return!0;if(t==null||e==null||t.constructor!==e.constructor&&(t.constructor||Object)!==(e.constructor||Object))return!1;if(t[qn]!=null)return t[qn](e);switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),e=new Uint8Array(e);case Uint8Array:{if(t.byteLength!==e.byteLength)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;break}case Set:{if(t.size!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;break}case Map:{if(t.size!==e.size)return!1;for(const n of t.keys())if(!e.has(n)||!Cr(t.get(n),e.get(n)))return!1;break}case void 0:case Object:if(Br(t)!==Br(e))return!1;for(const n in t)if(!ci(t,n)||!Cr(t[n],e[n]))return!1;break;case Array:if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!Cr(t[n],e[n]))return!1;break;default:return!1}return!0},jl=(t,e)=>e.includes(t);var zo={};const Hn=typeof St<"u"&&St.release&&/node|io\.js/.test(St.release.name)&&Object.prototype.toString.call(typeof St<"u"?St:0)==="[object process]";let qe;const ql=()=>{if(qe===void 0)if(Hn){qe=Ae();const t=St.argv;let e=null;for(let n=0;n<t.length;n++){const r=t[n];r[0]==="-"?(e!==null&&qe.set(e,""),e=r):e!==null&&(qe.set(e,r),e=null)}e!==null&&qe.set(e,"")}else typeof location=="object"?(qe=Ae(),(location.search||"?").slice(1).split("&").forEach(t=>{if(t.length!==0){const[e,n]=t.split("=");qe.set(`--${Hi(e,"-")}`,n),qe.set(`-${Hi(e,"-")}`,n)}})):qe=Ae();return qe},Hs=t=>ql().has(t),Fr=t=>Ki(Hn?zo[t.toUpperCase().replaceAll("-","_")]:Rl.getItem(t)),Yo=t=>Hs("--"+t)||Fr(t)!==null,Hl=Yo("production"),Gl=Hn&&jl(zo.FORCE_COLOR,["true","1","2"]),Jl=Gl||!Hs("--no-colors")&&!Yo("no-color")&&(!Hn||St.stdout.isTTY)&&(!Hn||Hs("--color")||Fr("COLORTERM")!==null||(Fr("TERM")||"").includes("color")),Wl=t=>new Uint8Array(t),zl=t=>{const e=Wl(t.byteLength);return e.set(t),e};class Yl{constructor(e,n){this.left=e,this.right=n}}const Qe=(t,e)=>new Yl(t,e),Xi=t=>t.next()>=.5,Cs=(t,e,n)=>Ke(t.next()*(n+1-e)+e),Ko=(t,e,n)=>Ke(t.next()*(n+1-e)+e),ui=(t,e,n)=>Ko(t,e,n),Kl=t=>el(ui(t,97,122)),Xl=(t,e=0,n=20)=>{const r=ui(t,e,n);let s="";for(let i=0;i<r;i++)s+=Kl(t);return s},Ts=(t,e)=>e[ui(t,0,e.length-1)],Zl=Symbol("0schema");class Ql{constructor(){this._rerrs=[]}extend(e,n,r,s=null){this._rerrs.push({path:e,expected:n,has:r,message:s})}toString(){const e=[];for(let n=this._rerrs.length-1;n>0;n--){const r=this._rerrs[n];e.push(cl(" ",(this._rerrs.length-n)*2)+`${r.path!=null?`[${r.path}] `:""}${r.has} doesn't match ${r.expected}. ${r.message}`)}return e.join(`
`)}}const Gs=(t,e)=>t===e?!0:t==null||e==null||t.constructor!==e.constructor?!1:t[qn]?Jo(t,e):Zr(t)?ri(t,n=>$o(e,r=>Gs(n,r))):Ul(t)?ar(t,(n,r)=>Gs(n,e[r])):!1;class ke{static _dilutes=!1;extends(e){let[n,r]=[this.shape,e.shape];return this.constructor._dilutes&&([r,n]=[n,r]),Gs(n,r)}equals(e){return this.constructor===e.constructor&&Cr(this.shape,e.shape)}[Zl](){return!0}[qn](e){return this.equals(e)}validate(e){return this.check(e)}check(e,n){$e()}get nullable(){return yn(this,as)}get optional(){return new Qo(this)}cast(e){return Zi(e,this),e}expect(e){return Zi(e,this),e}}class hi extends ke{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n=void 0){const r=e?.constructor===this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name,e?.constructor!==this.shape?"Constructor match failed":"Check failed"),r}}const re=(t,e=null)=>new hi(t,e);re(hi);class fi extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape(e);return!r&&n?.extend(null,"custom prop",e?.constructor.name,"failed to check custom prop"),r}}const pe=t=>new fi(t);re(fi);class rs extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape.some(s=>s===e);return!r&&n?.extend(null,this.shape.join(" | "),e.toString()),r}}const ss=(...t)=>new rs(t),Xo=re(rs),eu=RegExp.escape||(t=>t.replace(/[().|&,$^[\]]/g,e=>"\\"+e)),Zo=t=>{if(ln.check(t))return[eu(t)];if(Xo.check(t))return t.shape.map(e=>e+"");if(ca.check(t))return["[+-]?\\d+.?\\d*"];if(la.check(t))return[".*"];if($r.check(t))return t.shape.map(Zo).flat(1);Ne()};class tu extends ke{constructor(e){super(),this.shape=e,this._r=new RegExp("^"+e.map(Zo).map(n=>`(${n.join("|")})`).join("")+"$")}check(e,n){const r=this._r.exec(e)!=null;return!r&&n?.extend(null,this._r.toString(),e.toString(),"String doesn't match string template."),r}}re(tu);const nu=Symbol("optional");class Qo extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=e===void 0||this.shape.check(e);return!r&&n?.extend(null,"undefined (optional)","()"),r}get[nu](){return!0}}const ru=re(Qo);class su extends ke{check(e,n){return n?.extend(null,"never",typeof e),!1}}re(su);class is extends ke{constructor(e,n=!1){super(),this.shape=e,this._isPartial=n}static _dilutes=!0;get partial(){return new is(this.shape,!0)}check(e,n){return e==null?(n?.extend(null,"object","null"),!1):ar(this.shape,(r,s)=>{const i=this._isPartial&&!ci(e,s)||r.check(e[s],n);return!i&&n?.extend(s.toString(),r.toString(),typeof e[s],"Object property does not match"),i})}}const iu=t=>new is(t),ou=re(is),au=pe(t=>t!=null&&(t.constructor===Object||t.constructor==null));class ea extends ke{constructor(e,n){super(),this.shape={keys:e,values:n}}check(e,n){return e!=null&&ar(e,(r,s)=>{const i=this.shape.keys.check(s,n);return!i&&n?.extend(s+"","Record",typeof e,i?"Key doesn't match schema":"Value doesn't match value"),i&&this.shape.values.check(r,n)})}}const ta=(t,e)=>new ea(t,e),cu=re(ea);class na extends ke{constructor(e){super(),this.shape=e}check(e,n){return e!=null&&ar(this.shape,(r,s)=>{const i=r.check(e[s],n);return!i&&n?.extend(s.toString(),"Tuple",typeof r),i})}}const lu=(...t)=>new na(t);re(na);class ra extends ke{constructor(e){super(),this.shape=e.length===1?e[0]:new di(e)}check(e,n){const r=Zr(e)&&ri(e,s=>this.shape.check(s));return!r&&n?.extend(null,"Array",""),r}}const sa=(...t)=>new ra(t),uu=re(ra),hu=pe(t=>Zr(t));class ia extends ke{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n){const r=e instanceof this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name),r}}const fu=(t,e=null)=>new ia(t,e);re(ia);const du=fu(ke);class pu extends ke{constructor(e){super(),this.len=e.length-1,this.args=lu(...e.slice(-1)),this.res=e[this.len]}check(e,n){const r=e.constructor===Function&&e.length<=this.len;return!r&&n?.extend(null,"function",typeof e),r}}const gu=re(pu),mu=pe(t=>typeof t=="function");class wu extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=ri(this.shape,s=>s.check(e,n));return!r&&n?.extend(null,"Intersectinon",typeof e),r}}re(wu,t=>t.shape.length>0);class di extends ke{static _dilutes=!0;constructor(e){super(),this.shape=e}check(e,n){const r=$o(this.shape,s=>s.check(e,n));return n?.extend(null,"Union",typeof e),r}}const yn=(...t)=>t.findIndex(e=>$r.check(e))>=0?yn(...t.map(e=>Gn(e)).map(e=>$r.check(e)?e.shape:[e]).flat(1)):t.length===1?t[0]:new di(t),$r=re(di),oa=()=>!0,Pr=pe(oa),yu=re(fi,t=>t.shape===oa),pi=pe(t=>typeof t=="bigint"),bu=pe(t=>t===pi),aa=pe(t=>typeof t=="symbol");pe(t=>t===aa);const tn=pe(t=>typeof t=="number"),ca=pe(t=>t===tn),ln=pe(t=>typeof t=="string"),la=pe(t=>t===ln),os=pe(t=>typeof t=="boolean"),Eu=pe(t=>t===os),ua=ss(void 0);re(rs,t=>t.shape.length===1&&t.shape[0]===void 0);ss(void 0);const as=ss(null),ku=re(rs,t=>t.shape.length===1&&t.shape[0]===null);re(Uint8Array);re(hi,t=>t.shape===Uint8Array);const Su=yn(tn,ln,as,ua,pi,os,aa);(()=>{const t=sa(Pr),e=ta(ln,Pr),n=yn(tn,ln,as,os,t,e);return t.shape=n,e.shape.values=n,n})();const Gn=t=>{if(du.check(t))return t;if(au.check(t)){const e={};for(const n in t)e[n]=Gn(t[n]);return iu(e)}else{if(hu.check(t))return yn(...t.map(Gn));if(Su.check(t))return ss(t);if(mu.check(t))return re(t)}Ne()},Zi=Hl?()=>{}:(t,e)=>{const n=new Ql;if(!e.check(t,n))throw Ve(`Expected value to be of type ${e.constructor.name}.
${n.toString()}`)};class Au{constructor(e){this.patterns=[],this.$state=e}if(e,n){return this.patterns.push({if:Gn(e),h:n}),this}else(e){return this.if(Pr,e)}done(){return(e,n)=>{for(let r=0;r<this.patterns.length;r++){const s=this.patterns[r];if(s.if.check(e))return s.h(e,n)}throw Ve("Unhandled pattern")}}}const xu=t=>new Au(t),ha=xu(Pr).if(ca,(t,e)=>Cs(e,qi,Nr)).if(la,(t,e)=>Xl(e)).if(Eu,(t,e)=>Xi(e)).if(bu,(t,e)=>BigInt(Cs(e,qi,Nr))).if($r,(t,e)=>Gt(e,Ts(e,t.shape))).if(ou,(t,e)=>{const n={};for(const r in t.shape){let s=t.shape[r];if(ru.check(s)){if(Xi(e))continue;s=s.shape}n[r]=ha(s,e)}return n}).if(uu,(t,e)=>{const n=[],r=Ko(e,0,42);for(let s=0;s<r;s++)n.push(Gt(e,t.shape));return n}).if(Xo,(t,e)=>Ts(e,t.shape)).if(ku,(t,e)=>null).if(gu,(t,e)=>{const n=Gt(e,t.res);return()=>n}).if(yu,(t,e)=>Gt(e,Ts(e,[tn,ln,as,ua,pi,os,sa(tn),ta(yn("a","b","c"),tn)]))).if(cu,(t,e)=>{const n={},r=Cs(e,0,3);for(let s=0;s<r;s++){const i=Gt(e,t.shape.keys),c=Gt(e,t.shape.values);n[i]=c}return n}).done(),Gt=(t,e)=>ha(Gn(e),t),cs=typeof document<"u"?document:{};pe(t=>t.nodeType===Tu);typeof DOMParser<"u"&&new DOMParser;pe(t=>t.nodeType===vu);pe(t=>t.nodeType===Iu);const _u=t=>Jc(t,(e,n)=>`${n}:${e};`).join(""),vu=cs.ELEMENT_NODE,Iu=cs.TEXT_NODE,Cu=cs.DOCUMENT_NODE,Tu=cs.DOCUMENT_FRAGMENT_NODE;pe(t=>t.nodeType===Cu);const lt=Symbol,fa=lt(),da=lt(),Mu=lt(),Du=lt(),Ou=lt(),pa=lt(),Ru=lt(),gi=lt(),Uu=lt(),Lu=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[];let r=0;for(;r<t.length;r++){const s=t[r];if(s===void 0)break;if(s.constructor===String||s.constructor===Number)e.push(s);else if(s.constructor===Object)break}for(r>0&&n.push(e.join(""));r<t.length;r++){const s=t[r];s instanceof Symbol||n.push(s)}return n},Nu={[fa]:Qe("font-weight","bold"),[da]:Qe("font-weight","normal"),[Mu]:Qe("color","blue"),[Ou]:Qe("color","green"),[Du]:Qe("color","grey"),[pa]:Qe("color","red"),[Ru]:Qe("color","purple"),[gi]:Qe("color","orange"),[Uu]:Qe("color","black")},Bu=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[],r=Ae();let s=[],i=0;for(;i<t.length;i++){const c=t[i],h=Nu[c];if(h!==void 0)r.set(h.left,h.right);else{if(c===void 0)break;if(c.constructor===String||c.constructor===Number){const f=_u(r);i>0||f.length>0?(e.push("%c"+c),n.push(f)):e.push(c)}else break}}for(i>0&&(s=n,s.unshift(e.join("")));i<t.length;i++){const c=t[i];c instanceof Symbol||s.push(c)}return s},ga=Jl?Bu:Lu,Fu=(...t)=>{console.log(...ga(t)),ma.forEach(e=>e.print(t))},$u=(...t)=>{console.warn(...ga(t)),t.unshift(gi),ma.forEach(e=>e.print(t))},ma=Mt(),wa=t=>({[Symbol.iterator](){return this},next:t}),Pu=(t,e)=>wa(()=>{let n;do n=t.next();while(!n.done&&!e(n.value));return n}),Ms=(t,e)=>wa(()=>{const{done:n,value:r}=t.next();return{done:n,value:n?void 0:e(r)}});class mi{constructor(e,n){this.clock=e,this.len=n}}class cr{constructor(){this.clients=new Map}}const ya=(t,e,n)=>e.clients.forEach((r,s)=>{const i=t.doc.store.clients.get(s);if(i!=null){const c=i[i.length-1],h=c.id.clock+c.length;for(let f=0,g=r[f];f<r.length&&g.clock<h;g=r[++f])Ta(t,i,g.clock,g.len,n)}}),Vu=(t,e)=>{let n=0,r=t.length-1;for(;n<=r;){const s=Ke((n+r)/2),i=t[s],c=i.clock;if(c<=e){if(e<c+i.len)return s;n=s+1}else r=s-1}return null},ba=(t,e)=>{const n=t.clients.get(e.client);return n!==void 0&&Vu(n,e.clock)!==null},wi=t=>{t.clients.forEach(e=>{e.sort((s,i)=>s.clock-i.clock);let n,r;for(n=1,r=1;n<e.length;n++){const s=e[r-1],i=e[n];s.clock+s.len>=i.clock?s.len=Nt(s.len,i.clock+i.len-s.clock):(r<n&&(e[r]=i),r++)}e.length=r})},ju=t=>{const e=new cr;for(let n=0;n<t.length;n++)t[n].clients.forEach((r,s)=>{if(!e.clients.has(s)){const i=r.slice();for(let c=n+1;c<t.length;c++)zc(i,t[c].clients.get(s)||[]);e.clients.set(s,i)}});return wi(e),e},Vr=(t,e,n,r)=>{ct(t.clients,e,()=>[]).push(new mi(n,r))},qu=()=>new cr,Hu=t=>{const e=qu();return t.clients.forEach((n,r)=>{const s=[];for(let i=0;i<n.length;i++){const c=n[i];if(c.deleted){const h=c.id.clock;let f=c.length;if(i+1<n.length)for(let g=n[i+1];i+1<n.length&&g.deleted;g=n[++i+1])f+=g.length;s.push(new mi(h,f))}}s.length>0&&e.clients.set(r,s)}),e},bn=(t,e)=>{$(t.restEncoder,e.clients.size),mt(e.clients.entries()).sort((n,r)=>r[0]-n[0]).forEach(([n,r])=>{t.resetDsCurVal(),$(t.restEncoder,n);const s=r.length;$(t.restEncoder,s);for(let i=0;i<s;i++){const c=r[i];t.writeDsClock(c.clock),t.writeDsLen(c.len)}})},yi=t=>{const e=new cr,n=R(t.restDecoder);for(let r=0;r<n;r++){t.resetDsCurVal();const s=R(t.restDecoder),i=R(t.restDecoder);if(i>0){const c=ct(e.clients,s,()=>[]);for(let h=0;h<i;h++)c.push(new mi(t.readDsClock(),t.readDsLen()))}}return e},Qi=(t,e,n)=>{const r=new cr,s=R(t.restDecoder);for(let i=0;i<s;i++){t.resetDsCurVal();const c=R(t.restDecoder),h=R(t.restDecoder),f=n.clients.get(c)||[],g=fe(n,c);for(let l=0;l<h;l++){const m=t.readDsClock(),d=m+t.readDsLen();if(m<g){g<d&&Vr(r,c,g,d-g);let w=Xe(f,m),k=f[w];for(!k.deleted&&k.id.clock<m&&(f.splice(w+1,0,zr(e,k,m-k.id.clock)),w++);w<f.length&&(k=f[w++],k.id.clock<d);)k.deleted||(d<k.id.clock+k.length&&f.splice(w,0,zr(e,k,d-k.id.clock)),k.delete(e))}else Vr(r,c,m,d-m)}}if(r.clients.size>0){const i=new Dt;return $(i.restEncoder,0),bn(i,r),i.toUint8Array()}return null},Ea=Ho;class En extends Kc{constructor({guid:e=Ml(),collectionid:n=null,gc:r=!0,gcFilter:s=()=>!0,meta:i=null,autoLoad:c=!1,shouldLoad:h=!0}={}){super(),this.gc=r,this.gcFilter=s,this.clientID=Ea(),this.guid=e,this.collectionid=n,this.share=new Map,this.store=new Ia,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=h,this.autoLoad=c,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=cn(g=>{this.on("load",()=>{this.isLoaded=!0,g(this)})});const f=()=>cn(g=>{const l=m=>{(m===void 0||m===!0)&&(this.off("sync",l),g())};this.on("sync",l)});this.on("sync",g=>{g===!1&&this.isSynced&&(this.whenSynced=f()),this.isSynced=g===void 0||g===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=f()}load(){const e=this._item;e!==null&&!this.shouldLoad&&H(e.parent.doc,n=>{n.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(mt(this.subdocs).map(e=>e.guid))}transact(e,n=null){return H(this,e,n)}get(e,n=me){const r=ct(this.share,e,()=>{const i=new n;return i._integrate(this,null),i}),s=r.constructor;if(n!==me&&s!==n)if(s===me){const i=new n;i._map=r._map,r._map.forEach(c=>{for(;c!==null;c=c.left)c.parent=i}),i._start=r._start;for(let c=i._start;c!==null;c=c.right)c.parent=i;return i._length=r._length,this.share.set(e,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${e} has already been defined with a different constructor`);return r}getArray(e=""){return this.get(e,rn)}getText(e=""){return this.get(e,fn)}getMap(e=""){return this.get(e,hn)}getXmlElement(e=""){return this.get(e,dn)}getXmlFragment(e=""){return this.get(e,Ot)}toJSON(){const e={};return this.share.forEach((n,r)=>{e[r]=n.toJSON()}),e}destroy(){this.isDestroyed=!0,mt(this.subdocs).forEach(n=>n.destroy());const e=this._item;if(e!==null){this._item=null;const n=e.content;n.doc=new En({guid:this.guid,...n.opts,shouldLoad:!1}),n.doc._item=e,H(e.parent.doc,r=>{const s=n.doc;e.deleted||r.subdocsAdded.add(s),r.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class ka{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return R(this.restDecoder)}readDsLen(){return R(this.restDecoder)}}class Sa extends ka{readLeftID(){return L(R(this.restDecoder),R(this.restDecoder))}readRightID(){return L(R(this.restDecoder),R(this.restDecoder))}readClient(){return R(this.restDecoder)}readInfo(){return an(this.restDecoder)}readString(){return en(this.restDecoder)}readParentInfo(){return R(this.restDecoder)===1}readTypeRef(){return R(this.restDecoder)}readLen(){return R(this.restDecoder)}readAny(){return jn(this.restDecoder)}readBuf(){return zl(Ie(this.restDecoder))}readJSON(){return JSON.parse(en(this.restDecoder))}readKey(){return en(this.restDecoder)}}class Gu{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=R(this.restDecoder),this.dsCurrVal}readDsLen(){const e=R(this.restDecoder)+1;return this.dsCurrVal+=e,e}}class un extends Gu{constructor(e){super(e),this.keys=[],R(e),this.keyClockDecoder=new Is(Ie(e)),this.clientDecoder=new Ir(Ie(e)),this.leftClockDecoder=new Is(Ie(e)),this.rightClockDecoder=new Is(Ie(e)),this.infoDecoder=new Yi(Ie(e),an),this.stringDecoder=new Il(Ie(e)),this.parentInfoDecoder=new Yi(Ie(e),an),this.typeRefDecoder=new Ir(Ie(e)),this.lenDecoder=new Ir(Ie(e))}readLeftID(){return new nn(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new nn(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return jn(this.restDecoder)}readBuf(){return Ie(this.restDecoder)}readJSON(){return jn(this.restDecoder)}readKey(){const e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{const n=this.stringDecoder.read();return this.keys.push(n),n}}}class Ju{constructor(){this.restEncoder=es()}toUint8Array(){return ze(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){$(this.restEncoder,e)}writeDsLen(e){$(this.restEncoder,e)}}class lr extends Ju{writeLeftID(e){$(this.restEncoder,e.client),$(this.restEncoder,e.clock)}writeRightID(e){$(this.restEncoder,e.client),$(this.restEncoder,e.clock)}writeClient(e){$(this.restEncoder,e)}writeInfo(e){js(this.restEncoder,e)}writeString(e){Qt(this.restEncoder,e)}writeParentInfo(e){$(this.restEncoder,e?1:0)}writeTypeRef(e){$(this.restEncoder,e)}writeLen(e){$(this.restEncoder,e)}writeAny(e){Vn(this.restEncoder,e)}writeBuf(e){ve(this.restEncoder,e)}writeJSON(e){Qt(this.restEncoder,JSON.stringify(e))}writeKey(e){Qt(this.restEncoder,e)}}class Wu{constructor(){this.restEncoder=es(),this.dsCurrVal=0}toUint8Array(){return ze(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){const n=e-this.dsCurrVal;this.dsCurrVal=e,$(this.restEncoder,n)}writeDsLen(e){e===0&&Ne(),$(this.restEncoder,e-1),this.dsCurrVal+=e}}class Dt extends Wu{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new vs,this.clientEncoder=new vr,this.leftClockEncoder=new vs,this.rightClockEncoder=new vs,this.infoEncoder=new Ji(js),this.stringEncoder=new yl,this.parentInfoEncoder=new Ji(js),this.typeRefEncoder=new vr,this.lenEncoder=new vr}toUint8Array(){const e=es();return $(e,0),ve(e,this.keyClockEncoder.toUint8Array()),ve(e,this.clientEncoder.toUint8Array()),ve(e,this.leftClockEncoder.toUint8Array()),ve(e,this.rightClockEncoder.toUint8Array()),ve(e,ze(this.infoEncoder)),ve(e,this.stringEncoder.toUint8Array()),ve(e,ze(this.parentInfoEncoder)),ve(e,this.typeRefEncoder.toUint8Array()),ve(e,this.lenEncoder.toUint8Array()),ts(e,ze(this.restEncoder)),ze(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){Vn(this.restEncoder,e)}writeBuf(e){ve(this.restEncoder,e)}writeJSON(e){Vn(this.restEncoder,e)}writeKey(e){const n=this.keyMap.get(e);n===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(n)}}const zu=(t,e,n,r)=>{r=Nt(r,e[0].id.clock);const s=Xe(e,r);$(t.restEncoder,e.length-s),t.writeClient(n),$(t.restEncoder,r);const i=e[s];i.write(t,r-i.id.clock);for(let c=s+1;c<e.length;c++)e[c].write(t,0)},bi=(t,e,n)=>{const r=new Map;n.forEach((s,i)=>{fe(e,i)>s&&r.set(i,s)}),Ei(e).forEach((s,i)=>{n.has(i)||r.set(i,0)}),$(t.restEncoder,r.size),mt(r.entries()).sort((s,i)=>i[0]-s[0]).forEach(([s,i])=>{zu(t,e.clients.get(s),s,i)})},Yu=(t,e)=>{const n=Ae(),r=R(t.restDecoder);for(let s=0;s<r;s++){const i=R(t.restDecoder),c=new Array(i),h=t.readClient();let f=R(t.restDecoder);n.set(h,{i:0,refs:c});for(let g=0;g<i;g++){const l=t.readInfo();switch(Qr&l){case 0:{const m=t.readLen();c[g]=new Ue(L(h,f),m),f+=m;break}case 10:{const m=R(t.restDecoder);c[g]=new Le(L(h,f),m),f+=m;break}default:{const m=(l&(st|Ce))===0,d=new oe(L(h,f),null,(l&Ce)===Ce?t.readLeftID():null,null,(l&st)===st?t.readRightID():null,m?t.readParentInfo()?e.get(t.readString()):t.readLeftID():null,m&&(l&$n)===$n?t.readString():null,za(t,l));c[g]=d,f+=d.length}}}}return n},Ku=(t,e,n)=>{const r=[];let s=mt(n.keys()).sort((w,k)=>w-k);if(s.length===0)return null;const i=()=>{if(s.length===0)return null;let w=n.get(s[s.length-1]);for(;w.refs.length===w.i;)if(s.pop(),s.length>0)w=n.get(s[s.length-1]);else return null;return w};let c=i();if(c===null)return null;const h=new Ia,f=new Map,g=(w,k)=>{const A=f.get(w);(A==null||A>k)&&f.set(w,k)};let l=c.refs[c.i++];const m=new Map,d=()=>{for(const w of r){const k=w.id.client,A=n.get(k);A?(A.i--,h.clients.set(k,A.refs.slice(A.i)),n.delete(k),A.i=0,A.refs=[]):h.clients.set(k,[w]),s=s.filter(D=>D!==k)}r.length=0};for(;;){if(l.constructor!==Le){const k=ct(m,l.id.client,()=>fe(e,l.id.client))-l.id.clock;if(k<0)r.push(l),g(l.id.client,l.id.clock-1),d();else{const A=l.getMissing(t,e);if(A!==null){r.push(l);const D=n.get(A)||{refs:[],i:0};if(D.refs.length===D.i)g(A,fe(e,A)),d();else{l=D.refs[D.i++];continue}}else(k===0||k<l.length)&&(l.integrate(t,k),m.set(l.id.client,l.id.clock+l.length))}}if(r.length>0)l=r.pop();else if(c!==null&&c.i<c.refs.length)l=c.refs[c.i++];else{if(c=i(),c===null)break;l=c.refs[c.i++]}}if(h.clients.size>0){const w=new Dt;return bi(w,h,new Map),$(w.restEncoder,0),{missing:f,update:w.toUint8Array()}}return null},Xu=(t,e)=>bi(t,e.doc.store,e.beforeState),Zu=(t,e,n,r=new un(t))=>H(e,s=>{s.local=!1;let i=!1;const c=s.doc,h=c.store,f=Yu(r,c),g=Ku(s,h,f),l=h.pendingStructs;if(l){for(const[d,w]of l.missing)if(w<fe(h,d)){i=!0;break}if(g){for(const[d,w]of g.missing){const k=l.missing.get(d);(k==null||k>w)&&l.missing.set(d,w)}l.update=jr([l.update,g.update])}}else h.pendingStructs=g;const m=Qi(r,s,h);if(h.pendingDs){const d=new un(wn(h.pendingDs));R(d.restDecoder);const w=Qi(d,s,h);m&&w?h.pendingDs=jr([m,w]):h.pendingDs=m||w}else h.pendingDs=m;if(i){const d=h.pendingStructs.update;h.pendingStructs=null,Aa(s.doc,d)}},n,!1),Aa=(t,e,n,r=un)=>{const s=wn(e);Zu(s,t,n,new r(s))},Qu=(t,e,n)=>Aa(t,e,n,Sa),eh=(t,e,n=new Map)=>{bi(t,e.store,n),bn(t,Hu(e.store))},th=(t,e=new Uint8Array([0]),n=new Dt)=>{const r=_a(e);eh(n,t,r);const s=[n.toUint8Array()];if(t.store.pendingDs&&s.push(t.store.pendingDs),t.store.pendingStructs&&s.push(dh(t.store.pendingStructs.update,e)),s.length>1){if(n.constructor===lr)return hh(s.map((i,c)=>c===0?i:gh(i)));if(n.constructor===Dt)return jr(s)}return s[0]},xa=(t,e)=>th(t,e,new lr),nh=t=>{const e=new Map,n=R(t.restDecoder);for(let r=0;r<n;r++){const s=R(t.restDecoder),i=R(t.restDecoder);e.set(s,i)}return e},_a=t=>nh(new ka(wn(t)));class rh{constructor(){this.l=[]}}const eo=()=>new rh,to=(t,e)=>t.l.push(e),no=(t,e)=>{const n=t.l,r=n.length;t.l=n.filter(s=>e!==s),r===t.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},va=(t,e,n)=>li(t.l,[e,n]);class nn{constructor(e,n){this.client=e,this.clock=n}}const mr=(t,e)=>t===e||t!==null&&e!==null&&t.client===e.client&&t.clock===e.clock,L=(t,e)=>new nn(t,e),sh=t=>{for(const[e,n]of t.doc.share.entries())if(n===t)return e;throw Ne()},Wt=(t,e)=>e===void 0?!t.deleted:e.sv.has(t.id.client)&&(e.sv.get(t.id.client)||0)>t.id.clock&&!ba(e.ds,t.id),Js=(t,e)=>{const n=ct(t.meta,Js,Mt),r=t.doc.store;n.has(e)||(e.sv.forEach((s,i)=>{s<fe(r,i)&&wt(t,L(i,s))}),ya(t,e.ds,s=>{}),n.add(e))};class Ia{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const Ei=t=>{const e=new Map;return t.clients.forEach((n,r)=>{const s=n[n.length-1];e.set(r,s.id.clock+s.length)}),e},fe=(t,e)=>{const n=t.clients.get(e);if(n===void 0)return 0;const r=n[n.length-1];return r.id.clock+r.length},Ca=(t,e)=>{let n=t.clients.get(e.id.client);if(n===void 0)n=[],t.clients.set(e.id.client,n);else{const r=n[n.length-1];if(r.id.clock+r.length!==e.id.clock)throw Ne()}n.push(e)},Xe=(t,e)=>{let n=0,r=t.length-1,s=t[r],i=s.id.clock;if(i===e)return r;let c=Ke(e/(i+s.length-1)*r);for(;n<=r;){if(s=t[c],i=s.id.clock,i<=e){if(e<i+s.length)return c;n=c+1}else r=c-1;c=Ke((n+r)/2)}throw Ne()},ih=(t,e)=>{const n=t.clients.get(e.client);return n[Xe(n,e.clock)]},Ds=ih,Ws=(t,e,n)=>{const r=Xe(e,n),s=e[r];return s.id.clock<n&&s instanceof oe?(e.splice(r+1,0,zr(t,s,n-s.id.clock)),r+1):r},wt=(t,e)=>{const n=t.doc.store.clients.get(e.client);return n[Ws(t,n,e.clock)]},ro=(t,e,n)=>{const r=e.clients.get(n.client),s=Xe(r,n.clock),i=r[s];return n.clock!==i.id.clock+i.length-1&&i.constructor!==Ue&&r.splice(s+1,0,zr(t,i,n.clock-i.id.clock+1)),i},oh=(t,e,n)=>{const r=t.clients.get(e.id.client);r[Xe(r,e.id.clock)]=n},Ta=(t,e,n,r,s)=>{if(r===0)return;const i=n+r;let c=Ws(t,e,n),h;do h=e[c++],i<h.id.clock+h.length&&Ws(t,e,i),s(h);while(c<e.length&&e[c].id.clock<i)};class ah{constructor(e,n,r){this.doc=e,this.deleteSet=new cr,this.beforeState=Ei(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const so=(t,e)=>e.deleteSet.clients.size===0&&!Wc(e.afterState,(n,r)=>e.beforeState.get(r)!==n)?!1:(wi(e.deleteSet),Xu(t,e),bn(t,e.deleteSet),!0),io=(t,e,n)=>{const r=e._item;(r===null||r.id.clock<(t.beforeState.get(r.id.client)||0)&&!r.deleted)&&ct(t.changed,e,Mt).add(n)},Tr=(t,e)=>{let n=t[e],r=t[e-1],s=e;for(;s>0;n=r,r=t[--s-1]){if(r.deleted===n.deleted&&r.constructor===n.constructor&&r.mergeWith(n)){n instanceof oe&&n.parentSub!==null&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,r);continue}break}const i=e-s;return i&&t.splice(e+1-i,i),i},ch=(t,e,n)=>{for(const[r,s]of t.clients.entries()){const i=e.clients.get(r);for(let c=s.length-1;c>=0;c--){const h=s[c],f=h.clock+h.len;for(let g=Xe(i,h.clock),l=i[g];g<i.length&&l.id.clock<f;l=i[++g]){const m=i[g];if(h.clock+h.len<=m.id.clock)break;m instanceof oe&&m.deleted&&!m.keep&&n(m)&&m.gc(e,!1)}}}},lh=(t,e)=>{t.clients.forEach((n,r)=>{const s=e.clients.get(r);for(let i=n.length-1;i>=0;i--){const c=n[i],h=Po(s.length-1,1+Xe(s,c.clock+c.len-1));for(let f=h,g=s[f];f>0&&g.id.clock>=c.clock;g=s[f])f-=1+Tr(s,f)}})},Ma=(t,e)=>{if(e<t.length){const n=t[e],r=n.doc,s=r.store,i=n.deleteSet,c=n._mergeStructs;try{wi(i),n.afterState=Ei(n.doc.store),r.emit("beforeObserverCalls",[n,r]);const h=[];n.changed.forEach((f,g)=>h.push(()=>{(g._item===null||!g._item.deleted)&&g._callObserver(n,f)})),h.push(()=>{n.changedParentTypes.forEach((f,g)=>{g._dEH.l.length>0&&(g._item===null||!g._item.deleted)&&(f=f.filter(l=>l.target._item===null||!l.target._item.deleted),f.forEach(l=>{l.currentTarget=g,l._path=null}),f.sort((l,m)=>l.path.length-m.path.length),va(g._dEH,f,n))})}),h.push(()=>r.emit("afterTransaction",[n,r])),li(h,[]),n._needFormattingCleanup&&Th(n)}finally{r.gc&&ch(i,s,r.gcFilter),lh(i,s),n.afterState.forEach((l,m)=>{const d=n.beforeState.get(m)||0;if(d!==l){const w=s.clients.get(m),k=Nt(Xe(w,d),1);for(let A=w.length-1;A>=k;)A-=1+Tr(w,A)}});for(let l=c.length-1;l>=0;l--){const{client:m,clock:d}=c[l].id,w=s.clients.get(m),k=Xe(w,d);k+1<w.length&&Tr(w,k+1)>1||k>0&&Tr(w,k)}if(!n.local&&n.afterState.get(r.clientID)!==n.beforeState.get(r.clientID)&&(Fu(gi,fa,"[yjs] ",da,pa,"Changed the client-id because another client seems to be using it."),r.clientID=Ea()),r.emit("afterTransactionCleanup",[n,r]),r._observers.has("update")){const l=new lr;so(l,n)&&r.emit("update",[l.toUint8Array(),n.origin,r,n])}if(r._observers.has("updateV2")){const l=new Dt;so(l,n)&&r.emit("updateV2",[l.toUint8Array(),n.origin,r,n])}const{subdocsAdded:h,subdocsLoaded:f,subdocsRemoved:g}=n;(h.size>0||g.size>0||f.size>0)&&(h.forEach(l=>{l.clientID=r.clientID,l.collectionid==null&&(l.collectionid=r.collectionid),r.subdocs.add(l)}),g.forEach(l=>r.subdocs.delete(l)),r.emit("subdocs",[{loaded:f,added:h,removed:g},r,n]),g.forEach(l=>l.destroy())),t.length<=e+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,t])):Ma(t,e+1)}}},H=(t,e,n=null,r=!0)=>{const s=t._transactionCleanups;let i=!1,c=null;t._transaction===null&&(i=!0,t._transaction=new ah(t,n,r),s.push(t._transaction),s.length===1&&t.emit("beforeAllTransactions",[t]),t.emit("beforeTransaction",[t._transaction,t]));try{c=e(t._transaction)}finally{if(i){const h=t._transaction===s[0];t._transaction=null,h&&Ma(s,0)}}return c};function*uh(t){const e=R(t.restDecoder);for(let n=0;n<e;n++){const r=R(t.restDecoder),s=t.readClient();let i=R(t.restDecoder);for(let c=0;c<r;c++){const h=t.readInfo();if(h===10){const f=R(t.restDecoder);yield new Le(L(s,i),f),i+=f}else if((Qr&h)!==0){const f=(h&(st|Ce))===0,g=new oe(L(s,i),null,(h&Ce)===Ce?t.readLeftID():null,null,(h&st)===st?t.readRightID():null,f?t.readParentInfo()?t.readString():t.readLeftID():null,f&&(h&$n)===$n?t.readString():null,za(t,h));yield g,i+=g.length}else{const f=t.readLen();yield new Ue(L(s,i),f),i+=f}}}}class ki{constructor(e,n){this.gen=uh(e),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===Le);return this.curr}}class Si{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}}const hh=t=>jr(t,Sa,lr),fh=(t,e)=>{if(t.constructor===Ue){const{client:n,clock:r}=t.id;return new Ue(L(n,r+e),t.length-e)}else if(t.constructor===Le){const{client:n,clock:r}=t.id;return new Le(L(n,r+e),t.length-e)}else{const n=t,{client:r,clock:s}=n.id;return new oe(L(r,s+e),null,L(r,s+e-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(e))}},jr=(t,e=un,n=Dt)=>{if(t.length===1)return t[0];const r=t.map(l=>new e(wn(l)));let s=r.map(l=>new ki(l,!0)),i=null;const c=new n,h=new Si(c);for(;s=s.filter(d=>d.curr!==null),s.sort((d,w)=>{if(d.curr.id.client===w.curr.id.client){const k=d.curr.id.clock-w.curr.id.clock;return k===0?d.curr.constructor===w.curr.constructor?0:d.curr.constructor===Le?1:-1:k}else return w.curr.id.client-d.curr.id.client}),s.length!==0;){const l=s[0],m=l.curr.id.client;if(i!==null){let d=l.curr,w=!1;for(;d!==null&&d.id.clock+d.length<=i.struct.id.clock+i.struct.length&&d.id.client>=i.struct.id.client;)d=l.next(),w=!0;if(d===null||d.id.client!==m||w&&d.id.clock>i.struct.id.clock+i.struct.length)continue;if(m!==i.struct.id.client)dt(h,i.struct,i.offset),i={struct:d,offset:0},l.next();else if(i.struct.id.clock+i.struct.length<d.id.clock)if(i.struct.constructor===Le)i.struct.length=d.id.clock+d.length-i.struct.id.clock;else{dt(h,i.struct,i.offset);const k=d.id.clock-i.struct.id.clock-i.struct.length;i={struct:new Le(L(m,i.struct.id.clock+i.struct.length),k),offset:0}}else{const k=i.struct.id.clock+i.struct.length-d.id.clock;k>0&&(i.struct.constructor===Le?i.struct.length-=k:d=fh(d,k)),i.struct.mergeWith(d)||(dt(h,i.struct,i.offset),i={struct:d,offset:0},l.next())}}else i={struct:l.curr,offset:0},l.next();for(let d=l.curr;d!==null&&d.id.client===m&&d.id.clock===i.struct.id.clock+i.struct.length&&d.constructor!==Le;d=l.next())dt(h,i.struct,i.offset),i={struct:d,offset:0}}i!==null&&(dt(h,i.struct,i.offset),i=null),Ai(h);const f=r.map(l=>yi(l)),g=ju(f);return bn(c,g),c.toUint8Array()},dh=(t,e,n=un,r=Dt)=>{const s=_a(e),i=new r,c=new Si(i),h=new n(wn(t)),f=new ki(h,!1);for(;f.curr;){const l=f.curr,m=l.id.client,d=s.get(m)||0;if(f.curr.constructor===Le){f.next();continue}if(l.id.clock+l.length>d)for(dt(c,l,Nt(d-l.id.clock,0)),f.next();f.curr&&f.curr.id.client===m;)dt(c,f.curr,0),f.next();else for(;f.curr&&f.curr.id.client===m&&f.curr.id.clock+f.curr.length<=d;)f.next()}Ai(c);const g=yi(h);return bn(i,g),i.toUint8Array()},Da=t=>{t.written>0&&(t.clientStructs.push({written:t.written,restEncoder:ze(t.encoder.restEncoder)}),t.encoder.restEncoder=es(),t.written=0)},dt=(t,e,n)=>{t.written>0&&t.currClient!==e.id.client&&Da(t),t.written===0&&(t.currClient=e.id.client,t.encoder.writeClient(e.id.client),$(t.encoder.restEncoder,e.id.clock+n)),e.write(t.encoder,n),t.written++},Ai=t=>{Da(t);const e=t.encoder.restEncoder;$(e,t.clientStructs.length);for(let n=0;n<t.clientStructs.length;n++){const r=t.clientStructs[n];$(e,r.written),ts(e,r.restEncoder)}},ph=(t,e,n,r)=>{const s=new n(wn(t)),i=new ki(s,!1),c=new r,h=new Si(c);for(let g=i.curr;g!==null;g=i.next())dt(h,e(g),0);Ai(h);const f=yi(s);return bn(c,f),c.toUint8Array()},gh=t=>ph(t,Vl,un,lr),oo="You must not compute changes after the event-handler fired.";class ls{constructor(e,n){this.target=e,this.currentTarget=e,this.transaction=n,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=mh(this.currentTarget,this.target))}deletes(e){return ba(this.transaction.deleteSet,e.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw Ve(oo);const e=new Map,n=this.target;this.transaction.changed.get(n).forEach(s=>{if(s!==null){const i=n._map.get(s);let c,h;if(this.adds(i)){let f=i.left;for(;f!==null&&this.adds(f);)f=f.left;if(this.deletes(i))if(f!==null&&this.deletes(f))c="delete",h=As(f.content.getContent());else return;else f!==null&&this.deletes(f)?(c="update",h=As(f.content.getContent())):(c="add",h=void 0)}else if(this.deletes(i))c="delete",h=As(i.content.getContent());else return;e.set(s,{action:c,oldValue:h})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(e===null){if(this.transaction.doc._transactionCleanups.length===0)throw Ve(oo);const n=this.target,r=Mt(),s=Mt(),i=[];if(e={added:r,deleted:s,delta:i,keys:this.keys},this.transaction.changed.get(n).has(null)){let h=null;const f=()=>{h&&i.push(h)};for(let g=n._start;g!==null;g=g.right)g.deleted?this.deletes(g)&&!this.adds(g)&&((h===null||h.delete===void 0)&&(f(),h={delete:0}),h.delete+=g.length,s.add(g)):this.adds(g)?((h===null||h.insert===void 0)&&(f(),h={insert:[]}),h.insert=h.insert.concat(g.content.getContent()),r.add(g)):((h===null||h.retain===void 0)&&(f(),h={retain:0}),h.retain+=g.length);h!==null&&h.retain===void 0&&f()}this._changes=e}return e}}const mh=(t,e)=>{const n=[];for(;e._item!==null&&e!==t;){if(e._item.parentSub!==null)n.unshift(e._item.parentSub);else{let r=0,s=e._item.parent._start;for(;s!==e._item&&s!==null;)!s.deleted&&s.countable&&(r+=s.length),s=s.right;n.unshift(r)}e=e._item.parent}return n},Ee=()=>{$u("Invalid access: Add Yjs type to a document before reading data.")},Oa=80;let xi=0;class wh{constructor(e,n){e.marker=!0,this.p=e,this.index=n,this.timestamp=xi++}}const yh=t=>{t.timestamp=xi++},Ra=(t,e,n)=>{t.p.marker=!1,t.p=e,e.marker=!0,t.index=n,t.timestamp=xi++},bh=(t,e,n)=>{if(t.length>=Oa){const r=t.reduce((s,i)=>s.timestamp<i.timestamp?s:i);return Ra(r,e,n),r}else{const r=new wh(e,n);return t.push(r),r}},us=(t,e)=>{if(t._start===null||e===0||t._searchMarker===null)return null;const n=t._searchMarker.length===0?null:t._searchMarker.reduce((i,c)=>_r(e-i.index)<_r(e-c.index)?i:c);let r=t._start,s=0;for(n!==null&&(r=n.p,s=n.index,yh(n));r.right!==null&&s<e;){if(!r.deleted&&r.countable){if(e<s+r.length)break;s+=r.length}r=r.right}for(;r.left!==null&&s>e;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;r.left!==null&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return n!==null&&_r(n.index-s)<r.parent.length/Oa?(Ra(n,r,s),n):bh(t._searchMarker,r,s)},Jn=(t,e,n)=>{for(let r=t.length-1;r>=0;r--){const s=t[r];if(n>0){let i=s.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(s.index-=i.length);if(i===null||i.marker===!0){t.splice(r,1);continue}s.p=i,i.marker=!0}(e<s.index||n>0&&e===s.index)&&(s.index=Nt(e,s.index+n))}},hs=(t,e,n)=>{const r=t,s=e.changedParentTypes;for(;ct(s,t,()=>[]).push(n),t._item!==null;)t=t._item.parent;va(r._eH,n,e)};class me{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=eo(),this._dEH=eo(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,n){this.doc=e,this._item=n}_copy(){throw $e()}clone(){throw $e()}_write(e){}get _first(){let e=this._start;for(;e!==null&&e.deleted;)e=e.right;return e}_callObserver(e,n){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){to(this._eH,e)}observeDeep(e){to(this._dEH,e)}unobserve(e){no(this._eH,e)}unobserveDeep(e){no(this._dEH,e)}toJSON(){}}const Ua=(t,e,n)=>{t.doc??Ee(),e<0&&(e=t._length+e),n<0&&(n=t._length+n);let r=n-e;const s=[];let i=t._start;for(;i!==null&&r>0;){if(i.countable&&!i.deleted){const c=i.content.getContent();if(c.length<=e)e-=c.length;else{for(let h=e;h<c.length&&r>0;h++)s.push(c[h]),r--;e=0}}i=i.right}return s},La=t=>{t.doc??Ee();const e=[];let n=t._start;for(;n!==null;){if(n.countable&&!n.deleted){const r=n.content.getContent();for(let s=0;s<r.length;s++)e.push(r[s])}n=n.right}return e},Wn=(t,e)=>{let n=0,r=t._start;for(t.doc??Ee();r!==null;){if(r.countable&&!r.deleted){const s=r.content.getContent();for(let i=0;i<s.length;i++)e(s[i],n++,t)}r=r.right}},Na=(t,e)=>{const n=[];return Wn(t,(r,s)=>{n.push(e(r,s,t))}),n},Eh=t=>{let e=t._start,n=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(n===null){for(;e!==null&&e.deleted;)e=e.right;if(e===null)return{done:!0,value:void 0};n=e.content.getContent(),r=0,e=e.right}const s=n[r++];return n.length<=r&&(n=null),{done:!1,value:s}}}},Ba=(t,e)=>{t.doc??Ee();const n=us(t,e);let r=t._start;for(n!==null&&(r=n.p,e-=n.index);r!==null;r=r.right)if(!r.deleted&&r.countable){if(e<r.length)return r.content.getContent()[e];e-=r.length}},qr=(t,e,n,r)=>{let s=n;const i=t.doc,c=i.clientID,h=i.store,f=n===null?e._start:n.right;let g=[];const l=()=>{g.length>0&&(s=new oe(L(c,fe(h,c)),s,s&&s.lastId,f,f&&f.id,e,null,new Rt(g)),s.integrate(t,0),g=[])};r.forEach(m=>{if(m===null)g.push(m);else switch(m.constructor){case Number:case Object:case Boolean:case Array:case String:g.push(m);break;default:switch(l(),m.constructor){case Uint8Array:case ArrayBuffer:s=new oe(L(c,fe(h,c)),s,s&&s.lastId,f,f&&f.id,e,null,new ur(new Uint8Array(m))),s.integrate(t,0);break;case En:s=new oe(L(c,fe(h,c)),s,s&&s.lastId,f,f&&f.id,e,null,new hr(m)),s.integrate(t,0);break;default:if(m instanceof me)s=new oe(L(c,fe(h,c)),s,s&&s.lastId,f,f&&f.id,e,null,new ut(m)),s.integrate(t,0);else throw new Error("Unexpected content type in insert operation")}}}),l()},Fa=()=>Ve("Length exceeded!"),$a=(t,e,n,r)=>{if(n>e._length)throw Fa();if(n===0)return e._searchMarker&&Jn(e._searchMarker,n,r.length),qr(t,e,null,r);const s=n,i=us(e,n);let c=e._start;for(i!==null&&(c=i.p,n-=i.index,n===0&&(c=c.prev,n+=c&&c.countable&&!c.deleted?c.length:0));c!==null;c=c.right)if(!c.deleted&&c.countable){if(n<=c.length){n<c.length&&wt(t,L(c.id.client,c.id.clock+n));break}n-=c.length}return e._searchMarker&&Jn(e._searchMarker,s,r.length),qr(t,e,c,r)},kh=(t,e,n)=>{let s=(e._searchMarker||[]).reduce((i,c)=>c.index>i.index?c:i,{index:0,p:e._start}).p;if(s)for(;s.right;)s=s.right;return qr(t,e,s,n)},Pa=(t,e,n,r)=>{if(r===0)return;const s=n,i=r,c=us(e,n);let h=e._start;for(c!==null&&(h=c.p,n-=c.index);h!==null&&n>0;h=h.right)!h.deleted&&h.countable&&(n<h.length&&wt(t,L(h.id.client,h.id.clock+n)),n-=h.length);for(;r>0&&h!==null;)h.deleted||(r<h.length&&wt(t,L(h.id.client,h.id.clock+r)),h.delete(t),r-=h.length),h=h.right;if(r>0)throw Fa();e._searchMarker&&Jn(e._searchMarker,s,-i+r)},Hr=(t,e,n)=>{const r=e._map.get(n);r!==void 0&&r.delete(t)},_i=(t,e,n,r)=>{const s=e._map.get(n)||null,i=t.doc,c=i.clientID;let h;if(r==null)h=new Rt([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:h=new Rt([r]);break;case Uint8Array:h=new ur(r);break;case En:h=new hr(r);break;default:if(r instanceof me)h=new ut(r);else throw new Error("Unexpected content type")}new oe(L(c,fe(i.store,c)),s,s&&s.lastId,null,null,e,n,h).integrate(t,0)},vi=(t,e)=>{t.doc??Ee();const n=t._map.get(e);return n!==void 0&&!n.deleted?n.content.getContent()[n.length-1]:void 0},Va=t=>{const e={};return t.doc??Ee(),t._map.forEach((n,r)=>{n.deleted||(e[r]=n.content.getContent()[n.length-1])}),e},ja=(t,e)=>{t.doc??Ee();const n=t._map.get(e);return n!==void 0&&!n.deleted},Sh=(t,e)=>{const n={};return t._map.forEach((r,s)=>{let i=r;for(;i!==null&&(!e.sv.has(i.id.client)||i.id.clock>=(e.sv.get(i.id.client)||0));)i=i.left;i!==null&&Wt(i,e)&&(n[s]=i.content.getContent()[i.length-1])}),n},wr=t=>(t.doc??Ee(),Pu(t._map.entries(),e=>!e[1].deleted));class Ah extends ls{}class rn extends me{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){const n=new rn;return n.push(e),n}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new rn}clone(){const e=new rn;return e.insert(0,this.toArray().map(n=>n instanceof me?n.clone():n)),e}get length(){return this.doc??Ee(),this._length}_callObserver(e,n){super._callObserver(e,n),hs(this,e,new Ah(this,e))}insert(e,n){this.doc!==null?H(this.doc,r=>{$a(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}push(e){this.doc!==null?H(this.doc,n=>{kh(n,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,n=1){this.doc!==null?H(this.doc,r=>{Pa(r,this,e,n)}):this._prelimContent.splice(e,n)}get(e){return Ba(this,e)}toArray(){return La(this)}slice(e=0,n=this.length){return Ua(this,e,n)}toJSON(){return this.map(e=>e instanceof me?e.toJSON():e)}map(e){return Na(this,e)}forEach(e){Wn(this,e)}[Symbol.iterator](){return Eh(this)}_write(e){e.writeTypeRef(zh)}}const xh=t=>new rn;class _h extends ls{constructor(e,n,r){super(e,n),this.keysChanged=r}}class hn extends me{constructor(e){super(),this._prelimContent=null,e===void 0?this._prelimContent=new Map:this._prelimContent=new Map(e)}_integrate(e,n){super._integrate(e,n),this._prelimContent.forEach((r,s)=>{this.set(s,r)}),this._prelimContent=null}_copy(){return new hn}clone(){const e=new hn;return this.forEach((n,r)=>{e.set(r,n instanceof me?n.clone():n)}),e}_callObserver(e,n){hs(this,e,new _h(this,e,n))}toJSON(){this.doc??Ee();const e={};return this._map.forEach((n,r)=>{if(!n.deleted){const s=n.content.getContent()[n.length-1];e[r]=s instanceof me?s.toJSON():s}}),e}get size(){return[...wr(this)].length}keys(){return Ms(wr(this),e=>e[0])}values(){return Ms(wr(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return Ms(wr(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??Ee(),this._map.forEach((n,r)=>{n.deleted||e(n.content.getContent()[n.length-1],r,this)})}[Symbol.iterator](){return this.entries()}delete(e){this.doc!==null?H(this.doc,n=>{Hr(n,this,e)}):this._prelimContent.delete(e)}set(e,n){return this.doc!==null?H(this.doc,r=>{_i(r,this,e,n)}):this._prelimContent.set(e,n),n}get(e){return vi(this,e)}has(e){return ja(this,e)}clear(){this.doc!==null?H(this.doc,e=>{this.forEach(function(n,r,s){Hr(e,s,r)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(Yh)}}const vh=t=>new hn,gt=(t,e)=>t===e||typeof t=="object"&&typeof e=="object"&&t&&e&&$l(t,e);class zs{constructor(e,n,r,s){this.left=e,this.right=n,this.index=r,this.currentAttributes=s}forward(){switch(this.right===null&&Ne(),this.right.content.constructor){case ae:this.right.deleted||kn(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const ao=(t,e,n)=>{for(;e.right!==null&&n>0;){switch(e.right.content.constructor){case ae:e.right.deleted||kn(e.currentAttributes,e.right.content);break;default:e.right.deleted||(n<e.right.length&&wt(t,L(e.right.id.client,e.right.id.clock+n)),e.index+=e.right.length,n-=e.right.length);break}e.left=e.right,e.right=e.right.right}return e},yr=(t,e,n,r)=>{const s=new Map,i=r?us(e,n):null;if(i){const c=new zs(i.p.left,i.p,i.index,s);return ao(t,c,n-i.index)}else{const c=new zs(null,e._start,0,s);return ao(t,c,n)}},qa=(t,e,n,r)=>{for(;n.right!==null&&(n.right.deleted===!0||n.right.content.constructor===ae&&gt(r.get(n.right.content.key),n.right.content.value));)n.right.deleted||r.delete(n.right.content.key),n.forward();const s=t.doc,i=s.clientID;r.forEach((c,h)=>{const f=n.left,g=n.right,l=new oe(L(i,fe(s.store,i)),f,f&&f.lastId,g,g&&g.id,e,null,new ae(h,c));l.integrate(t,0),n.right=l,n.forward()})},kn=(t,e)=>{const{key:n,value:r}=e;r===null?t.delete(n):t.set(n,r)},Ha=(t,e)=>{for(;t.right!==null;){if(!(t.right.deleted||t.right.content.constructor===ae&&gt(e[t.right.content.key]??null,t.right.content.value)))break;t.forward()}},Ga=(t,e,n,r)=>{const s=t.doc,i=s.clientID,c=new Map;for(const h in r){const f=r[h],g=n.currentAttributes.get(h)??null;if(!gt(g,f)){c.set(h,g);const{left:l,right:m}=n;n.right=new oe(L(i,fe(s.store,i)),l,l&&l.lastId,m,m&&m.id,e,null,new ae(h,f)),n.right.integrate(t,0),n.forward()}}return c},Os=(t,e,n,r,s)=>{n.currentAttributes.forEach((d,w)=>{s[w]===void 0&&(s[w]=null)});const i=t.doc,c=i.clientID;Ha(n,s);const h=Ga(t,e,n,s),f=r.constructor===String?new Ze(r):r instanceof me?new ut(r):new Bt(r);let{left:g,right:l,index:m}=n;e._searchMarker&&Jn(e._searchMarker,n.index,f.getLength()),l=new oe(L(c,fe(i.store,c)),g,g&&g.lastId,l,l&&l.id,e,null,f),l.integrate(t,0),n.right=l,n.index=m,n.forward(),qa(t,e,n,h)},co=(t,e,n,r,s)=>{const i=t.doc,c=i.clientID;Ha(n,s);const h=Ga(t,e,n,s);e:for(;n.right!==null&&(r>0||h.size>0&&(n.right.deleted||n.right.content.constructor===ae));){if(!n.right.deleted)switch(n.right.content.constructor){case ae:{const{key:f,value:g}=n.right.content,l=s[f];if(l!==void 0){if(gt(l,g))h.delete(f);else{if(r===0)break e;h.set(f,g)}n.right.delete(t)}else n.currentAttributes.set(f,g);break}default:r<n.right.length&&wt(t,L(n.right.id.client,n.right.id.clock+r)),r-=n.right.length;break}n.forward()}if(r>0){let f="";for(;r>0;r--)f+=`
`;n.right=new oe(L(c,fe(i.store,c)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,e,null,new Ze(f)),n.right.integrate(t,0),n.forward()}qa(t,e,n,h)},Ja=(t,e,n,r,s)=>{let i=e;const c=Ae();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===ae){const g=i.content;c.set(g.key,g)}i=i.right}let h=0,f=!1;for(;e!==i;){if(n===e&&(f=!0),!e.deleted){const g=e.content;switch(g.constructor){case ae:{const{key:l,value:m}=g,d=r.get(l)??null;(c.get(l)!==g||d===m)&&(e.delete(t),h++,!f&&(s.get(l)??null)===m&&d!==m&&(d===null?s.delete(l):s.set(l,d))),!f&&!e.deleted&&kn(s,g);break}}}e=e.right}return h},Ih=(t,e)=>{for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;const n=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===ae){const r=e.content.key;n.has(r)?e.delete(t):n.add(r)}e=e.left}},Ch=t=>{let e=0;return H(t.doc,n=>{let r=t._start,s=t._start,i=Ae();const c=Ps(i);for(;s;){if(s.deleted===!1)switch(s.content.constructor){case ae:kn(c,s.content);break;default:e+=Ja(n,r,s,i,c),i=Ps(c),r=s;break}s=s.right}}),e},Th=t=>{const e=new Set,n=t.doc;for(const[r,s]of t.afterState.entries()){const i=t.beforeState.get(r)||0;s!==i&&Ta(t,n.store.clients.get(r),i,s,c=>{!c.deleted&&c.content.constructor===ae&&c.constructor!==Ue&&e.add(c.parent)})}H(n,r=>{ya(t,t.deleteSet,s=>{if(s instanceof Ue||!s.parent._hasFormatting||e.has(s.parent))return;const i=s.parent;s.content.constructor===ae?e.add(i):Ih(r,s)});for(const s of e)Ch(s)})},lo=(t,e,n)=>{const r=n,s=Ps(e.currentAttributes),i=e.right;for(;n>0&&e.right!==null;){if(e.right.deleted===!1)switch(e.right.content.constructor){case ut:case Bt:case Ze:n<e.right.length&&wt(t,L(e.right.id.client,e.right.id.clock+n)),n-=e.right.length,e.right.delete(t);break}e.forward()}i&&Ja(t,i,e.right,s,e.currentAttributes);const c=(e.left||e.right).parent;return c._searchMarker&&Jn(c._searchMarker,e.index,-r+n),e};class Mh extends ls{constructor(e,n,r){super(e,n),this.childListChanged=!1,this.keysChanged=new Set,r.forEach(s=>{s===null?this.childListChanged=!0:this.keysChanged.add(s)})}get changes(){if(this._changes===null){const e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(this._delta===null){const e=this.target.doc,n=[];H(e,r=>{const s=new Map,i=new Map;let c=this.target._start,h=null;const f={};let g="",l=0,m=0;const d=()=>{if(h!==null){let w=null;switch(h){case"delete":m>0&&(w={delete:m}),m=0;break;case"insert":(typeof g=="object"||g.length>0)&&(w={insert:g},s.size>0&&(w.attributes={},s.forEach((k,A)=>{k!==null&&(w.attributes[A]=k)}))),g="";break;case"retain":l>0&&(w={retain:l},Fl(f)||(w.attributes=Ll({},f))),l=0;break}w&&n.push(w),h=null}};for(;c!==null;){switch(c.content.constructor){case ut:case Bt:this.adds(c)?this.deletes(c)||(d(),h="insert",g=c.content.getContent()[0],d()):this.deletes(c)?(h!=="delete"&&(d(),h="delete"),m+=1):c.deleted||(h!=="retain"&&(d(),h="retain"),l+=1);break;case Ze:this.adds(c)?this.deletes(c)||(h!=="insert"&&(d(),h="insert"),g+=c.content.str):this.deletes(c)?(h!=="delete"&&(d(),h="delete"),m+=c.length):c.deleted||(h!=="retain"&&(d(),h="retain"),l+=c.length);break;case ae:{const{key:w,value:k}=c.content;if(this.adds(c)){if(!this.deletes(c)){const A=s.get(w)??null;gt(A,k)?k!==null&&c.delete(r):(h==="retain"&&d(),gt(k,i.get(w)??null)?delete f[w]:f[w]=k)}}else if(this.deletes(c)){i.set(w,k);const A=s.get(w)??null;gt(A,k)||(h==="retain"&&d(),f[w]=A)}else if(!c.deleted){i.set(w,k);const A=f[w];A!==void 0&&(gt(A,k)?A!==null&&c.delete(r):(h==="retain"&&d(),k===null?delete f[w]:f[w]=k))}c.deleted||(h==="insert"&&d(),kn(s,c.content));break}}c=c.right}for(d();n.length>0;){const w=n[n.length-1];if(w.retain!==void 0&&w.attributes===void 0)n.pop();else break}}),this._delta=n}return this._delta}}class fn extends me{constructor(e){super(),this._pending=e!==void 0?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??Ee(),this._length}_integrate(e,n){super._integrate(e,n);try{this._pending.forEach(r=>r())}catch(r){console.error(r)}this._pending=null}_copy(){return new fn}clone(){const e=new fn;return e.applyDelta(this.toDelta()),e}_callObserver(e,n){super._callObserver(e,n);const r=new Mh(this,e,n);hs(this,e,r),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??Ee();let e="",n=this._start;for(;n!==null;)!n.deleted&&n.countable&&n.content.constructor===Ze&&(e+=n.content.str),n=n.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:n=!0}={}){this.doc!==null?H(this.doc,r=>{const s=new zs(null,this._start,0,new Map);for(let i=0;i<e.length;i++){const c=e[i];if(c.insert!==void 0){const h=!n&&typeof c.insert=="string"&&i===e.length-1&&s.right===null&&c.insert.slice(-1)===`
`?c.insert.slice(0,-1):c.insert;(typeof h!="string"||h.length>0)&&Os(r,this,s,h,c.attributes||{})}else c.retain!==void 0?co(r,this,s,c.retain,c.attributes||{}):c.delete!==void 0&&lo(r,s,c.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,n,r){this.doc??Ee();const s=[],i=new Map,c=this.doc;let h="",f=this._start;function g(){if(h.length>0){const m={};let d=!1;i.forEach((k,A)=>{d=!0,m[A]=k});const w={insert:h};d&&(w.attributes=m),s.push(w),h=""}}const l=()=>{for(;f!==null;){if(Wt(f,e)||n!==void 0&&Wt(f,n))switch(f.content.constructor){case Ze:{const m=i.get("ychange");e!==void 0&&!Wt(f,e)?(m===void 0||m.user!==f.id.client||m.type!=="removed")&&(g(),i.set("ychange",r?r("removed",f.id):{type:"removed"})):n!==void 0&&!Wt(f,n)?(m===void 0||m.user!==f.id.client||m.type!=="added")&&(g(),i.set("ychange",r?r("added",f.id):{type:"added"})):m!==void 0&&(g(),i.delete("ychange")),h+=f.content.str;break}case ut:case Bt:{g();const m={insert:f.content.getContent()[0]};if(i.size>0){const d={};m.attributes=d,i.forEach((w,k)=>{d[k]=w})}s.push(m);break}case ae:Wt(f,e)&&(g(),kn(i,f.content));break}f=f.right}g()};return e||n?H(c,m=>{e&&Js(m,e),n&&Js(m,n),l()},"cleanup"):l(),s}insert(e,n,r){if(n.length<=0)return;const s=this.doc;s!==null?H(s,i=>{const c=yr(i,this,e,!r);r||(r={},c.currentAttributes.forEach((h,f)=>{r[f]=h})),Os(i,this,c,n,r)}):this._pending.push(()=>this.insert(e,n,r))}insertEmbed(e,n,r){const s=this.doc;s!==null?H(s,i=>{const c=yr(i,this,e,!r);Os(i,this,c,n,r||{})}):this._pending.push(()=>this.insertEmbed(e,n,r||{}))}delete(e,n){if(n===0)return;const r=this.doc;r!==null?H(r,s=>{lo(s,yr(s,this,e,!0),n)}):this._pending.push(()=>this.delete(e,n))}format(e,n,r){if(n===0)return;const s=this.doc;s!==null?H(s,i=>{const c=yr(i,this,e,!1);c.right!==null&&co(i,this,c,n,r)}):this._pending.push(()=>this.format(e,n,r))}removeAttribute(e){this.doc!==null?H(this.doc,n=>{Hr(n,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,n){this.doc!==null?H(this.doc,r=>{_i(r,this,e,n)}):this._pending.push(()=>this.setAttribute(e,n))}getAttribute(e){return vi(this,e)}getAttributes(){return Va(this)}_write(e){e.writeTypeRef(Kh)}}const Dh=t=>new fn;class Rs{constructor(e,n=()=>!0){this._filter=n,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??Ee()}[Symbol.iterator](){return this}next(){let e=this._currentNode,n=e&&e.content&&e.content.type;if(e!==null&&(!this._firstCall||e.deleted||!this._filter(n)))do if(n=e.content.type,!e.deleted&&(n.constructor===dn||n.constructor===Ot)&&n._start!==null)e=n._start;else for(;e!==null;){const r=e.next;if(r!==null){e=r;break}else e.parent===this._root?e=null:e=e.parent._item}while(e!==null&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,e===null?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}}class Ot extends me{constructor(){super(),this._prelimContent=[]}get firstChild(){const e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Ot}clone(){const e=new Ot;return e.insert(0,this.toArray().map(n=>n instanceof me?n.clone():n)),e}get length(){return this.doc??Ee(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(e){return new Rs(this,e)}querySelector(e){e=e.toUpperCase();const r=new Rs(this,s=>s.nodeName&&s.nodeName.toUpperCase()===e).next();return r.done?null:r.value}querySelectorAll(e){return e=e.toUpperCase(),mt(new Rs(this,n=>n.nodeName&&n.nodeName.toUpperCase()===e))}_callObserver(e,n){hs(this,e,new Uh(this,n,e))}toString(){return Na(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,n={},r){const s=e.createDocumentFragment();return r!==void 0&&r._createAssociation(s,this),Wn(this,i=>{s.insertBefore(i.toDOM(e,n,r),null)}),s}insert(e,n){this.doc!==null?H(this.doc,r=>{$a(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}insertAfter(e,n){if(this.doc!==null)H(this.doc,r=>{const s=e&&e instanceof me?e._item:e;qr(r,this,s,n)});else{const r=this._prelimContent,s=e===null?0:r.findIndex(i=>i===e)+1;if(s===0&&e!==null)throw Ve("Reference item not found");r.splice(s,0,...n)}}delete(e,n=1){this.doc!==null?H(this.doc,r=>{Pa(r,this,e,n)}):this._prelimContent.splice(e,n)}toArray(){return La(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return Ba(this,e)}slice(e=0,n=this.length){return Ua(this,e,n)}forEach(e){Wn(this,e)}_write(e){e.writeTypeRef(Zh)}}const Oh=t=>new Ot;class dn extends Ot{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,n){super._integrate(e,n),this._prelimAttrs.forEach((r,s)=>{this.setAttribute(s,r)}),this._prelimAttrs=null}_copy(){return new dn(this.nodeName)}clone(){const e=new dn(this.nodeName),n=this.getAttributes();return Bl(n,(r,s)=>{e.setAttribute(s,r)}),e.insert(0,this.toArray().map(r=>r instanceof me?r.clone():r)),e}toString(){const e=this.getAttributes(),n=[],r=[];for(const h in e)r.push(h);r.sort();const s=r.length;for(let h=0;h<s;h++){const f=r[h];n.push(f+'="'+e[f]+'"')}const i=this.nodeName.toLocaleLowerCase(),c=n.length>0?" "+n.join(" "):"";return`<${i}${c}>${super.toString()}</${i}>`}removeAttribute(e){this.doc!==null?H(this.doc,n=>{Hr(n,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,n){this.doc!==null?H(this.doc,r=>{_i(r,this,e,n)}):this._prelimAttrs.set(e,n)}getAttribute(e){return vi(this,e)}hasAttribute(e){return ja(this,e)}getAttributes(e){return e?Sh(this,e):Va(this)}toDOM(e=document,n={},r){const s=e.createElement(this.nodeName),i=this.getAttributes();for(const c in i){const h=i[c];typeof h=="string"&&s.setAttribute(c,h)}return Wn(this,c=>{s.appendChild(c.toDOM(e,n,r))}),r!==void 0&&r._createAssociation(s,this),s}_write(e){e.writeTypeRef(Xh),e.writeKey(this.nodeName)}}const Rh=t=>new dn(t.readKey());class Uh extends ls{constructor(e,n,r){super(e,r),this.childListChanged=!1,this.attributesChanged=new Set,n.forEach(s=>{s===null?this.childListChanged=!0:this.attributesChanged.add(s)})}}class Gr extends hn{constructor(e){super(),this.hookName=e}_copy(){return new Gr(this.hookName)}clone(){const e=new Gr(this.hookName);return this.forEach((n,r)=>{e.set(r,n)}),e}toDOM(e=document,n={},r){const s=n[this.hookName];let i;return s!==void 0?i=s.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),r!==void 0&&r._createAssociation(i,this),i}_write(e){e.writeTypeRef(Qh),e.writeKey(this.hookName)}}const Lh=t=>new Gr(t.readKey());class Jr extends fn{get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new Jr}clone(){const e=new Jr;return e.applyDelta(this.toDelta()),e}toDOM(e=document,n,r){const s=e.createTextNode(this.toString());return r!==void 0&&r._createAssociation(s,this),s}toString(){return this.toDelta().map(e=>{const n=[];for(const s in e.attributes){const i=[];for(const c in e.attributes[s])i.push({key:c,value:e.attributes[s][c]});i.sort((c,h)=>c.key<h.key?-1:1),n.push({nodeName:s,attrs:i})}n.sort((s,i)=>s.nodeName<i.nodeName?-1:1);let r="";for(let s=0;s<n.length;s++){const i=n[s];r+=`<${i.nodeName}`;for(let c=0;c<i.attrs.length;c++){const h=i.attrs[c];r+=` ${h.key}="${h.value}"`}r+=">"}r+=e.insert;for(let s=n.length-1;s>=0;s--)r+=`</${n[s].nodeName}>`;return r}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(ef)}}const Nh=t=>new Jr;class Ii{constructor(e,n){this.id=e,this.length=n}get deleted(){throw $e()}mergeWith(e){return!1}write(e,n,r){throw $e()}integrate(e,n){throw $e()}}const Bh=0;class Ue extends Ii{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){n>0&&(this.id.clock+=n,this.length-=n),Ca(e.doc.store,this)}write(e,n){e.writeInfo(Bh),e.writeLen(this.length-n)}getMissing(e,n){return null}}class ur{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new ur(this.content)}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeBuf(this.content)}getRef(){return 3}}const Fh=t=>new ur(t.readBuf());class zn{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new zn(this.len)}splice(e){const n=new zn(this.len-e);return this.len=e,n}mergeWith(e){return this.len+=e.len,!0}integrate(e,n){Vr(e.deleteSet,n.id.client,n.id.clock,this.len),n.markDeleted()}delete(e){}gc(e){}write(e,n){e.writeLen(this.len-n)}getRef(){return 1}}const $h=t=>new zn(t.readLen()),Wa=(t,e)=>new En({guid:t,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1});class hr{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;const n={};this.opts=n,e.gc||(n.gc=!1),e.autoLoad&&(n.autoLoad=!0),e.meta!==null&&(n.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new hr(Wa(this.doc.guid,this.opts))}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){this.doc._item=n,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,n){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}}const Ph=t=>new hr(Wa(t.readString(),t.readAny()));class Bt{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new Bt(this.embed)}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeJSON(this.embed)}getRef(){return 5}}const Vh=t=>new Bt(t.readJSON());class ae{constructor(e,n){this.key=e,this.value=n}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new ae(this.key,this.value)}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){const r=n.parent;r._searchMarker=null,r._hasFormatting=!0}delete(e){}gc(e){}write(e,n){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}}const jh=t=>new ae(t.readKey(),t.readJSON());class Wr{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Wr(this.arr)}splice(e){const n=new Wr(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const qh=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++){const s=t.readString();s==="undefined"?n.push(void 0):n.push(JSON.parse(s))}return new Wr(n)},Hh=Fr("node_env")==="development";class Rt{constructor(e){this.arr=e,Hh&&Wo(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Rt(this.arr)}splice(e){const n=new Rt(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeAny(i)}}getRef(){return 8}}const Gh=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++)n.push(t.readAny());return new Rt(n)};class Ze{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new Ze(this.str)}splice(e){const n=new Ze(this.str.slice(e));this.str=this.str.slice(0,e);const r=this.str.charCodeAt(e-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,e-1)+"",n.str=""+n.str.slice(1)),n}mergeWith(e){return this.str+=e.str,!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeString(n===0?this.str:this.str.slice(n))}getRef(){return 4}}const Jh=t=>new Ze(t.readString()),Wh=[xh,vh,Dh,Rh,Oh,Lh,Nh],zh=0,Yh=1,Kh=2,Xh=3,Zh=4,Qh=5,ef=6;class ut{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new ut(this.type._copy())}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){this.type._integrate(e.doc,n)}delete(e){let n=this.type._start;for(;n!==null;)n.deleted?n.id.clock<(e.beforeState.get(n.id.client)||0)&&e._mergeStructs.push(n):n.delete(e),n=n.right;this.type._map.forEach(r=>{r.deleted?r.id.clock<(e.beforeState.get(r.id.client)||0)&&e._mergeStructs.push(r):r.delete(e)}),e.changed.delete(this.type)}gc(e){let n=this.type._start;for(;n!==null;)n.gc(e,!0),n=n.right;this.type._start=null,this.type._map.forEach(r=>{for(;r!==null;)r.gc(e,!0),r=r.left}),this.type._map=new Map}write(e,n){this.type._write(e)}getRef(){return 7}}const tf=t=>new ut(Wh[t.readTypeRef()](t)),zr=(t,e,n)=>{const{client:r,clock:s}=e.id,i=new oe(L(r,s+n),e,L(r,s+n-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(n));return e.deleted&&i.markDeleted(),e.keep&&(i.keep=!0),e.redone!==null&&(i.redone=L(e.redone.client,e.redone.clock+n)),e.right=i,i.right!==null&&(i.right.left=i),t._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),e.length=n,i};class oe extends Ii{constructor(e,n,r,s,i,c,h,f){super(e,f.getLength()),this.origin=r,this.left=n,this.right=s,this.rightOrigin=i,this.parent=c,this.parentSub=h,this.redone=null,this.content=f,this.info=this.content.isCountable()?ji:0}set marker(e){(this.info&_s)>0!==e&&(this.info^=_s)}get marker(){return(this.info&_s)>0}get keep(){return(this.info&Vi)>0}set keep(e){this.keep!==e&&(this.info^=Vi)}get countable(){return(this.info&ji)>0}get deleted(){return(this.info&xs)>0}set deleted(e){this.deleted!==e&&(this.info^=xs)}markDeleted(){this.info|=xs}getMissing(e,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=fe(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=fe(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===nn&&this.id.client!==this.parent.client&&this.parent.clock>=fe(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=ro(e,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=wt(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===Ue||this.right&&this.right.constructor===Ue)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===oe?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===oe&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===nn){const r=Ds(n,this.parent);r.constructor===Ue?this.parent=null:this.parent=r.content.type}return null}integrate(e,n){if(n>0&&(this.id.clock+=n,this.left=ro(e,e.doc.store,L(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(n),this.length-=n),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let r=this.left,s;if(r!==null)s=r.right;else if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start;const i=new Set,c=new Set;for(;s!==null&&s!==this.right;){if(c.add(s),i.add(s),mr(this.origin,s.origin)){if(s.id.client<this.id.client)r=s,i.clear();else if(mr(this.rightOrigin,s.rightOrigin))break}else if(s.origin!==null&&c.has(Ds(e.doc.store,s.origin)))i.has(Ds(e.doc.store,s.origin))||(r=s,i.clear());else break;s=s.right}this.left=r}if(this.left!==null){const r=this.left.right;this.right=r,this.left.right=this}else{let r;if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start,this.parent._start=this;this.right=r}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(e)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),Ca(e.doc.store,this),this.content.integrate(e,this),io(e,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(e)}else new Ue(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;e!==null&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;e!==null&&e.deleted;)e=e.left;return e}get lastId(){return this.length===1?this.id:L(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&mr(e.origin,this.lastId)&&this.right===e&&mr(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&this.redone===null&&e.redone===null&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){const n=this.parent._searchMarker;return n&&n.forEach(r=>{r.p===e&&(r.p=this,!this.deleted&&this.countable&&(r.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,this.right!==null&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){const n=this.parent;this.countable&&this.parentSub===null&&(n._length-=this.length),this.markDeleted(),Vr(e.deleteSet,this.id.client,this.id.clock,this.length),io(e,n,this.parentSub),this.content.delete(e)}}gc(e,n){if(!this.deleted)throw Ne();this.content.gc(e),n?oh(e,this,new Ue(this.id,this.length)):this.content=new zn(this.length)}write(e,n){const r=n>0?L(this.id.client,this.id.clock+n-1):this.origin,s=this.rightOrigin,i=this.parentSub,c=this.content.getRef()&Qr|(r===null?0:Ce)|(s===null?0:st)|(i===null?0:$n);if(e.writeInfo(c),r!==null&&e.writeLeftID(r),s!==null&&e.writeRightID(s),r===null&&s===null){const h=this.parent;if(h._item!==void 0){const f=h._item;if(f===null){const g=sh(h);e.writeParentInfo(!0),e.writeString(g)}else e.writeParentInfo(!1),e.writeLeftID(f.id)}else h.constructor===String?(e.writeParentInfo(!0),e.writeString(h)):h.constructor===nn?(e.writeParentInfo(!1),e.writeLeftID(h)):Ne();i!==null&&e.writeString(i)}this.content.write(e,n)}}const za=(t,e)=>nf[e&Qr](t),nf=[()=>{Ne()},$h,qh,Fh,Jh,Vh,jh,tf,Gh,Ph,()=>{Ne()}],rf=10;class Le extends Ii{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){Ne()}write(e,n){e.writeInfo(rf),$(e.restEncoder,this.length-n)}getMissing(e,n){return null}}const Ya=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof Pi<"u"?Pi:{},Ka="__ $YJS$ __";Ya[Ka]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");Ya[Ka]=!0;const Ft=t=>cn((e,n)=>{t.onerror=r=>n(new Error(r.target.error)),t.onsuccess=r=>e(r.target.result)}),sf=(t,e)=>cn((n,r)=>{const s=indexedDB.open(t);s.onupgradeneeded=i=>e(i.target.result),s.onerror=i=>r(Ve(i.target.error)),s.onsuccess=i=>{const c=i.target.result;c.onversionchange=()=>{c.close()},n(c)}}),of=t=>Ft(indexedDB.deleteDatabase(t)),af=(t,e)=>e.forEach(n=>t.createObjectStore.apply(t,n)),Dn=(t,e,n="readwrite")=>{const r=t.transaction(e,n);return e.map(s=>gf(r,s))},Xa=(t,e)=>Ft(t.count(e)),cf=(t,e)=>Ft(t.get(e)),Za=(t,e)=>Ft(t.delete(e)),lf=(t,e,n)=>Ft(t.put(e,n)),Ys=(t,e)=>Ft(t.add(e)),uf=(t,e,n)=>Ft(t.getAll(e,n)),hf=(t,e,n)=>{let r=null;return pf(t,e,s=>(r=s,!1),n).then(()=>r)},ff=(t,e=null)=>hf(t,e,"prev"),df=(t,e)=>cn((n,r)=>{t.onerror=r,t.onsuccess=async s=>{const i=s.target.result;if(i===null||await e(i)===!1)return n();i.continue()}}),pf=(t,e,n,r="next")=>df(t.openKeyCursor(e,r),s=>n(s.key)),gf=(t,e)=>t.objectStore(e),mf=(t,e)=>IDBKeyRange.upperBound(t,e),wf=(t,e)=>IDBKeyRange.lowerBound(t,e),Us="custom",Qa="updates",ec=500,tc=(t,e=()=>{},n=()=>{})=>{const[r]=Dn(t.db,[Qa]);return uf(r,wf(t._dbref,!1)).then(s=>{t._destroyed||(e(r),H(t.doc,()=>{s.forEach(i=>Qu(t.doc,i))},t,!1),n(r))}).then(()=>ff(r).then(s=>{t._dbref=s+1})).then(()=>Xa(r).then(s=>{t._dbsize=s})).then(()=>r)},yf=(t,e=!0)=>tc(t).then(n=>{(e||t._dbsize>=ec)&&Ys(n,xa(t.doc)).then(()=>Za(n,mf(t._dbref,!0))).then(()=>Xa(n).then(r=>{t._dbsize=r}))});class bf extends Xc{constructor(e,n){super(),this.doc=n,this.name=e,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=sf(e,r=>af(r,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=cn(r=>this.on("synced",()=>r(this))),this._db.then(r=>{this.db=r,tc(this,c=>Ys(c,xa(n)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(r,s)=>{if(this.db&&s!==this){const[i]=Dn(this.db,[Qa]);Ys(i,r),++this._dbsize>=ec&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{yf(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},n.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),n.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(e=>{e.close()})}clearData(){return this.destroy().then(()=>{of(this.name)})}get(e){return this._db.then(n=>{const[r]=Dn(n,[Us],"readonly");return cf(r,e)})}set(e,n){return this._db.then(r=>{const[s]=Dn(r,[Us]);return lf(s,n,e)})}del(e){return this._db.then(n=>{const[r]=Dn(n,[Us]);return Za(r,e)})}}const nc="schwalbvault",yt=new En,Ef=typeof window<"u",Mr=Ef?new bf(nc,yt):null,kf=yt.getMap("characters"),On=yt.getMap("campaigns"),Sf=yt.getMap("enemies"),Af=yt.getMap("encounters"),xf=yt.getMap("images"),_f=yt.getMap("deletedIds"),vf=()=>new Promise(t=>{if(!Mr){t();return}Mr.synced?t():Mr.on("synced",()=>{t()})}),Mp=Object.freeze(Object.defineProperty({__proto__:null,campaignsMap:On,charactersMap:kf,deletedIdsMap:_f,doc:yt,encountersMap:Af,enemiesMap:Sf,imagesMap:xf,provider:Mr,waitForSync:vf},Symbol.toStringTag,{value:"Module"}));const br="0123456789abcdef";class vt{constructor(e){this.bytes=e}static ofInner(e){if(e.length!==16)throw new TypeError("not 128-bit length");return new vt(e)}static fromFieldsV7(e,n,r,s){if(!Number.isInteger(e)||!Number.isInteger(n)||!Number.isInteger(r)||!Number.isInteger(s)||e<0||n<0||r<0||s<0||e>0xffffffffffff||n>4095||r>1073741823||s>4294967295)throw new RangeError("invalid field value");const i=new Uint8Array(16);return i[0]=e/2**40,i[1]=e/2**32,i[2]=e/2**24,i[3]=e/2**16,i[4]=e/2**8,i[5]=e,i[6]=112|n>>>8,i[7]=n,i[8]=128|r>>>24,i[9]=r>>>16,i[10]=r>>>8,i[11]=r,i[12]=s>>>24,i[13]=s>>>16,i[14]=s>>>8,i[15]=s,new vt(i)}static parse(e){var n,r,s,i;let c;switch(e.length){case 32:c=(n=/^[0-9a-f]{32}$/i.exec(e))===null||n===void 0?void 0:n[0];break;case 36:c=(r=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||r===void 0?void 0:r.slice(1,6).join("");break;case 38:c=(s=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(e))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 45:c=(i=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||i===void 0?void 0:i.slice(1,6).join("");break}if(c){const h=new Uint8Array(16);for(let f=0;f<16;f+=4){const g=parseInt(c.substring(2*f,2*f+8),16);h[f+0]=g>>>24,h[f+1]=g>>>16,h[f+2]=g>>>8,h[f+3]=g}return new vt(h)}else throw new SyntaxError("could not parse UUID string")}toString(){let e="";for(let n=0;n<this.bytes.length;n++)e+=br.charAt(this.bytes[n]>>>4),e+=br.charAt(this.bytes[n]&15),(n===3||n===5||n===7||n===9)&&(e+="-");return e}toHex(){let e="";for(let n=0;n<this.bytes.length;n++)e+=br.charAt(this.bytes[n]>>>4),e+=br.charAt(this.bytes[n]&15);return e}toJSON(){return this.toString()}getVariant(){const e=this.bytes[8]>>>4;if(e<0)throw new Error("unreachable");if(e<=7)return this.bytes.every(n=>n===0)?"NIL":"VAR_0";if(e<=11)return"VAR_10";if(e<=13)return"VAR_110";if(e<=15)return this.bytes.every(n=>n===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new vt(this.bytes.slice(0))}equals(e){return this.compareTo(e)===0}compareTo(e){for(let n=0;n<16;n++){const r=this.bytes[n]-e.bytes[n];if(r!==0)return Math.sign(r)}return 0}}class If{constructor(e){this.timestamp_biased=0,this.counter=0,this.random=e??Cf()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(e,n){let r=this.generateOrAbortCore(e,n);return r===void 0&&(this.timestamp_biased=0,r=this.generateOrAbortCore(e,n)),r}generateOrAbortCore(e,n){if(!Number.isInteger(e)||e<0||e>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(e++,e>this.timestamp_biased)this.timestamp_biased=e,this.resetCounter();else if(e+n>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return vt.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const e=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return e[6]=64|e[6]>>>4,e[8]=128|e[8]>>>2,vt.ofInner(e)}}const Cf=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new Tf;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class Tf{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let uo;const Bn=()=>Mf().toString(),Mf=()=>(uo||(uo=new If)).generate(),{floor:Df,random:Of}=Math,Yn="Trystero",Kn=(t,e)=>Array(t).fill().map(e),ho="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",rc=t=>Kn(t,()=>ho[Df(Of()*ho.length)]).join(""),zt=rc(20),At=Promise.all.bind(Promise),sc=typeof window<"u",{entries:Ks,fromEntries:ic,keys:Rf}=Object,tt=()=>{},nt=t=>new Error(`${Yn}: ${t}`),Uf=new TextEncoder,Lf=new TextDecoder,sn=t=>Uf.encode(t),Dr=t=>Lf.decode(t),Er=(...t)=>t.join("@"),Nf=(t,e,n,r)=>(t.relayUrls||e).slice(0,t.relayUrls?t.relayUrls.length:t.relayRedundancy||n),Xn=JSON.stringify,Zn=JSON.parse,fo=3333,kr={};let Fn=null,Xs=null;const Bf=()=>{Fn||(Fn=new Promise(t=>{Xs=t}).finally(()=>{Xs=null,Fn=null}))},Ff=()=>Xs?.(),$f=(t,e)=>{const n={},r=()=>{const s=new WebSocket(t);s.onclose=()=>{if(Fn){Fn.then(r);return}kr[t]??=fo,setTimeout(r,kr[t]),kr[t]*=2},s.onmessage=i=>e(i.data),n.socket=s,n.url=s.url,n.ready=new Promise(i=>s.onopen=()=>{i(n),kr[t]=fo}),n.send=i=>{s.readyState===1&&s.send(i)}};return r(),n},Pf=()=>{if(sc){const t=new AbortController;return addEventListener("online",Ff,{signal:t.signal}),addEventListener("offline",Bf,{signal:t.signal}),()=>t.abort()}return tt},Ci="AES-GCM",Vf={},jf=t=>btoa(String.fromCharCode.apply(null,new Uint8Array(t))),qf=t=>{const e=atob(t);return new Uint8Array(e.length).map((n,r)=>e.charCodeAt(r)).buffer},Hf=async(t,e)=>new Uint8Array(await crypto.subtle.digest(t,sn(e))),Rn=async t=>Vf[t]||=Array.from(await Hf("SHA-1",t)).map(e=>e.toString(36)).join(""),Gf=async(t,e,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},sn(`${t}:${e}:${n}`)),{name:Ci},!1,["encrypt","decrypt"]),oc="$",ac=",",Jf=async(t,e)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(ac)+oc+jf(await crypto.subtle.encrypt({name:Ci,iv:n},await t,sn(e)))},Wf=async(t,e)=>{const[n,r]=e.split(oc);return Dr(await crypto.subtle.decrypt({name:Ci,iv:new Uint8Array(n.split(ac))},await t,qf(r)))},zf=5e3,po="icegatheringstatechange",go="offer",Yf="answer",mo=(t,{rtcConfig:e,rtcPolyfill:n,turnConfig:r})=>{const s=new(n||RTCPeerConnection)({iceServers:Kf.concat(r||[]),...e}),i={};let c=!1,h=!1,f=null;const g=m=>{m.binaryType="arraybuffer",m.bufferedAmountLowThreshold=65535,m.onmessage=d=>i.data?.(d.data),m.onopen=()=>i.connect?.(),m.onclose=()=>i.close?.(),m.onerror=d=>i.error?.(d)},l=m=>Promise.race([new Promise(d=>{const w=()=>{m.iceGatheringState==="complete"&&(m.removeEventListener(po,w),d())};m.addEventListener(po,w),w()}),new Promise(d=>setTimeout(d,zf))]).then(()=>({type:m.localDescription.type,sdp:m.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return t?(f=s.createDataChannel("data"),g(f)):s.ondatachannel=({channel:m})=>{f=m,g(m)},s.onnegotiationneeded=async()=>{try{c=!0,await s.setLocalDescription();const m=await l(s);i.signal?.(m)}catch(m){i.error?.(m)}finally{c=!1}},s.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(s.connectionState)&&i.close?.()},s.ontrack=m=>{i.track?.(m.track,m.streams[0]),i.stream?.(m.streams[0])},s.onremovestream=m=>i.stream?.(m.stream),t&&(s.canTrickleIceCandidates||s.onnegotiationneeded()),{created:Date.now(),connection:s,get channel(){return f},get isDead(){return s.connectionState==="closed"},async signal(m){if(!(f?.readyState==="open"&&!m.sdp?.includes("a=rtpmap")))try{if(m.type===go){if(c||s.signalingState!=="stable"&&!h){if(t)return;await At([s.setLocalDescription({type:"rollback"}),s.setRemoteDescription(m)])}else await s.setRemoteDescription(m);await s.setLocalDescription();const d=await l(s);return i.signal?.(d),d}else if(m.type===Yf){h=!0;try{await s.setRemoteDescription(m)}finally{h=!1}}}catch(d){i.error?.(d)}},sendData:m=>f.send(m),destroy:()=>{f?.close(),s.close(),c=!1,h=!1},setHandlers:m=>Object.assign(i,m),offerPromise:t?new Promise(m=>i.signal=d=>{d.type===go&&m(d)}):Promise.resolve(),addStream:m=>m.getTracks().forEach(d=>s.addTrack(d,m)),removeStream:m=>s.getSenders().filter(d=>m.getTracks().includes(d.track)).forEach(d=>s.removeTrack(d)),addTrack:(m,d)=>s.addTrack(m,d),removeTrack:m=>{const d=s.getSenders().find(w=>w.track===m);d&&s.removeTrack(d)},replaceTrack:(m,d)=>{const w=s.getSenders().find(k=>k.track===m);if(w)return w.replaceTrack(d)}}},Kf=[...Kn(3,(t,e)=>`stun:stun${e||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(t=>({urls:t})),Xf=Object.getPrototypeOf(Uint8Array),Or=12,cc=0,Rr=cc+Or,Ur=Rr+1,Un=Ur+1,Ln=Un+1,kt=16*2**10-Ln,Sr=255,wo="bufferedamountlow",Jt=t=>"@_"+t,Zf=(t,e,n)=>{const r={},s={},i={},c={},h={},f={},g={},l={onPeerJoin:tt,onPeerLeave:tt,onPeerStream:tt,onPeerTrack:tt},m=(S,x)=>(S?Array.isArray(S)?S:[S]:Rf(r)).flatMap(O=>{const N=r[O];return N?x(O,N):(console.warn(`${Yn}: no peer with id ${O} found`),[])}),d=S=>{r[S]&&(r[S].destroy(),delete r[S],delete c[S],delete h[S],l.onPeerLeave(S),e(S))},w=S=>{if(s[S])return i[S];if(!S)throw nt("action type argument is required");const x=sn(S);if(x.byteLength>Or)throw nt(`action type string "${S}" (${x.byteLength}b) exceeds byte limit (${Or}). Hint: choose a shorter name.`);const O=new Uint8Array(Or);O.set(x);let N=0;return s[S]={onComplete:tt,onProgress:tt,setOnComplete:G=>s[S]={...s[S],onComplete:G},setOnProgress:G=>s[S]={...s[S],onProgress:G},send:async(G,_,T,X)=>{if(T&&typeof T!="object")throw nt("action meta argument must be an object");const ye=typeof G;if(ye==="undefined")throw nt("action data cannot be undefined");const ce=ye!=="string",Be=G instanceof Blob,j=Be||G instanceof ArrayBuffer||G instanceof Xf;if(T&&!j)throw nt("action meta argument can only be used with binary data");const B=j?new Uint8Array(Be?await G.arrayBuffer():G):sn(ce?Xn(G):G),z=T?sn(Xn(T)):null,Z=Math.ceil(B.byteLength/kt)+(T?1:0)||1,se=Kn(Z,(ie,le)=>{const Me=le===Z-1,be=T&&le===0,_e=new Uint8Array(Ln+(be?z.byteLength:Me?B.byteLength-kt*(Z-(T?2:1)):kt));return _e.set(O),_e.set([N],Rr),_e.set([Me|be<<1|j<<2|ce<<3],Ur),_e.set([Math.round((le+1)/Z*Sr)],Un),_e.set(T?be?z:B.subarray((le-1)*kt,le*kt):B.subarray(le*kt,(le+1)*kt),Ln),_e});return N=N+1&Sr,At(m(_,async(ie,le)=>{const{channel:Me}=le;let be=0;for(;be<Z;){const _e=se[be];if(Me.bufferedAmount>Me.bufferedAmountLowThreshold&&await new Promise(dr=>{const pr=()=>{Me.removeEventListener(wo,pr),dr()};Me.addEventListener(wo,pr)}),!r[ie])break;le.sendData(_e),be++,X?.(_e[Un]/Sr,ie,T)}}))}},i[S]||=[s[S].send,s[S].setOnComplete,s[S].setOnProgress]},k=(S,x)=>{const O=new Uint8Array(x),N=Dr(O.subarray(cc,Rr)).replaceAll("\0",""),[G]=O.subarray(Rr,Ur),[_]=O.subarray(Ur,Un),[T]=O.subarray(Un,Ln),X=O.subarray(Ln),ye=!!(_&1),ce=!!(_&2),Be=!!(_&4),j=!!(_&8);if(!s[N]){console.warn(`${Yn}: received message with unregistered type (${N})`);return}c[S]||={},c[S][N]||={};const B=c[S][N][G]||={chunks:[]};if(ce?B.meta=Zn(Dr(X)):B.chunks.push(X),s[N].onProgress(T/Sr,S,B.meta),!ye)return;const z=new Uint8Array(B.chunks.reduce((Z,se)=>Z+se.byteLength,0));if(B.chunks.reduce((Z,se)=>(z.set(se,Z),Z+se.byteLength),0),delete c[S][N][G],Be)s[N].onComplete(z,S,B.meta);else{const Z=Dr(z);s[N].onComplete(j?Zn(Z):Z,S)}},A=async()=>{await Et(""),await new Promise(S=>setTimeout(S,99)),Ks(r).forEach(([S,x])=>{x.destroy(),delete r[S]}),n()},[D,F]=w(Jt("ping")),[W,I]=w(Jt("pong")),[v,V]=w(Jt("signal")),[we,bt]=w(Jt("stream")),[Se,Vt]=w(Jt("track")),[Et,jt]=w(Jt("leave"));return t((S,x)=>{r[x]||(r[x]=S,S.setHandlers({data:O=>k(x,O),stream:O=>{l.onPeerStream(O,x,f[x]),delete f[x]},track:(O,N)=>{l.onPeerTrack(O,N,x,g[x]),delete g[x]},signal:O=>v(O,x),close:()=>d(x),error:O=>{console.error(O),d(x)}}),l.onPeerJoin(x))}),F((S,x)=>W("",x)),I((S,x)=>{h[x]?.(),delete h[x]}),V((S,x)=>r[x]?.signal(S)),bt((S,x)=>f[x]=S),Vt((S,x)=>g[x]=S),jt((S,x)=>d(x)),sc&&addEventListener("beforeunload",A),{makeAction:w,leave:A,ping:async S=>{if(!S)throw nt("ping() must be called with target peer ID");const x=Date.now();return D("",S),await new Promise(O=>h[S]=O),Date.now()-x},getPeers:()=>ic(Ks(r).map(([S,x])=>[S,x.connection])),addStream:(S,x,O)=>m(x,async(N,G)=>{O&&await we(O,N),G.addStream(S)}),removeStream:(S,x)=>m(x,(O,N)=>N.removeStream(S)),addTrack:(S,x,O,N)=>m(O,async(G,_)=>{N&&await Se(N,G),_.addTrack(S,x)}),removeTrack:(S,x)=>m(x,(O,N)=>N.removeTrack(S)),replaceTrack:(S,x,O,N)=>m(O,async(G,_)=>{N&&await Se(N,G),_.replaceTrack(S,x)}),onPeerJoin:S=>l.onPeerJoin=S,onPeerLeave:S=>l.onPeerLeave=S,onPeerStream:S=>l.onPeerStream=S,onPeerTrack:S=>l.onPeerTrack=S}},Qf=20,ed=5333,yo=57333,td=({init:t,subscribe:e,announce:n})=>{const r={};let s=!1,i,c,h,f;return(g,l,m)=>{const{appId:d}=g;if(r[d]?.[l])return r[d][l];const w={},k={},A=Er(Yn,d,l),D=Rn(A),F=Rn(Er(A,zt)),W=Gf(g.password||"",d,l),I=_=>async T=>({type:T.type,sdp:await _(W,T.sdp)}),v=I(Wf),V=I(Jf),we=()=>mo(!0,g),bt=(_,T,X)=>{if(k[T]){k[T]!==_&&_.destroy();return}k[T]=_,G(_,T),w[T]?.forEach((ye,ce)=>{ce!==X&&ye.destroy()}),delete w[T]},Se=(_,T)=>{k[T]===_&&delete k[T]},Vt=(_,T)=>{if(k[_])return;const X=w[_]?.[T];X&&(delete w[_][T],X.destroy())},Et=_=>(c.push(...Kn(_,we)),At(c.splice(0,_).map(T=>T.offerPromise.then(V).then(X=>({peer:T,offer:X}))))),jt=(_,T)=>m?.({error:`incorrect password (${g.password}) when decrypting ${T}`,appId:d,peerId:_,roomId:l}),S=_=>async(T,X,ye)=>{const[ce,Be]=await At([D,F]);if(T!==ce&&T!==Be)return;const{peerId:j,offer:B,answer:z,peer:Z}=typeof X=="string"?Zn(X):X;if(!(j===zt||k[j])){if(j&&!B&&!z){if(w[j]?.[_])return;const[[{peer:se,offer:ie}],le]=await At([Et(1),Rn(Er(A,j))]);w[j]||=[],w[j][_]=se,setTimeout(()=>Vt(j,_),x[_]*.9),se.setHandlers({connect:()=>bt(se,j,_),close:()=>Se(se,j)}),ye(le,Xn({peerId:zt,offer:ie}))}else if(B){if(w[j]?.[_]&&zt>j)return;const ie=mo(!1,g);ie.setHandlers({connect:()=>bt(ie,j,_),close:()=>Se(ie,j)});let le;try{le=await v(B)}catch{jt(j,"offer");return}if(ie.isDead)return;const[Me,be]=await At([Rn(Er(A,j)),ie.signal(le)]);ye(Me,Xn({peerId:zt,answer:await V(be)}))}else if(z){let se;try{se=await v(z)}catch{jt(j,"answer");return}if(Z)Z.setHandlers({connect:()=>bt(Z,j,_),close:()=>Se(Z,j)}),Z.signal(se);else{const ie=w[j]?.[_];ie&&!ie.isDead&&ie.signal(se)}}}};if(!g)throw nt("requires a config map as the first argument");if(!d&&!g.firebaseApp)throw nt("config map is missing appId field");if(!l)throw nt("roomId argument required");if(!s){const _=t(g);c=Kn(Qf,we),i=Array.isArray(_)?_:[_],s=!0,h=setInterval(()=>c=c.filter(T=>{const X=Date.now()-T.created<yo;return X||T.destroy(),X}),yo*1.03),f=g.manualRelayReconnection?tt:Pf()}const x=i.map(()=>ed),O=[],N=i.map(async(_,T)=>e(await _,await D,await F,S(T),Et));At([D,F]).then(([_,T])=>{const X=async(ye,ce)=>{const Be=await n(ye,_,T);typeof Be=="number"&&(x[ce]=Be),O[ce]=setTimeout(()=>X(ye,ce),x[ce])};N.forEach(async(ye,ce)=>{await ye,X(await i[ce],ce)})});let G=tt;return r[d]||={},r[d][l]=Zf(_=>G=_,_=>delete k[_],()=>{delete r[d][l],O.forEach(clearTimeout),N.forEach(async _=>(await _)()),clearInterval(h),f(),s=!1})}},Ls={},lc={},Cn={},Tn={},Mn={},bo={},Ar={},nd="announce",uc=20,Eo=10,rd=33333,sd=120333,id=3,od=async t=>{if(Ls[t])return Ls[t];const e=(await Rn(t)).slice(0,uc);return Ls[t]=e,lc[e]=t,e},ko=async(t,e,n)=>t.send(Xn({action:nd,info_hash:await od(e),peer_id:zt,...n})),So=(t,e,n)=>console.warn(`${Yn}: torrent tracker ${n?"failure":"warning"} from ${t} - ${e}`),hc=td({init:t=>Nf(t,ad,id).map(e=>{const n=$f(e,s=>{const i=Zn(s),c=i["failure reason"],h=i["warning message"],{interval:f}=i,g=lc[i.info_hash];if(c){So(r,c,!0);return}if(h&&So(r,h),f&&f*1e3>Mn[r]&&Tn[r][g]){const l=Math.min(f*1e3,sd);clearInterval(Cn[r][g]),Mn[r]=l,Cn[r][g]=setInterval(Tn[r][g],l)}bo[i.offer_id]||(i.offer||i.answer)&&(bo[i.offer_id]=!0,Ar[r][g]?.(i))}),{url:r}=n;return Ar[r]={},n.ready}),subscribe:(t,e,n,r,s)=>{const{url:i}=t,c=async()=>{const h=ic((await s(Eo)).map(f=>[rc(uc),f]));Ar[t.url][e]=f=>{if(f.offer)r(e,{offer:f.offer,peerId:f.peer_id},(g,l)=>ko(t,e,{answer:Zn(l).answer,offer_id:f.offer_id,to_peer_id:f.peer_id}));else if(f.answer){const g=h[f.offer_id];g&&r(e,{answer:f.answer,peerId:f.peer_id,peer:g.peer})}},ko(t,e,{numwant:Eo,offers:Ks(h).map(([f,{offer:g}])=>({offer_id:f,offer:g}))})};return Mn[i]=rd,Tn[i]||={},Tn[i][e]=c,Cn[i]||={},Cn[i][e]=setInterval(c,Mn[i]),c(),()=>{clearInterval(Cn[i][e]),delete Ar[i][e],delete Tn[i][e]}},announce:t=>Mn[t.url]}),ad=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(t=>"wss://"+t),Dp={NEXT_ROLL:"Prxima Rolagem",ROUNDS:"Rodadas",MINUTES:"Minutos",HOURS:"Horas",DAYS:"Dias",LUCK_ENDS:"Sorte Encerra",PERMANENT:"Indeterminado",END_OF_ROUND:"Fim da Rodada",CONCENTRATION:"Concentrao"},Tt={ADD:"ADD",SET:"SET",MULT:"MULT"},Op={str:"Fora",agi:"Agilidade",int:"Intelecto",wil:"Vontade",defense:"Defesa",speed:"Deslocamento",health:"Vida",damage:"Dano (Dados)",boons:"Boons/Banes",healing_rate:"Taxa de Cura"},Re={WEAPON:"Weapon",ARMOR:"Armor",SHIELD:"Shield",CONSUMABLE:"Consumable",EXPLOSIVE:"Explosive",OTHER:"Other"},Rp=["Aeromancy","Alchemy","Alteration","Animism","Astromancy","Chaos","Chronomancy","Conjuration","Cryomancy","Dark Arts","Destruction","Divination","Eldritch","Enchantment","Evocation","Geomancy","Hydromancy","Illusion","Invocation","Necromancy","Oneiromancy","Order","Primal","Protection","Psychomancy","Pyromancy","Shadowmancy","Skullduggery","Spiritualism","Symbolism","Technomancy","Teleportation","War"],cd=[[1,0,0,0,0,0,0,0,0,0,0],[2,1,0,0,0,0,0,0,0,0,0],[3,2,1,0,0,0,0,0,0,0,0],[4,2,1,1,0,0,0,0,0,0,0],[5,2,2,1,1,0,0,0,0,0,0],[6,3,2,2,1,1,0,0,0,0,0],[7,3,2,2,2,1,1,0,0,0,0],[8,3,2,2,2,1,1,1,0,0,0],[9,3,3,2,2,2,1,1,1,0,0],[10,3,3,3,2,2,1,1,1,1,0],[11,3,3,3,3,2,1,1,1,1,1]],Up=["Air","Alteration","Arcana","Battle","Celestial","Chaos","Conjuration","Curse","Death","Demonology","Destruction","Divination","Enchantment","Ether","Fey","Fire","Forbidden","Illusion","Life","Metal","Nature","Necromancy","Order","Primal","Protection","Rune","Shadow","Song","Soul","Spiritualism","Storm","Technomancy","Telekinesis","Telepathy","Teleportation","Theurgy","Time","Transformation","Water"];function Lp(t,e){return t<0||t>10||e<0||e>10?0:cd[t]?.[e]??0}const Np={Blinded:{effect:"Make rolls with 3 banes. No sight reactions. Speed halved.",speedMult:.5,rollMod:-3},Confused:{effect:"No reactions. Intellect and Will rolls with 1 bane.",rollMod:-1,attributes:["int","wil"]},Controlled:{effect:"Controller decides your turn. Regard source as ally."},Cursed:{effect:"Luck rolls with 1 bane."},Deafened:{effect:"No hearing reactions. Immune to hearing effects."},Frightened:{effect:"Attribute rolls with 1 bane (while in LOS). Grant 1 boon on rolls against you.",rollMod:-1},Held:{effect:"Speed 0. Cannot increase Speed. Auto-fail Agility defense rolls.",speedFixed:0},Impaired:{effect:"Roll with 1 bane for specified attribute. Grant 1 boon against that attribute.",rollMod:-1},Incapacitated:{effect:"Damage equals or exceeds Health. You cannot use actions or reactions. Speed 0.",speedFixed:0},"On Fire":{effect:"Take 1d6 damage at end of round. Action/Luck roll to extinguish."},Poisoned:{effect:"Attribute rolls with 1 bane. Grant 1 boon against you. Lose 1d6 Health end of round.",rollMod:-1},Prone:{effect:"No reactions. Grant 1 boon to melee vs you, impose 1 bane to ranged vs you."},Slowed:{effect:"Speed drops to 2 (if higher). Cannot benefit from Speed increases.",speedCap:2},Stunned:{effect:"No actions/reactions. Speed 0. Grant 2 boons against you. Attribute rolls with 2 banes.",speedFixed:0,rollMod:-2},Unconscious:{effect:"No actions/reactions. Speed 0. Grant 3 boons against you. Auto-fail attribute rolls.",speedFixed:0,autoFail:!0},Vulnerable:{effect:"Grant 1 boon on attacks/rolls against you."},Weakened:{effect:"Strength/Agility rolls with 1 bane. Grant 1 boon vs Str/Agi. Speed halved.",speedMult:.5,attributes:["str","agi"],rollMod:-1}},ld={OFF:"Off",ONE:"One",TWO:"Two"},Bp=["NIMBLE","FIREARM","THROWN","BRUTAL","BLUDGEONING","SLASHING","DISARMING","RANGE","SPECIAL","MISFIRE","LARGE","SLOW","LIGHT","LONG","AMMUNITION","PIERCING","RELOAD","VERSATILE"],Fp={ANCESTRY:"Ancestry",NOVICE:"Novice",EXPERT:"Expert",MASTER:"Master"};var Oe="INUMBER",Sn="IOP1",An="IOP2",xn="IOP3",it="IVAR",Ut="IVARNAME",pn="IFUNCALL",fs="IFUNDEF",xe="IEXPR",Ti="IEXPREVAL",$t="IMEMBER",ds="IENDSTATEMENT",gn="IARRAY";function P(t,e){this.type=t,this.value=e??0}P.prototype.toString=function(){switch(this.type){case Oe:case Sn:case An:case xn:case it:case Ut:case ds:return this.value;case pn:return"CALL "+this.value;case fs:return"DEF "+this.value;case gn:return"ARRAY "+this.value;case $t:return"."+this.value;default:return"Invalid Instruction"}};function ps(t){return new P(Sn,t)}function ht(t){return new P(An,t)}function fc(t){return new P(xn,t)}function Zs(t,e,n,r,s){for(var i=[],c=[],h,f,g,l,m=0;m<t.length;m++){var d=t[m],w=d.type;if(w===Oe||w===Ut)Array.isArray(d.value)?i.push.apply(i,Zs(d.value.map(function(k){return new P(Oe,k)}).concat(new P(gn,d.value.length)),e,n,r,s)):i.push(d);else if(w===it&&s.hasOwnProperty(d.value))d=new P(Oe,s[d.value]),i.push(d);else if(w===An&&i.length>1)f=i.pop(),h=i.pop(),l=n[d.value],d=new P(Oe,l(h.value,f.value)),i.push(d);else if(w===xn&&i.length>2)g=i.pop(),f=i.pop(),h=i.pop(),d.value==="?"?i.push(h.value?f.value:g.value):(l=r[d.value],d=new P(Oe,l(h.value,f.value,g.value)),i.push(d));else if(w===Sn&&i.length>0)h=i.pop(),l=e[d.value],d=new P(Oe,l(h.value)),i.push(d);else if(w===xe){for(;i.length>0;)c.push(i.shift());c.push(new P(xe,Zs(d.value,e,n,r,s)))}else if(w===$t&&i.length>0)h=i.pop(),i.push(new P(Oe,h.value[d.value]));else{for(;i.length>0;)c.push(i.shift());c.push(d)}}for(;i.length>0;)c.push(i.shift());return c}function dc(t,e,n){for(var r=[],s=0;s<t.length;s++){var i=t[s],c=i.type;if(c===it&&i.value===e)for(var h=0;h<n.tokens.length;h++){var f=n.tokens[h],g;f.type===Sn?g=ps(f.value):f.type===An?g=ht(f.value):f.type===xn?g=fc(f.value):g=new P(f.type,f.value),r.push(g)}else c===xe?r.push(new P(xe,dc(i.value,e,n))):r.push(i)}return r}function xt(t,e,n){var r=[],s,i,c,h,f,g;if(Mi(t))return et(t,n);for(var l=t.length,m=0;m<l;m++){var d=t[m],w=d.type;if(w===Oe||w===Ut)r.push(d.value);else if(w===An)i=r.pop(),s=r.pop(),d.value==="and"?r.push(s?!!xt(i,e,n):!1):d.value==="or"?r.push(s?!0:!!xt(i,e,n)):d.value==="="?(h=e.binaryOps[d.value],r.push(h(s,xt(i,e,n),n))):(h=e.binaryOps[d.value],r.push(h(et(s,n),et(i,n))));else if(w===xn)c=r.pop(),i=r.pop(),s=r.pop(),d.value==="?"?r.push(xt(s?i:c,e,n)):(h=e.ternaryOps[d.value],r.push(h(et(s,n),et(i,n),et(c,n))));else if(w===it)if(d.value in e.functions)r.push(e.functions[d.value]);else if(d.value in e.unaryOps&&e.parser.isOperatorEnabled(d.value))r.push(e.unaryOps[d.value]);else{var k=n[d.value];if(k!==void 0)r.push(k);else throw new Error("undefined variable: "+d.value)}else if(w===Sn)s=r.pop(),h=e.unaryOps[d.value],r.push(h(et(s,n)));else if(w===pn){for(g=d.value,f=[];g-- >0;)f.unshift(et(r.pop(),n));if(h=r.pop(),h.apply&&h.call)r.push(h.apply(void 0,f));else throw new Error(h+" is not a function")}else if(w===fs)r.push((function(){for(var A=r.pop(),D=[],F=d.value;F-- >0;)D.unshift(r.pop());var W=r.pop(),I=function(){for(var v=Object.assign({},n),V=0,we=D.length;V<we;V++)v[D[V]]=arguments[V];return xt(A,e,v)};return Object.defineProperty(I,"name",{value:W,writable:!1}),n[W]=I,I})());else if(w===xe)r.push(ud(d,e));else if(w===Ti)r.push(d);else if(w===$t)s=r.pop(),r.push(s[d.value]);else if(w===ds)r.pop();else if(w===gn){for(g=d.value,f=[];g-- >0;)f.unshift(r.pop());r.push(f)}else throw new Error("invalid Expression")}if(r.length>1)throw new Error("invalid Expression (parity)");return r[0]===0?0:et(r[0],n)}function ud(t,e,n){return Mi(t)?t:{type:Ti,value:function(r){return xt(t.value,e,r)}}}function Mi(t){return t&&t.type===Ti}function et(t,e){return Mi(t)?t.value(e):t}function Di(t,e){for(var n=[],r,s,i,c,h,f,g=0;g<t.length;g++){var l=t[g],m=l.type;if(m===Oe)typeof l.value=="number"&&l.value<0?n.push("("+l.value+")"):Array.isArray(l.value)?n.push("["+l.value.map(Ao).join(", ")+"]"):n.push(Ao(l.value));else if(m===An)s=n.pop(),r=n.pop(),c=l.value,e?c==="^"?n.push("Math.pow("+r+", "+s+")"):c==="and"?n.push("(!!"+r+" && !!"+s+")"):c==="or"?n.push("(!!"+r+" || !!"+s+")"):c==="||"?n.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+r+"),("+s+")))"):c==="=="?n.push("("+r+" === "+s+")"):c==="!="?n.push("("+r+" !== "+s+")"):c==="["?n.push(r+"[("+s+") | 0]"):n.push("("+r+" "+c+" "+s+")"):c==="["?n.push(r+"["+s+"]"):n.push("("+r+" "+c+" "+s+")");else if(m===xn)if(i=n.pop(),s=n.pop(),r=n.pop(),c=l.value,c==="?")n.push("("+r+" ? "+s+" : "+i+")");else throw new Error("invalid Expression");else if(m===it||m===Ut)n.push(l.value);else if(m===Sn)r=n.pop(),c=l.value,c==="-"||c==="+"?n.push("("+c+r+")"):e?c==="not"?n.push("(!"+r+")"):c==="!"?n.push("fac("+r+")"):n.push(c+"("+r+")"):c==="!"?n.push("("+r+"!)"):n.push("("+c+" "+r+")");else if(m===pn){for(f=l.value,h=[];f-- >0;)h.unshift(n.pop());c=n.pop(),n.push(c+"("+h.join(", ")+")")}else if(m===fs){for(s=n.pop(),f=l.value,h=[];f-- >0;)h.unshift(n.pop());r=n.pop(),e?n.push("("+r+" = function("+h.join(", ")+") { return "+s+" })"):n.push("("+r+"("+h.join(", ")+") = "+s+")")}else if(m===$t)r=n.pop(),n.push(r+"."+l.value);else if(m===gn){for(f=l.value,h=[];f-- >0;)h.unshift(n.pop());n.push("["+h.join(", ")+"]")}else if(m===xe)n.push("("+Di(l.value,e)+")");else if(m!==ds)throw new Error("invalid Expression")}return n.length>1&&(e?n=[n.join(",")]:n=[n.join(";")]),String(n[0])}function Ao(t){return typeof t=="string"?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function Kt(t,e){for(var n=0;n<t.length;n++)if(t[n]===e)return!0;return!1}function Oi(t,e,n){n=n||{};for(var r=!!n.withMembers,s=null,i=0;i<t.length;i++){var c=t[i];c.type===it||c.type===Ut?!r&&!Kt(e,c.value)?e.push(c.value):(s!==null&&(Kt(e,s)||e.push(s)),s=c.value):c.type===$t&&r&&s!==null?s+="."+c.value:c.type===xe?Oi(c.value,e,n):s!==null&&(Kt(e,s)||e.push(s),s=null)}s!==null&&!Kt(e,s)&&e.push(s)}function Pe(t,e){this.tokens=t,this.parser=e,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.functions=e.functions}Pe.prototype.simplify=function(t){return t=t||{},new Pe(Zs(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)};Pe.prototype.substitute=function(t,e){return e instanceof Pe||(e=this.parser.parse(String(e))),new Pe(dc(this.tokens,t,e),this.parser)};Pe.prototype.evaluate=function(t){return t=t||{},xt(this.tokens,this,t)};Pe.prototype.toString=function(){return Di(this.tokens,!1)};Pe.prototype.symbols=function(t){t=t||{};var e=[];return Oi(this.tokens,e,t),e};Pe.prototype.variables=function(t){t=t||{};var e=[];Oi(this.tokens,e,t);var n=this.functions;return e.filter(function(r){return!(r in n)})};Pe.prototype.toJSFunction=function(t,e){var n=this,r=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+Di(this.simplify(e).tokens,!0)+"; }");return function(){return r.apply(n,arguments)}};var Qn="TEOF",J="TOP",gs="TNUMBER",pc="TSTRING",ot="TPAREN",mn="TBRACKET",ms="TCOMMA",Ri="TNAME",Ui="TSEMICOLON";function gc(t,e,n){this.type=t,this.value=e,this.index=n}gc.prototype.toString=function(){return this.type+": "+this.value};function te(t,e){this.pos=0,this.current=null,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.consts=t.consts,this.expression=e,this.savedPosition=0,this.savedCurrent=null,this.options=t.options,this.parser=t}te.prototype.newToken=function(t,e,n){return new gc(t,e,n??this.pos)};te.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};te.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};te.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(Qn,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};te.prototype.isString=function(){var t=!1,e=this.pos,n=this.expression.charAt(e);if(n==="'"||n==='"')for(var r=this.expression.indexOf(n,e+1);r>=0&&this.pos<this.expression.length;){if(this.pos=r+1,this.expression.charAt(r-1)!=="\\"){var s=this.expression.substring(e+1,r);this.current=this.newToken(pc,this.unescape(s),e),t=!0;break}r=this.expression.indexOf(n,r+1)}return t};te.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return t==="("||t===")"?(this.current=this.newToken(ot,t),this.pos++,!0):!1};te.prototype.isBracket=function(){var t=this.expression.charAt(this.pos);return(t==="["||t==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(mn,t),this.pos++,!0):!1};te.prototype.isComma=function(){var t=this.expression.charAt(this.pos);return t===","?(this.current=this.newToken(ms,","),this.pos++,!0):!1};te.prototype.isSemicolon=function(){var t=this.expression.charAt(this.pos);return t===";"?(this.current=this.newToken(Ui,";"),this.pos++,!0):!1};te.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()&&(e===this.pos||n!=="_"&&n!=="."&&(n<"0"||n>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(r in this.consts)return this.current=this.newToken(gs,this.consts[r]),this.pos+=r.length,!0}return!1};te.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()&&(e===this.pos||n!=="_"&&(n<"0"||n>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(this.isOperatorEnabled(r)&&(r in this.binaryOps||r in this.unaryOps||r in this.ternaryOps))return this.current=this.newToken(J,r),this.pos+=r.length,!0}return!1};te.prototype.isName=function(){for(var t=this.pos,e=t,n=!1;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()){if(e===this.pos&&(r==="$"||r==="_")){r==="_"&&(n=!0);continue}else if(e===this.pos||!n||r!=="_"&&(r<"0"||r>"9"))break}else n=!0}if(n){var s=this.expression.substring(t,e);return this.current=this.newToken(Ri,s),this.pos+=s.length,!0}return!1};te.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);(e===" "||e==="	"||e===`
`||e==="\r")&&(t=!0,this.pos++,!(this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var hd=/^[0-9a-f]{4}$/i;te.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var n=t.substring(0,e);e>=0;){var r=t.charAt(++e);switch(r){case"'":n+="'";break;case'"':n+='"';break;case"\\":n+="\\";break;case"/":n+="/";break;case"b":n+="\b";break;case"f":n+="\f";break;case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"u":var s=t.substring(e+1,e+5);hd.test(s)||this.parseError("Illegal escape sequence: \\u"+s),n+=String.fromCharCode(parseInt(s,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+r+'"')}++e;var i=t.indexOf("\\",e);n+=t.substring(e,i<0?t.length:i),e=i}return n};te.prototype.isComment=function(){var t=this.expression.charAt(this.pos);return t==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};te.prototype.isRadixInteger=function(){var t=this.pos;if(t>=this.expression.length-2||this.expression.charAt(t)!=="0")return!1;++t;var e,n;if(this.expression.charAt(t)==="x")e=16,n=/^[0-9a-f]$/i,++t;else if(this.expression.charAt(t)==="b")e=2,n=/^[01]$/i,++t;else return!1;for(var r=!1,s=t;t<this.expression.length;){var i=this.expression.charAt(t);if(n.test(i))t++,r=!0;else break}return r&&(this.current=this.newToken(gs,parseInt(this.expression.substring(s,t),e)),this.pos=t),r};te.prototype.isNumber=function(){for(var t=!1,e=this.pos,n=e,r=e,s=!1,i=!1,c;e<this.expression.length&&(c=this.expression.charAt(e),c>="0"&&c<="9"||!s&&c===".");)c==="."?s=!0:i=!0,e++,t=i;if(t&&(r=e),c==="e"||c==="E"){e++;for(var h=!0,f=!1;e<this.expression.length;){if(c=this.expression.charAt(e),h&&(c==="+"||c==="-"))h=!1;else if(c>="0"&&c<="9")f=!0,h=!1;else break;e++}f||(e=r)}return t?(this.current=this.newToken(gs,parseFloat(this.expression.substring(n,e))),this.pos=e):this.pos=r,t};te.prototype.isOperator=function(){var t=this.pos,e=this.expression.charAt(this.pos);if(e==="+"||e==="-"||e==="*"||e==="/"||e==="%"||e==="^"||e==="?"||e===":"||e===".")this.current=this.newToken(J,e);else if(e===""||e==="")this.current=this.newToken(J,"*");else if(e===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(J,">="),this.pos++):this.current=this.newToken(J,">");else if(e==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(J,"<="),this.pos++):this.current=this.newToken(J,"<");else if(e==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(J,"||"),this.pos++;else return!1;else if(e==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(J,"=="),this.pos++):this.current=this.newToken(J,e);else if(e==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(J,"!="),this.pos++):this.current=this.newToken(J,e);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=t,!1)};te.prototype.isOperatorEnabled=function(t){return this.parser.isOperatorEnabled(t)};te.prototype.getCoordinates=function(){var t=0,e,n=-1;do t++,e=this.pos-n,n=this.expression.indexOf(`
`,n+1);while(n>=0&&n<this.pos);return{line:t,column:e}};te.prototype.parseError=function(t){var e=this.getCoordinates();throw new Error("parse error ["+e.line+":"+e.column+"]: "+t)};function Y(t,e,n){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=n.allowMemberAccess!==!1}Y.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};Y.prototype.tokenMatches=function(t,e){return typeof e>"u"?!0:Array.isArray(e)?Kt(e,t.value):typeof e=="function"?e(t):t.value===e};Y.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};Y.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};Y.prototype.accept=function(t,e){return this.nextToken.type===t&&this.tokenMatches(this.nextToken,e)?(this.next(),!0):!1};Y.prototype.expect=function(t,e){if(!this.accept(t,e)){var n=this.tokens.getCoordinates();throw new Error("parse error ["+n.line+":"+n.column+"]: Expected "+(e||t))}};Y.prototype.parseAtom=function(t){var e=this.tokens.unaryOps;function n(s){return s.value in e}if(this.accept(Ri)||this.accept(J,n))t.push(new P(it,this.current.value));else if(this.accept(gs))t.push(new P(Oe,this.current.value));else if(this.accept(pc))t.push(new P(Oe,this.current.value));else if(this.accept(ot,"("))this.parseExpression(t),this.expect(ot,")");else if(this.accept(mn,"["))if(this.accept(mn,"]"))t.push(new P(gn,0));else{var r=this.parseArrayList(t);t.push(new P(gn,r))}else throw new Error("unexpected "+this.nextToken)};Y.prototype.parseExpression=function(t){var e=[];this.parseUntilEndStatement(t,e)||(this.parseVariableAssignmentExpression(e),!this.parseUntilEndStatement(t,e)&&this.pushExpression(t,e))};Y.prototype.pushExpression=function(t,e){for(var n=0,r=e.length;n<r;n++)t.push(e[n])};Y.prototype.parseUntilEndStatement=function(t,e){return this.accept(Ui)?(this.nextToken&&this.nextToken.type!==Qn&&!(this.nextToken.type===ot&&this.nextToken.value===")")&&e.push(new P(ds)),this.nextToken.type!==Qn&&this.parseExpression(e),t.push(new P(xe,e)),!0):!1};Y.prototype.parseArrayList=function(t){for(var e=0;!this.accept(mn,"]");)for(this.parseExpression(t),++e;this.accept(ms);)this.parseExpression(t),++e;return e};Y.prototype.parseVariableAssignmentExpression=function(t){for(this.parseConditionalExpression(t);this.accept(J,"=");){var e=t.pop(),n=[],r=t.length-1;if(e.type===pn){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var s=0,i=e.value+1;s<i;s++){var c=r-s;t[c].type===it&&(t[c]=new P(Ut,t[c].value))}this.parseVariableAssignmentExpression(n),t.push(new P(xe,n)),t.push(new P(fs,e.value));continue}if(e.type!==it&&e.type!==$t)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(n),t.push(new P(Ut,e.value)),t.push(new P(xe,n)),t.push(ht("="))}};Y.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(J,"?");){var e=[],n=[];this.parseConditionalExpression(e),this.expect(J,":"),this.parseConditionalExpression(n),t.push(new P(xe,e)),t.push(new P(xe,n)),t.push(fc("?"))}};Y.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(J,"or");){var e=[];this.parseAndExpression(e),t.push(new P(xe,e)),t.push(ht("or"))}};Y.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(J,"and");){var e=[];this.parseComparison(e),t.push(new P(xe,e)),t.push(ht("and"))}};var fd=["==","!=","<","<=",">=",">","in"];Y.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(J,fd);){var e=this.current;this.parseAddSub(t),t.push(ht(e.value))}};var dd=["+","-","||"];Y.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(J,dd);){var e=this.current;this.parseTerm(t),t.push(ht(e.value))}};var pd=["*","/","%"];Y.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(J,pd);){var e=this.current;this.parseFactor(t),t.push(ht(e.value))}};Y.prototype.parseFactor=function(t){var e=this.tokens.unaryOps;function n(s){return s.value in e}if(this.save(),this.accept(J,n)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===ot&&this.nextToken.value==="("){this.restore(),this.parseExponential(t);return}else if(this.nextToken.type===Ui||this.nextToken.type===ms||this.nextToken.type===Qn||this.nextToken.type===ot&&this.nextToken.value===")"){this.restore(),this.parseAtom(t);return}}var r=this.current;this.parseFactor(t),t.push(ps(r.value))}else this.parseExponential(t)};Y.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(J,"^");)this.parseFactor(t),t.push(ht("^"))};Y.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(J,"!");)t.push(ps("!"))};Y.prototype.parseFunctionCall=function(t){var e=this.tokens.unaryOps;function n(i){return i.value in e}if(this.accept(J,n)){var r=this.current;this.parseAtom(t),t.push(ps(r.value))}else for(this.parseMemberExpression(t);this.accept(ot,"(");)if(this.accept(ot,")"))t.push(new P(pn,0));else{var s=this.parseArgumentList(t);t.push(new P(pn,s))}};Y.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(ot,")");)for(this.parseExpression(t),++e;this.accept(ms);)this.parseExpression(t),++e;return e};Y.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(J,".")||this.accept(mn,"[");){var e=this.current;if(e.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(Ri),t.push(new P($t,this.current.value))}else if(e.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(t),this.expect(mn,"]"),t.push(ht("["))}else throw new Error("unexpected symbol: "+e.value)}};function gd(t,e){return Number(t)+Number(e)}function md(t,e){return t-e}function wd(t,e){return t*e}function yd(t,e){return t/e}function bd(t,e){return t%e}function Ed(t,e){return Array.isArray(t)&&Array.isArray(e)?t.concat(e):""+t+e}function kd(t,e){return t===e}function Sd(t,e){return t!==e}function Ad(t,e){return t>e}function xd(t,e){return t<e}function _d(t,e){return t>=e}function vd(t,e){return t<=e}function Id(t,e){return!!(t&&e)}function Cd(t,e){return!!(t||e)}function Td(t,e){return Kt(e,t)}function Md(t){return(Math.exp(t)-Math.exp(-t))/2}function Dd(t){return(Math.exp(t)+Math.exp(-t))/2}function Od(t){return t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function Rd(t){return t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function Ud(t){return Math.log(t+Math.sqrt(t*t-1))}function Ld(t){return Math.log((1+t)/(1-t))/2}function xo(t){return Math.log(t)*Math.LOG10E}function Nd(t){return-t}function Bd(t){return!t}function Fd(t){return t<0?Math.ceil(t):Math.floor(t)}function $d(t){return Math.random()*(t||1)}function _o(t){return Li(t+1)}function Pd(t){return isFinite(t)&&t===Math.round(t)}var Vd=4.7421875,Ns=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Li(t){var e,n;if(Pd(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var r=t-2,s=t-1;r>1;)s*=r,r--;return s===0&&(s=1),s}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*Li(1-t));if(t>=171.35)return 1/0;if(t>85){var i=t*t,c=i*t,h=c*t,f=h*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*i)-139/(51840*c)-571/(2488320*h)+163879/(209018880*f)+5246819/(75246796800*f*t))}--t,n=Ns[0];for(var g=1;g<Ns.length;++g)n+=Ns[g]/(t+g);return e=t+Vd+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*n}function jd(t){return Array.isArray(t)?t.length:String(t).length}function vo(){for(var t=0,e=0,n=0;n<arguments.length;n++){var r=Math.abs(arguments[n]),s;e<r?(s=e/r,t=t*s*s+1,e=r):r>0?(s=r/e,t+=s*s):t+=r}return e===1/0?1/0:e*Math.sqrt(t)}function Io(t,e,n){return t?e:n}function qd(t,e){return typeof e>"u"||+e==0?Math.round(t):(t=+t,e=-+e,isNaN(t)||!(typeof e=="number"&&e%1===0)?NaN:(t=t.toString().split("e"),t=Math.round(+(t[0]+"e"+(t[1]?+t[1]-e:-e))),t=t.toString().split("e"),+(t[0]+"e"+(t[1]?+t[1]+e:e))))}function Hd(t,e,n){return n&&(n[t]=e),e}function Gd(t,e){return t[e|0]}function Jd(t){return arguments.length===1&&Array.isArray(t)?Math.max.apply(Math,t):Math.max.apply(Math,arguments)}function Wd(t){return arguments.length===1&&Array.isArray(t)?Math.min.apply(Math,t):Math.min.apply(Math,arguments)}function zd(t,e){if(typeof t!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(e))throw new Error("Second argument to map is not an array");return e.map(function(n,r){return t(n,r)})}function Yd(t,e,n){if(typeof t!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(n))throw new Error("Second argument to fold is not an array");return n.reduce(function(r,s,i){return t(r,s,i)},e)}function Kd(t,e){if(typeof t!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(e))throw new Error("Second argument to filter is not an array");return e.filter(function(n,r){return t(n,r)})}function Xd(t,e){if(!(Array.isArray(e)||typeof e=="string"))throw new Error("Second argument to indexOf is not a string or array");return e.indexOf(t)}function Zd(t,e){if(!Array.isArray(e))throw new Error("Second argument to join is not an array");return e.join(t)}function Qd(t){return(t>0)-(t<0)||+t}var Co=1/3;function ep(t){return t<0?-Math.pow(-t,Co):Math.pow(t,Co)}function tp(t){return Math.exp(t)-1}function np(t){return Math.log(1+t)}function rp(t){return Math.log(t)/Math.LN2}function Pt(t){this.options=t||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||Md,cosh:Math.cosh||Dd,tanh:Math.tanh||Od,asinh:Math.asinh||Rd,acosh:Math.acosh||Ud,atanh:Math.atanh||Ld,sqrt:Math.sqrt,cbrt:Math.cbrt||ep,log:Math.log,log2:Math.log2||rp,ln:Math.log,lg:Math.log10||xo,log10:Math.log10||xo,expm1:Math.expm1||tp,log1p:Math.log1p||np,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||Fd,"-":Nd,"+":Number,exp:Math.exp,not:Bd,length:jd,"!":_o,sign:Math.sign||Qd},this.binaryOps={"+":gd,"-":md,"*":wd,"/":yd,"%":bd,"^":Math.pow,"||":Ed,"==":kd,"!=":Sd,">":Ad,"<":xd,">=":_d,"<=":vd,and:Id,or:Cd,in:Td,"=":Hd,"[":Gd},this.ternaryOps={"?":Io},this.functions={random:$d,fac:_o,min:Wd,max:Jd,hypot:Math.hypot||vo,pyt:Math.hypot||vo,pow:Math.pow,atan2:Math.atan2,if:Io,gamma:Li,roundTo:qd,map:zd,fold:Yd,filter:Kd,indexOf:Xd,join:Zd},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}Pt.prototype.parse=function(t){var e=[],n=new Y(this,new te(this,t),{allowMemberAccess:this.options.allowMemberAccess});return n.parseExpression(e),n.expect(Qn,"EOF"),new Pe(e,this)};Pt.prototype.evaluate=function(t,e){return this.parse(t).evaluate(e)};var mc=new Pt;Pt.parse=function(t){return mc.parse(t)};Pt.evaluate=function(t,e){return mc.parse(t).evaluate(e)};var To={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function sp(t){return To.hasOwnProperty(t)?To[t]:t}Pt.prototype.isOperatorEnabled=function(t){var e=sp(t),n=this.options.operators||{};return!(e in n)||!!n[e]};const ip=new Pt,op={name:"Alaric, o Errante",level:3,ancestry:"Humano",paths:{novice:"Mago",expert:"Alquimista",master:"-"},attributes:[{name:"Fora",value:10,key:"str"},{name:"Agilidade",value:12,key:"agi"},{name:"Intelecto",value:15,key:"int"},{name:"Vontade",value:11,key:"wil"}],currency:{gp:0,sp:0,cp:0},naturalDefense:10,bonusDamage:0,speed:10,currentRound:1,languages:["Comum","lfico"],senses:[],afflictions:[],effects:[],notes:"",campaignId:null,campaignName:null,gmName:null,combatActive:!1,initiative:!1,acted:!1,spells:[{id:1,name:"Seta de Energia",tier:"Novice",type:"Ataque",tradition:"Destruction",description:"Causa 1d6 de dano a um alvo em alcance curto.",castings:3,maxCastings:3,effect:null},{id:2,name:"Escudo Mgico",tier:"Novice",type:"Utilidade",tradition:"Protection",description:"+2 em Defesa por 1 minuto.",castings:2,maxCastings:2,effect:{id:999,name:"Escudo Mgico",duration:"MINUTES",roundsLeft:10,initialRounds:10,description:"+2 Defesa",isActive:!0,modifiers:[{target:"defense",type:Tt.ADD,value:2}]}}],talents:[{id:1,name:"Sentido Arcano",description:"Voc detecta magia a curto alcance.",uses:0,maxUses:0,isPassive:!0,effect:null},{id:2,name:"Sorte do Principiante",description:"Pode refazer um teste falho.",uses:1,maxUses:1,isPassive:!1,effect:null}],equipment:[{id:1,name:"Cajado",type:Re.WEAPON,quantity:1,price:5,availability:"Common",quality:"Standard",grip:ld.TWO,range:"Melee",damageDice:1,boonsBanes:0,traits:"Finesse, Versatile",equippedState:null,equipped:!1},{id:2,name:"Poo de Cura",type:Re.CONSUMABLE,quantity:3,price:10,availability:"Common",quality:"Standard",notes:"Recupera Healing Rate",equippedState:null,equipped:!1},{id:3,name:"Granada Alqumica",type:Re.EXPLOSIVE,quantity:2,price:15,availability:"Uncommon",quality:"Standard",damageDice:2,range:"Short",traits:"Blast",description:"Explode em rea curta causando 2d6 de dano.",equippedState:null,equipped:!1},{id:4,name:"Couro Batido",type:Re.ARMOR,quantity:1,price:20,availability:"Common",quality:"Standard",defenseType:"fixed",defenseFixed:12,armorWeight:"Light",equipped:!1,equippedState:null}]},C=Te(op),Lr=Te([]),Xt=Te({type:null,isOpen:!1,data:null}),$p=Te("acoes"),Ni=Te(24),_n=Te(24),Lt=Te(0),er=Te(!1),Bi=Te(!1),Mo={autoOpenHistory:!1,stickyHistory:!1,theme:"dark"};function ap(){const t=typeof localStorage<"u"?localStorage.getItem("wwv_app_settings"):null,{subscribe:e,set:n,update:r}=Te(t?{...Mo,...JSON.parse(t)}:Mo);return{subscribe:e,set:s=>{typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(s)),n(s)},update:s=>{r(i=>{const c=s(i);return typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(c)),c})}}}const wc=ap();er.subscribe(t=>{t&&Bi.set(!1)});const fr=de(C,t=>{const e=t.effects.filter(r=>r.isActive),n=t.talents.filter(r=>(r.isPassive||r.activityType==="Passive")&&r.effect).map(r=>({...r.effect,id:`talent-effect-${r.id}`,name:r.name,sourceType:"talent",sourceId:r.id}));return[...e,...n]});function on(t,e){if(typeof t=="number")return t;if(!t)return 0;const n=String(t).trim();if(!isNaN(Number(n)))return Number(n);try{const r={};Array.isArray(e.attributes)&&e.attributes.forEach(i=>{r[i.key]=i.value}),r.level=e.level||0;const s=n.replace(/@(\w+)/g,"$1");return ip.evaluate(s,r)}catch{return 0}}function ws(t,e,n,r){let s=e||0;const i=n.flatMap(g=>Array.isArray(g.modifiers)?g.modifiers:[]),c=i.filter(g=>g.target===t&&g.type===Tt.SET);return c.length>0&&(s=on(c[c.length-1].value,r)),i.filter(g=>g.target===t&&g.type===Tt.ADD).forEach(g=>{s+=on(g.value,r)}),i.filter(g=>g.target===t&&g.type===Tt.MULT).forEach(g=>{s*=on(g.value,r)}),Math.floor(s)}const yc=de([C,fr],([t,e])=>{const n={};return Array.isArray(t.attributes)&&t.attributes.forEach(r=>{n[r.key]=ws(r.key,r.value,e,t)}),n}),cp=de([C,_n,fr],([t,e,n])=>ws("health",e,n,t)),Pp=de([cp,Ni],([t,e])=>Math.max(0,t-e)),Vp=de([Lt,_n],([t,e])=>e>0?Math.min(100,t/e*100):100),lp=de([Lt,_n],([t,e])=>t>=e),jp=de([Lt,_n,lp],([t,e,n])=>t>=e/2&&!n),qp=de([C,yc,fr],([t,e,n])=>{let r=ws("speed",t.speed,n,t);const s=t.afflictions;return s.includes("Held")||s.includes("Stunned")||s.includes("Unconscious")||s.includes("Incapacitated")?0:((s.includes("Blinded")||s.includes("Weakened"))&&(r=Math.floor(r/2)),s.includes("Slowed")&&(r=Math.min(r,2)),Math.max(0,r))}),Hp=de([C,fr],([t,e])=>{let n=t.naturalDefense,r=0;const s=t.equipment.find(i=>i.type===Re.ARMOR&&i.equipped);if(s){const i=s.defenseFixed||0,c=t.naturalDefense+(s.defenseMod||0);s.defenseFixed&&s.defenseMod?n=Math.max(i,c):s.defenseFixed?n=i:s.defenseMod&&(n=t.naturalDefense+s.defenseMod)}return t.equipment.filter(i=>i.type===Re.SHIELD&&i.equippedState).forEach(i=>{r+=i.defenseMod||0}),ws("defense",n+r,e,t)});de([C,fr],([t,e])=>{const r=e.flatMap(s=>Array.isArray(s.modifiers)?s.modifiers:[]).filter(s=>s.target==="damage"&&s.type===Tt.ADD).reduce((s,i)=>s+on(i.value,t),0);return(t.bonusDamage||0)+r});const Fe={updateCurrency:(t,e)=>{C.update(n=>{let r=n.currency.gp*100+n.currency.sp*10+n.currency.cp,s=0;return t==="gp"&&(s=e*100),t==="sp"&&(s=e*10),t==="cp"&&(s=e),r+=s,r<0&&(r=0),{...n,currency:{gp:Math.floor(r/100),sp:Math.floor(r%100/10),cp:r%100%10}}})},advanceRound:t=>{C.update(e=>{const n=e.currentRound||1;if(t==="next"){const r=(e.effects||[]).map(s=>{if(s.isActive&&s.duration==="ROUNDS"&&s.roundsLeft>0){const i=s.roundsLeft-1;return i<=0?{...s,roundsLeft:0,isActive:!1}:{...s,roundsLeft:i}}return s});return{...e,currentRound:n+1,effects:r}}else return{...e,currentRound:Math.max(1,n-1)}})},addToHistory:(t,e=!0)=>{const n=ge(C),r=ge(Lr);if(t.id&&r.find(c=>c.id===t.id))return;const s={id:t.id||Bn(),timestamp:t.timestamp||new Date,charName:n.name,...t};Lr.update(c=>[s,...c]),ge(wc).autoOpenHistory?er.set(!0):ge(er)||Bi.set(!0),e&&n.campaignId&&Bs(async()=>{const{syncRoll:c}=await Promise.resolve().then(()=>ti);return{syncRoll:c}},void 0,import.meta.url).then(({syncRoll:c})=>{c(s)})},clearHistory:()=>Lr.set([]),addItem:t=>C.update(e=>({...e,equipment:[...e.equipment,t]})),updateItem:t=>C.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?t:n)})),deleteItem:t=>C.update(e=>({...e,equipment:e.equipment.filter(n=>n.id!==t)})),useConsumable:t=>{t.quantity>0&&(Fe.updateItem({...t,quantity:t.quantity-1}),Fe.addToHistory({source:"Consumvel",name:t.name,description:`Usou ${t.name} `}))},equipItem:(t,e=null)=>{C.update(n=>{let r=[...n.equipment];return t.type===Re.ARMOR?r=r.map(s=>s.id===t.id?{...s,equipped:!s.equipped}:s.type===Re.ARMOR&&t.type===Re.ARMOR&&!t.equipped?{...s,equipped:!1}:s):(t.type===Re.WEAPON||t.type===Re.SHIELD)&&(r=r.map(s=>s.id===t.id?{...s,equippedState:e}:s)),{...n,equipment:r}})},toggleAffliction:t=>{C.update(e=>e.afflictions.includes(t)?{...e,afflictions:e.afflictions.filter(n=>n!==t)}:{...e,afflictions:[...e.afflictions,t]})},addLanguage:t=>C.update(e=>({...e,languages:[...e.languages,t]})),removeLanguage:t=>C.update(e=>({...e,languages:e.languages.filter((n,r)=>r!==t)})),addSense:t=>C.update(e=>({...e,senses:[...e.senses||[],t]})),removeSense:t=>C.update(e=>({...e,senses:(e.senses||[]).filter((n,r)=>r!==t)})),confirmRest:()=>{C.update(e=>{const n=e.spells.map(s=>({...s,castings:s.maxCastings})),r=e.talents.map(s=>({...s,uses:s.maxUses}));return{...e,spells:n,talents:r}}),Lt.set(0);const t=ge(Ni);_n.set(t),Xt.set({type:null,isOpen:!1,data:null})},finalizeRoll:(t,e,n=[])=>{const r=ge(C),s=ge(yc),i=t.type==="weapon_attack",c=t.type==="luck",h=t.type==="weapon_damage",f=t?.source,g=f?.name||"Ao",l=(m,d)=>m.traits&&m.traits.toLowerCase().includes(d.toLowerCase());if(h){let m=parseInt(f.damageDice)||0;const d=f.grip&&f.grip.toLowerCase()==="two"||f.equippedState&&f.equippedState.toLowerCase()==="two";l(f,"Versatile")&&d&&(m+=1);let w=r.bonusDamage||0;l(f,"Light")&&w>1&&(w-=1);const k=n.flatMap(v=>Array.isArray(v.modifiers)?v.modifiers:[]).filter(v=>v.target==="damage"&&v.type===Tt.ADD).reduce((v,V)=>v+on(V.value,r),0),A=w+k,D=Math.max(0,m+A+e);let F=[],W=0,I=[];for(let v=0;v<D;v++){let V=Math.floor(Math.random()*6)+1;if(V===1&&l(f,"Brutal")){const we=Math.floor(Math.random()*6)+1;I.push(`1->${we}`),V=we}else I.push(`${V}`);F.push(V),W+=V}Lt.set(W),Fe.addToHistory({source:"Dano",name:f.name,description:`Dano: ${D}d6 ${l(f,"Brutal")?"(Brutal)":""}`,formula:`${D}d6 [${F.join(", ")}] ${I.some(v=>v.includes("->"))?`(Rolagens: ${I.join(", ")})`:""}`,total:W,effectsApplied:n.map(v=>v.name)}),f.type===Re.EXPLOSIVE&&Fe.useConsumable(f)}else{const m=Math.floor(Math.random()*20)+1;let d=0,w="Sorte";if(t.type==="attribute")d=(s[t.source.key]||t.source.value)-10,w=t.source.name;else if(i){let I="str",v="Fora";f.range==="Ranged"&&(I="agi",v="Agilidade",l(f,"Thrown")&&(I="str",v="Fora")),l(f,"Nimble")&&(I="agi",v="Agilidade"),d=(s[I]||10)-10,w=v}const k=n.flatMap(I=>Array.isArray(I.modifiers)?I.modifiers:[]).filter(I=>I.target==="boons"&&I.type===Tt.ADD).reduce((I,v)=>I+on(v.value,r),0);e+=k;let A=0,D="";if(e!==0){const I=Math.abs(e);let v=[];for(let we=0;we<I;we++)v.push(Math.floor(Math.random()*6)+1);const V=Math.max(...v);e>0?(A=V,D=` + ${V} [Boon]`):(A=-V,D=` - ${V} [Bane]`)}const F=m+d+A;let W=i?`Ataque (${w})`:c?"Teste de Sorte":`Teste de ${g}`;if(e!==0&&(W+=` com ${e} boons/banes`),i&&m===20){let I=[];l(f,"Bludgeoning")&&I.push("Vuln"),l(f,"Piercing")&&I.push("Weakened"),l(f,"Slashing")&&I.push("+1d6 Dmg"),I.length>0&&(W+=`
CRTICO! ${I.join(" ")} `)}Fe.addToHistory({source:i?"Ataque":c?"Sorte":"Atributo",name:g,description:W,formula:`d20(${m})${d!==0?(d>=0?"+":"")+d:""}${D} `,total:F,crit:m===20,effectsApplied:n.map(I=>I.name)}),C.update(I=>({...I,effects:I.effects.map(v=>v.isActive&&v.duration==="NEXT_ROLL"?{...v,isActive:!1}:v)})),i&&l(f,"Reload")&&C.update(I=>({...I,equipment:I.equipment.map(v=>v.id===f.id?{...v,isLoaded:!1}:v)}))}Xt.set({type:null,isOpen:!1,data:null})},reloadWeapon:t=>{C.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?{...n,isLoaded:!0}:n)})),Fe.addToHistory({source:"Ao",name:"Recarregar",description:`Recarregou ${t.name}`})},addSpell:t=>C.update(e=>({...e,spells:[...e.spells,t]})),updateSpell:t=>C.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?t:n)})),deleteSpell:t=>C.update(e=>({...e,spells:e.spells.filter(n=>n.id!==t)})),commitSpellCast:t=>{t.castings>0&&(C.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?{...n,castings:n.castings-1}:n)})),Fe.addToHistory({source:"Magia",name:t.name,description:t.description}),Xt.set({type:null,isOpen:!1,data:null}))},addTalent:t=>C.update(e=>({...e,talents:[...e.talents,t]})),updateTalent:t=>C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?t:n)})),deleteTalent:t=>C.update(e=>({...e,talents:e.talents.filter(n=>n.id!==t)})),commitTalentUse:t=>{t.activityType==="Duration"&&t.duration==="LUCK_ENDS"?C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?{...n,uses:0}:n)})):t.maxUses&&C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?{...n,uses:n.uses-1}:n)})),Fe.addToHistory({source:"Talento",name:t.name,description:t.description}),Xt.set({type:null,isOpen:!1,data:null})},recoverTalent:t=>{C.update(e=>({...e,talents:e.talents.map(n=>n.id===t&&n.uses<n.maxUses?{...n,uses:n.uses+1}:n)}))},rollLuckTalent:t=>{const e=Math.floor(Math.random()*20)+1,n=e>=10,s=ge(C).talents.find(i=>i.id===t);Fe.addToHistory({source:"Sorte",name:`Teste de Sorte - ${s?.name||"Talento"}`,formula:`d20(${e})`,total:e,description:`Rolou ${e}. ${n?"Sucesso! Talento recuperado.":"Falha. O talento continua indisponvel."}`}),n&&C.update(i=>({...i,talents:i.talents.map(c=>c.id===t?{...c,uses:1}:c)}))},addEffect:t=>C.update(e=>({...e,effects:[...e.effects,t]})),updateEffect:t=>C.update(e=>({...e,effects:e.effects.map(n=>n.id===t.id?t:n)})),deleteEffect:t=>C.update(e=>({...e,effects:e.effects.filter(n=>n.id!==t)})),toggleEffect:t=>C.update(e=>({...e,effects:e.effects.map(n=>{if(n.id===t){const r=!n.isActive;return{...n,isActive:r,roundsLeft:r&&n.duration==="ROUNDS"&&n.initialRounds||n.roundsLeft}}return n})})),cleanInactiveEffects:()=>C.update(t=>({...t,effects:t.effects.filter(e=>e.isActive)})),applyEffectToCharacter:(t,e)=>{const n=t.name||(e?e.name:"Efeito sem nome"),r=t.description||(e?e.description:""),s={...t,id:Bn(),isActive:!0,name:n,description:r};s.duration==="ROUNDS"&&!s.initialRounds&&(s.initialRounds=s.roundsLeft),C.update(i=>({...i,effects:[...i.effects,s]}))},checkLuckEnds:t=>{const e=Math.floor(Math.random()*20)+1,n=e>=10;Fe.addToHistory({source:"Sorte",name:"Check Fim Efeito",description:`Rolou ${e}. ${n?"Sucesso (Encerra)":"Falha"} `}),n&&C.update(r=>({...r,effects:r.effects.map(s=>s.id===t?{...s,isActive:!1}:s)}))},joinCampaign:t=>{C.update(e=>({...e,campaignId:t.id,campaignName:t.name,gmName:t.gmName||"Mestre"})),Bs(async()=>{const{joinCampaignRoom:e}=await Promise.resolve().then(()=>ti);return{joinCampaignRoom:e}},void 0,import.meta.url).then(({joinCampaignRoom:e})=>{e(t.id,!1)})},leaveCampaign:()=>{C.update(t=>({...t,campaignId:null,campaignName:null,gmName:null,combatActive:!1}))}};Lt.subscribe(t=>{});const up={id:"",system:"sofdl",name:"Novo Personagem",ancestry:"Humano",level:0,paths:{novice:"",expert:"",master:""},imageUrl:"",attributes:{strength:10,agility:10,intellect:10,will:10},perception:10,defense:10,health:10,healingRate:2,size:1,speed:10,power:0,damage:0,insanity:0,corruption:0,description:"",notes:"",professions:[],languages:["Comum"],senses:[],afflictions:[],talents:[],spells:[],equipment:[],currency:{gc:0,ss:0,cp:0,bits:0},effects:[],campaignId:null,campaignName:null,gmName:null,campaignApproval:null,combatActive:!1,currentRound:1,initiative:!1,acted:!1,magicSystem:"standard"},M=Te(JSON.parse(JSON.stringify(up))),hp=de(M,t=>t.attributes),fp=de(hp,t=>({strength:t.strength-10,agility:t.agility-10,intellect:t.intellect-10,will:t.will-10}));de(M,t=>t.health-t.damage);const Gp=de(M,t=>t.damage>=t.health/2),Jp=de(M,t=>t.damage>=t.health),dp=de(M,t=>t.effects.filter(e=>e.isActive)),Wp=de([M,dp],([t,e])=>{let n=t.healingRate;return e.forEach(r=>{r.modifiers&&r.modifiers.forEach(s=>{s.target==="healing_rate"&&s.type==="ADD"&&(n+=Number(s.value))})}),Math.max(0,n)}),Yr={set:t=>{M.update(e=>{const n={...e,...t};return t.health!==void 0&&t.healingRate===void 0&&(n.healingRate=Math.floor(n.health/4)),n})},updateAttribute:(t,e)=>{M.update(n=>({...n,attributes:{...n.attributes,[t]:e}}))},takeDamage:t=>{M.update(e=>{const n=Math.max(0,Math.min(e.health,e.damage+t));return{...e,damage:n}})},heal:t=>{M.update(e=>{const n=Math.max(0,e.damage-t);return{...e,damage:n}})},updateStat:(t,e)=>{M.update(n=>({...n,[t]:Math.max(0,e)}))},toggleEffect:t=>{M.update(e=>({...e,effects:e.effects.map(n=>n.id===t?{...n,isActive:!n.isActive}:n)}))},deleteEffect:t=>{M.update(e=>({...e,effects:e.effects.filter(n=>n.id!==t)}))},cleanInactiveEffects:()=>{M.update(t=>({...t,effects:t.effects.filter(e=>e.isActive)}))},advanceRound:t=>{M.update(e=>{if(t==="next"){const n=e.effects.map(r=>r.isActive&&r.duration==="END_OF_ROUND"?{...r,isActive:!1}:r);return{...e,currentRound:e.currentRound+1,effects:n}}return{...e,currentRound:Math.max(1,e.currentRound-1)}})},checkLuckEnds:t=>{const n=ge(M).effects.find(r=>r.id===t);Xt.set({type:"pre_roll",isOpen:!0,data:{type:"luck_ends",system:"sofdl",effectId:t,source:{name:n?.name||"Efeito"}}})},checkConcentration:t=>{const n=ge(M).effects.find(r=>r.id===t);Xt.set({type:"pre_roll",isOpen:!0,data:{type:"concentration",system:"sofdl",effectId:t,key:"will",source:{name:n?.name||"Concentrao"}}})},addSpell:t=>{M.update(e=>({...e,spells:[...e.spells,{...t,id:t.id||Bn()}]}))},updateSpell:t=>{M.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?t:n)}))},deleteSpell:t=>{M.update(e=>({...e,spells:e.spells.filter(n=>n.id!==t)}))},castSpell:t=>{M.update(e=>({...e,spells:e.spells.map(n=>n.id===t?{...n,castingsUsed:(n.castingsUsed||0)+1}:n)}))},resetSpellCastings:()=>{M.update(t=>({...t,spells:t.spells.map(e=>({...e,castingsUsed:0}))}))},addTalent:t=>{M.update(e=>({...e,talents:[...e.talents,{...t,id:t.id||Bn()}]}))},updateTalent:t=>{M.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?t:n)}))},deleteTalent:t=>{M.update(e=>({...e,talents:e.talents.filter(n=>n.id!==t)}))},useTalent:t=>{M.update(e=>({...e,talents:e.talents.map(n=>n.id===t&&n.uses>0?{...n,uses:n.uses-1}:n)}))},resetTalentUses:()=>{M.update(t=>({...t,talents:t.talents.map(e=>({...e,uses:e.maxUses}))}))},addSense:t=>{M.update(e=>({...e,senses:e.senses.includes(t)?e.senses:[...e.senses,t]}))},removeSense:t=>{M.update(e=>({...e,senses:e.senses.filter((n,r)=>r!==t)}))},toggleAffliction:t=>{M.update(e=>({...e,afflictions:e.afflictions.includes(t)?e.afflictions.filter(n=>n!==t):[...e.afflictions,t]}))},leaveCampaign:()=>{M.update(t=>({...t,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}))},addToHistory:(t,e=!0)=>{const n=ge(M),r={id:t.id||Bn(),timestamp:t.timestamp||new Date,charName:n.name,...t};Lr.update(i=>[r,...i]),ge(wc).autoOpenHistory?er.set(!0):ge(er)||Bi.set(!0),e&&n.campaignId&&Bs(async()=>{const{syncRoll:i}=await Promise.resolve().then(()=>ti);return{syncRoll:i}},void 0,import.meta.url).then(({syncRoll:i})=>{i(r)})},addLanguage:t=>M.update(e=>({...e,languages:[...e.languages,t]})),removeLanguage:t=>M.update(e=>({...e,languages:e.languages.filter((n,r)=>r!==t)})),addProfession:t=>M.update(e=>({...e,professions:[...e.professions,t]})),removeProfession:t=>M.update(e=>({...e,professions:e.professions.filter((n,r)=>r!==t)})),updateCurrency:(t,e)=>{M.update(n=>{const r=Math.max(0,(n.currency[t]||0)+e);return{...n,currency:{...n.currency,[t]:r}}})},addItem:t=>M.update(e=>({...e,equipment:[...e.equipment,t]})),updateItem:t=>M.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?t:n)})),deleteItem:t=>M.update(e=>({...e,equipment:e.equipment.filter(n=>n.id!==t)})),useConsumable:t=>{M.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?{...n,quantity:Math.max(0,n.quantity-1)}:n)}))},reloadWeapon:t=>M.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?{...n,isLoaded:!0}:n)})),finalizeRoll:(t,e,n=[])=>{ge(M);const r=ge(fp),s=t?.type==="weapon_damage"||t?.type==="spell_damage",i=t?.source?.name||t?.key||"Atributo";if(s){const c=t.source?.damage??t.source?.damageDice??"1d6",h=String(c),f=Number(t.source?.damageMod)||0;let g=0,l=[],m="";if(h==="0")g=0,m="0";else if(!h.includes("d"))g=parseInt(h)||0,m=`${g}`,l=[g];else{const k=h.match(/(\d+)d(\d+)/);if(k){const A=parseInt(k[1])||1,D=parseInt(k[2])||6;for(let F=0;F<A;F++){const W=Math.floor(Math.random()*D)+1;g+=W,l.push(W)}m=`${h} [${l.join(", ")}]`}else g=1,m="1"}const d=g+e+f,w=e+f!==0?`${e+f>0?"+":""}${e+f}`:"";Yr.addToHistory({source:"Dano",name:i,description:`Dano de ${i}`,formula:`${m}${w}`,total:d})}else{const c=Math.floor(Math.random()*20)+1;let h=0,f=i;t.type==="attribute"?(h=r[t.key]||0,f=t.key):t.type==="luck"&&(h=0,f="Sorte");let g=0,l="";if(e!==0){const d=Math.abs(e);let w=[];for(let A=0;A<d;A++)w.push(Math.floor(Math.random()*6)+1);const k=Math.max(...w);e>0?(g=k,l=` + ${k} [Ddiva]`):(g=-k,l=` - ${k} [Perrdio]`)}const m=c+h+g;Yr.addToHistory({source:t.type==="luck"||t.type==="luck_ends"?"Sorte":"Atributo",name:f,description:t.type==="luck_ends"?`Teste de Sorte para encerrar efeito ${i}`:`Teste de ${f} ${e!==0?`com ${e} ddivas/perdies`:""}`,formula:`d20(${c})${h!==0?(h>=0?"+":"")+h:""}${l}`,total:m,crit:c===20,effectsApplied:n}),t.type==="luck_ends"&&m>=10&&M.update(d=>({...d,effects:d.effects.map(w=>w.id===t.effectId?{...w,isActive:!1}:w)}))}},rest:()=>{M.update(t=>{const e=t.spells.map(s=>({...s,castingsUsed:0})),n=t.talents.map(s=>({...s,uses:s.isPassive?0:s.maxUses})),r=Math.max(0,t.damage-t.healingRate);return{...t,spells:e,talents:n,damage:r}})}},bc={appId:nc,trackerUrls:["wss://tracker.openwebtorrent.com","wss://tracker.files.fm:7073/announce","wss://tracker.webtorrent.dev","wss://toad.vibe.community:443/announce","wss://tracker.btorrent.xyz"]},Je=Te({roomId:null,peers:[],currentCharacterId:null,lastGmUpdate:0,isGM:!1,isConnected:!1}),pp=de(Je,t=>t.lastGmUpdate?Date.now()-t.lastGmUpdate<6e4:!1);let ue=null,pt=null,tr=null,nr=null,rr=null,sr=null,It=null,Ye=null,Do=0,Oo=0;const gp=2e3,mp={appId:"weird-wizard-vault-lobby"},Qs=Te([]);function ir(t,e){if(!t)return!0;try{return t.leave(),!0}catch(n){return console.warn(`Failed to leave ${e}:`,n),!1}}function Ec(t){return Date.now()-t>=gp}function ei(){if(!Ec(Do))return console.warn("Lobby join rate limited. Skipping duplicate join attempt."),null;Do=Date.now(),It&&(clearInterval(It),It=null),ir(pt,"existing lobby"),pt=null;try{pt=hc(mp,"public-discovery");const[t,e]=pt.makeAction("discovery");return e(n=>{Qs.update(r=>{const s=r.findIndex(i=>i.id===n.id);if(s!==-1){const i=[...r];return i[s]={...n,lastSeen:Date.now()},i}return[...r,{...n,lastSeen:Date.now()}]})}),It=setInterval(()=>{const n=Date.now();Qs.update(r=>r.filter(s=>n-s.lastSeen<12e4))},6e4),t}catch(t){return console.error("Failed to join lobby:",t),pt=null,null}}let Kr;function wp(){typeof window<"u"&&(sessionStorage.getItem("lobby-initialized")?pt||(Kr=ei()):(sessionStorage.setItem("lobby-initialized","true"),Kr=ei()))}typeof window<"u"&&(wp(),window.addEventListener("beforeunload",()=>{Ro()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Ro()}));function Ro(){It&&(clearInterval(It),It=null),Ye&&(clearInterval(Ye),Ye=null),ir(pt,"lobby"),ir(ue,"room"),pt=null,ue=null}let Yt=null;function yp(t,e=!1,n=null){const r=`campaign-${t}`;if(Yt===r&&ue)return Je.update(s=>({...s,isGM:e,currentCharacterId:n})),ue;if(!Ec(Oo))return console.warn("Campaign join rate limited. Skipping duplicate join attempt."),ue;Oo=Date.now(),Ye&&(clearInterval(Ye),Ye=null),ir(ue,"existing campaign room"),ue=null,Yt=null,tr=null,nr=null,rr=null,sr=null;try{Yt=r,ue=hc(bc,Yt),Je.set({isConnected:!0,isGM:e,currentCharacterId:n,peers:[],roomId:t,lastGmUpdate:0});const[s,i]=ue.makeAction("combat"),[c,h]=ue.makeAction("history"),[f,g]=ue.makeAction("charUpdate"),[l,m]=ue.makeAction("campaign");return tr=s,nr=c,rr=f,sr=l,i(d=>{e||C.update(w=>({...w,currentRound:d.round,combatActive:d.active}))}),m(d=>{Je.update(w=>({...w,lastGmUpdate:Date.now()})),e||C.update(w=>({...w,campaignName:d.name,gmName:d.gmName,passwordHash:d.passwordHash}))}),e&&Kr&&(Ye=setInterval(()=>{const d=On.get(t);d&&d.isPublished&&Kr({id:t,name:d.name,gmName:d.gmName||"Mestre",description:d.description})},3e4)),h(d=>{Fe.addToHistory(d,!1)}),g(d=>{if(e){const w=On.get(t);if(w){const k=w.members||[],A=k.findIndex(v=>v.id===d.id);let D;if(A!==-1){D=[...k];const v=D[A],V={...d};v.campaignApproval==="approved"&&d.campaignApproval==="pending"&&delete V.campaignApproval,D[A]={...v,...V,lastUpdate:Date.now()}}else D=[...k,{...d,lastUpdate:Date.now()}];const F=w.activeEnemies||[],W=F.findIndex(v=>v.id===d.id&&v.type==="player");let I=F;W!==-1&&(I=[...F],I[W]={...I[W],...d}),On.set(t,{...w,members:D,activeEnemies:I})}}else{const w=ge(Je),k=ge(C),A=w.currentCharacterId||k?.id;if(A&&A===d.id){const D=d.system==="sofdl";if(d.campaignApproval==="rejected"||d.campaignId===null){D?Yr.leaveCampaign():C.update(F=>({...F,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}));return}D?Yr.set({name:d.name,afflictions:d.afflictions,senses:d.senses,initiative:d.initiative,acted:d.acted,campaignApproval:d.campaignApproval,imageUrl:d.imageUrl,notes:d.notes,damage:d.damage,health:d.health,healingRate:d.healingRate,insanity:d.insanity,corruption:d.corruption,defense:d.defense,speed:d.speed,power:d.power,attributes:d.attributes}):(C.update(F=>({...F,name:d.name||F.name,afflictions:d.afflictions||F.afflictions,senses:d.senses||F.senses,initiative:d.initiative!==void 0?d.initiative:F.initiative??!1,acted:d.acted!==void 0?d.acted:F.acted??!1,campaignApproval:d.campaignApproval||F.campaignApproval,imageUrl:d.imageUrl||F.imageUrl,notes:d.notes!==void 0?d.notes:F.notes})),d.damage!==void 0&&Lt.set(d.damage),d.currentHealth!==void 0&&_n.set(d.currentHealth),d.normalHealth!==void 0&&Ni.set(d.normalHealth))}}}),ue.onPeerJoin(d=>{if(Je.update(w=>({...w,peers:[...w.peers,d]})),e){const w=On.get(t);w&&(w.combat&&s(w.combat),l({name:w.name,gmName:w.gmName||"Mestre",passwordHash:w.passwordHash}))}}),ue.onPeerLeave(d=>{Je.update(w=>({...w,peers:w.peers.filter(k=>k!==d)}))}),ue}catch(s){return console.error("Failed to join campaign room:",s),ue=null,Yt=null,Je.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0}),null}}function bp(t,e){tr&&tr(e)}function Ep(t,e){sr&&sr({name:e.name,gmName:e.gmName||"Mestre",passwordHash:e.passwordHash})}function kp(t){nr&&nr(t)}function Sp(t){rr&&rr(t)}function Ap(){Ye&&(clearInterval(Ye),Ye=null),ir(ue,"campaign room"),ue=null,Yt=null,tr=null,nr=null,rr=null,sr=null,Je.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0})}const ti=Object.freeze(Object.defineProperty({__proto__:null,isGmOnline:pp,joinCampaignRoom:yp,joinLobby:ei,leaveCampaignRoom:Ap,publicCampaigns:Qs,roomConfig:bc,syncCampaign:Ep,syncCharacter:Sp,syncCombat:bp,syncRoll:kp,syncState:Je},Symbol.toStringTag,{value:"Module"}));export{Jp as $,Np as A,cp as B,Lt as C,Pp as D,jp as E,lp as F,Vp as G,Xt as H,ld as I,Re as J,Dp as K,Op as L,Rp as M,Tt as N,Yr as O,M as P,Ni as Q,_n as R,dp as S,Fp as T,fr as U,yc as V,Bp as W,Hp as X,qp as Y,$p as Z,Gp as _,yp as a,fp as a0,Wp as a1,Lp as a2,Up as a3,up as a4,op as a5,Mp as a6,Cp as b,C as c,kf as d,On as e,Sf as f,Af as g,Sp as h,pp as i,hc as j,Ep as k,Ap as l,er as m,bp as n,Je as o,Bi as p,Fe as q,bc as r,zt as s,_f as t,Bn as u,xf as v,vf as w,wc as x,Qs as y,Lr as z};
