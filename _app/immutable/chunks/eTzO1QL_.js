import{ba as Cn,aV as Qe,av as es,L as Rn,K as _n,h as In,bb as ts}from"./EigO5Itq.js";import{w as Q,j,g as k}from"./CE5Oy5gg.js";import{_ as $t}from"./PPVm8Dsz.js";import{$ as me}from"./B3FtJd8P.js";import{d as ns,a as yt}from"./2Gu058ss.js";function fa(e,t,n=t){var s=new WeakSet;Cn(e,"input",async r=>{var a=r?e.defaultValue:e.value;if(a=Ut(e)?Dt(a):a,n(a),Qe!==null&&s.add(Qe),await es(),a!==(a=t())){var o=e.selectionStart,l=e.selectionEnd,c=e.value.length;if(e.value=a??"",l!==null){var h=e.value.length;o===l&&l===c&&h>c?(e.selectionStart=h,e.selectionEnd=h):(e.selectionStart=o,e.selectionEnd=Math.min(l,h))}}}),(In&&e.defaultValue!==e.value||Rn(t)==null&&e.value)&&(n(Ut(e)?Dt(e.value):e.value),Qe!==null&&s.add(Qe)),_n(()=>{var r=t();if(e===document.activeElement){var a=ts??Qe;if(s.has(a))return}Ut(e)&&r===Dt(e.value)||e.type==="date"&&!r&&!e.value||r!==e.value&&(e.value=r??"")})}function pa(e,t,n=t){Cn(e,"change",s=>{var r=s?e.defaultChecked:e.checked;n(r)}),(In&&e.defaultChecked!==e.checked||Rn(t)==null)&&n(e.checked),_n(()=>{var s=t();e.checked=!!s})}function Ut(e){var t=e.type;return t==="number"||t==="range"}function Dt(e){return e===""?null:+e}const vt="0123456789abcdef";class Oe{constructor(t){this.bytes=t}static ofInner(t){if(t.length!==16)throw new TypeError("not 128-bit length");return new Oe(t)}static fromFieldsV7(t,n,s,r){if(!Number.isInteger(t)||!Number.isInteger(n)||!Number.isInteger(s)||!Number.isInteger(r)||t<0||n<0||s<0||r<0||t>0xffffffffffff||n>4095||s>1073741823||r>4294967295)throw new RangeError("invalid field value");const a=new Uint8Array(16);return a[0]=t/2**40,a[1]=t/2**32,a[2]=t/2**24,a[3]=t/2**16,a[4]=t/2**8,a[5]=t,a[6]=112|n>>>8,a[7]=n,a[8]=128|s>>>24,a[9]=s>>>16,a[10]=s>>>8,a[11]=s,a[12]=r>>>24,a[13]=r>>>16,a[14]=r>>>8,a[15]=r,new Oe(a)}static parse(t){var n,s,r,a;let o;switch(t.length){case 32:o=(n=/^[0-9a-f]{32}$/i.exec(t))===null||n===void 0?void 0:n[0];break;case 36:o=(s=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(t))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 38:o=(r=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(t))===null||r===void 0?void 0:r.slice(1,6).join("");break;case 45:o=(a=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(t))===null||a===void 0?void 0:a.slice(1,6).join("");break}if(o){const l=new Uint8Array(16);for(let c=0;c<16;c+=4){const h=parseInt(o.substring(2*c,2*c+8),16);l[c+0]=h>>>24,l[c+1]=h>>>16,l[c+2]=h>>>8,l[c+3]=h}return new Oe(l)}else throw new SyntaxError("could not parse UUID string")}toString(){let t="";for(let n=0;n<this.bytes.length;n++)t+=vt.charAt(this.bytes[n]>>>4),t+=vt.charAt(this.bytes[n]&15),(n===3||n===5||n===7||n===9)&&(t+="-");return t}toHex(){let t="";for(let n=0;n<this.bytes.length;n++)t+=vt.charAt(this.bytes[n]>>>4),t+=vt.charAt(this.bytes[n]&15);return t}toJSON(){return this.toString()}getVariant(){const t=this.bytes[8]>>>4;if(t<0)throw new Error("unreachable");if(t<=7)return this.bytes.every(n=>n===0)?"NIL":"VAR_0";if(t<=11)return"VAR_10";if(t<=13)return"VAR_110";if(t<=15)return this.bytes.every(n=>n===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new Oe(this.bytes.slice(0))}equals(t){return this.compareTo(t)===0}compareTo(t){for(let n=0;n<16;n++){const s=this.bytes[n]-t.bytes[n];if(s!==0)return Math.sign(s)}return 0}}class ss{constructor(t){this.timestamp_biased=0,this.counter=0,this.random=t??rs()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(t,n){let s=this.generateOrAbortCore(t,n);return s===void 0&&(this.timestamp_biased=0,s=this.generateOrAbortCore(t,n)),s}generateOrAbortCore(t,n){if(!Number.isInteger(t)||t<0||t>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(t++,t>this.timestamp_biased)this.timestamp_biased=t,this.resetCounter();else if(t+n>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return Oe.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const t=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return t[6]=64|t[6]>>>4,t[8]=128|t[8]>>>2,Oe.ofInner(t)}}const rs=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new as;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class as{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let on;const at=()=>os().toString(),os=()=>(on||(on=new ss)).generate(),{floor:is,random:ls}=Math,lt="Trystero",ct=(e,t)=>Array(e).fill().map(t),ln="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",Pn=e=>ct(e,()=>ln[is(ls()*ln.length)]).join(""),Ue=Pn(20),Te=Promise.all.bind(Promise),Nn=typeof window<"u",{entries:Ft,fromEntries:Ln,keys:cs}=Object,he=()=>{},de=e=>new Error(`${lt}: ${e}`),us=new TextEncoder,fs=new TextDecoder,He=e=>us.encode(e),Mt=e=>fs.decode(e),wt=(...e)=>e.join("@"),ps=(e,t,n,s)=>(e.relayUrls||t).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||n),ut=JSON.stringify,ft=JSON.parse,cn=3333,bt={};let ot=null,Bt=null;const hs=()=>{ot||(ot=new Promise(e=>{Bt=e}).finally(()=>{Bt=null,ot=null}))},ds=()=>Bt?.(),ms=(e,t)=>{const n={},s=()=>{const r=new WebSocket(e);r.onclose=()=>{if(ot){ot.then(s);return}bt[e]??=cn,setTimeout(s,bt[e]),bt[e]*=2},r.onmessage=a=>t(a.data),n.socket=r,n.url=r.url,n.ready=new Promise(a=>r.onopen=()=>{a(n),bt[e]=cn}),n.send=a=>{r.readyState===1&&r.send(a)}};return s(),n},gs=()=>{if(Nn){const e=new AbortController;return addEventListener("online",ds,{signal:e.signal}),addEventListener("offline",hs,{signal:e.signal}),()=>e.abort()}return he},Wt="AES-GCM",ys={},vs=e=>btoa(String.fromCharCode.apply(null,new Uint8Array(e))),ws=e=>{const t=atob(e);return new Uint8Array(t.length).map((n,s)=>t.charCodeAt(s)).buffer},bs=async(e,t)=>new Uint8Array(await crypto.subtle.digest(e,He(t))),nt=async e=>ys[e]||=Array.from(await bs("SHA-1",e)).map(t=>t.toString(36)).join(""),As=async(e,t,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},He(`${e}:${t}:${n}`)),{name:Wt},!1,["encrypt","decrypt"]),Un="$",Dn=",",Es=async(e,t)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(Dn)+Un+vs(await crypto.subtle.encrypt({name:Wt,iv:n},await e,He(t)))},Ms=async(e,t)=>{const[n,s]=t.split(Un);return Mt(await crypto.subtle.decrypt({name:Wt,iv:new Uint8Array(n.split(Dn))},await e,ws(s)))},Ss=5e3,un="icegatheringstatechange",fn="offer",Ts="answer",pn=(e,{rtcConfig:t,rtcPolyfill:n,turnConfig:s})=>{const r=new(n||RTCPeerConnection)({iceServers:ks.concat(s||[]),...t}),a={};let o=!1,l=!1,c=null;const h=f=>{f.binaryType="arraybuffer",f.bufferedAmountLowThreshold=65535,f.onmessage=i=>a.data?.(i.data),f.onopen=()=>a.connect?.(),f.onclose=()=>a.close?.(),f.onerror=i=>a.error?.(i)},p=f=>Promise.race([new Promise(i=>{const m=()=>{f.iceGatheringState==="complete"&&(f.removeEventListener(un,m),i())};f.addEventListener(un,m),m()}),new Promise(i=>setTimeout(i,Ss))]).then(()=>({type:f.localDescription.type,sdp:f.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return e?(c=r.createDataChannel("data"),h(c)):r.ondatachannel=({channel:f})=>{c=f,h(f)},r.onnegotiationneeded=async()=>{try{o=!0,await r.setLocalDescription();const f=await p(r);a.signal?.(f)}catch(f){a.error?.(f)}finally{o=!1}},r.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(r.connectionState)&&a.close?.()},r.ontrack=f=>{a.track?.(f.track,f.streams[0]),a.stream?.(f.streams[0])},r.onremovestream=f=>a.stream?.(f.stream),e&&(r.canTrickleIceCandidates||r.onnegotiationneeded()),{created:Date.now(),connection:r,get channel(){return c},get isDead(){return r.connectionState==="closed"},async signal(f){if(!(c?.readyState==="open"&&!f.sdp?.includes("a=rtpmap")))try{if(f.type===fn){if(o||r.signalingState!=="stable"&&!l){if(e)return;await Te([r.setLocalDescription({type:"rollback"}),r.setRemoteDescription(f)])}else await r.setRemoteDescription(f);await r.setLocalDescription();const i=await p(r);return a.signal?.(i),i}else if(f.type===Ts){l=!0;try{await r.setRemoteDescription(f)}finally{l=!1}}}catch(i){a.error?.(i)}},sendData:f=>c.send(f),destroy:()=>{c?.close(),r.close(),o=!1,l=!1},setHandlers:f=>Object.assign(a,f),offerPromise:e?new Promise(f=>a.signal=i=>{i.type===fn&&f(i)}):Promise.resolve(),addStream:f=>f.getTracks().forEach(i=>r.addTrack(i,f)),removeStream:f=>r.getSenders().filter(i=>f.getTracks().includes(i.track)).forEach(i=>r.removeTrack(i)),addTrack:(f,i)=>r.addTrack(f,i),removeTrack:f=>{const i=r.getSenders().find(m=>m.track===f);i&&r.removeTrack(i)},replaceTrack:(f,i)=>{const m=r.getSenders().find(S=>S.track===f);if(m)return m.replaceTrack(i)}}},ks=[...ct(3,(e,t)=>`stun:stun${t||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(e=>({urls:e})),xs=Object.getPrototypeOf(Uint8Array),St=12,qn=0,Tt=qn+St,kt=Tt+1,st=kt+1,rt=st+1,Me=16*2**10-rt,At=255,hn="bufferedamountlow",Le=e=>"@_"+e,Os=(e,t,n)=>{const s={},r={},a={},o={},l={},c={},h={},p={onPeerJoin:he,onPeerLeave:he,onPeerStream:he,onPeerTrack:he},f=(d,y)=>(d?Array.isArray(d)?d:[d]:cs(s)).flatMap(T=>{const C=s[T];return C?y(T,C):(console.warn(`${lt}: no peer with id ${T} found`),[])}),i=d=>{s[d]&&(s[d].destroy(),delete s[d],delete o[d],delete l[d],p.onPeerLeave(d),t(d))},m=d=>{if(r[d])return a[d];if(!d)throw de("action type argument is required");const y=He(d);if(y.byteLength>St)throw de(`action type string "${d}" (${y.byteLength}b) exceeds byte limit (${St}). Hint: choose a shorter name.`);const T=new Uint8Array(St);T.set(y);let C=0;return r[d]={onComplete:he,onProgress:he,setOnComplete:q=>r[d]={...r[d],onComplete:q},setOnProgress:q=>r[d]={...r[d],onProgress:q},send:async(q,v,E,$)=>{if(E&&typeof E!="object")throw de("action meta argument must be an object");const Z=typeof q;if(Z==="undefined")throw de("action data cannot be undefined");const W=Z!=="string",ie=q instanceof Blob,L=ie||q instanceof ArrayBuffer||q instanceof xs;if(E&&!L)throw de("action meta argument can only be used with binary data");const X=L?new Uint8Array(ie?await q.arrayBuffer():q):He(W?ut(q):q),ae=E?He(ut(E)):null,B=Math.ceil(X.byteLength/Me)+(E?1:0)||1,z=ct(B,(K,Y)=>{const le=Y===B-1,ce=E&&Y===0,ue=new Uint8Array(rt+(ce?ae.byteLength:le?X.byteLength-Me*(B-(E?2:1)):Me));return ue.set(T),ue.set([C],Tt),ue.set([le|ce<<1|L<<2|W<<3],kt),ue.set([Math.round((Y+1)/B*At)],st),ue.set(E?ce?ae:X.subarray((Y-1)*Me,Y*Me):X.subarray(Y*Me,(Y+1)*Me),rt),ue});return C=C+1&At,Te(f(v,async(K,Y)=>{const{channel:le}=Y;let ce=0;for(;ce<B;){const ue=z[ce];if(le.bufferedAmount>le.bufferedAmountLowThreshold&&await new Promise(Zn=>{const an=()=>{le.removeEventListener(hn,an),Zn()};le.addEventListener(hn,an)}),!s[K])break;Y.sendData(ue),ce++,$?.(ue[st]/At,K,E)}}))}},a[d]||=[r[d].send,r[d].setOnComplete,r[d].setOnProgress]},S=(d,y)=>{const T=new Uint8Array(y),C=Mt(T.subarray(qn,Tt)).replaceAll("\0",""),[q]=T.subarray(Tt,kt),[v]=T.subarray(kt,st),[E]=T.subarray(st,rt),$=T.subarray(rt),Z=!!(v&1),W=!!(v&2),ie=!!(v&4),L=!!(v&8);if(!r[C]){console.warn(`${lt}: received message with unregistered type (${C})`);return}o[d]||={},o[d][C]||={};const X=o[d][C][q]||={chunks:[]};if(W?X.meta=ft(Mt($)):X.chunks.push($),r[C].onProgress(E/At,d,X.meta),!Z)return;const ae=new Uint8Array(X.chunks.reduce((B,z)=>B+z.byteLength,0));if(X.chunks.reduce((B,z)=>(ae.set(z,B),B+z.byteLength),0),delete o[d][C][q],ie)r[C].onComplete(ae,d,X.meta);else{const B=Mt(ae);r[C].onComplete(L?ft(B):B,d)}},u=async()=>{await x(""),await new Promise(d=>setTimeout(d,99)),Ft(s).forEach(([d,y])=>{y.destroy(),delete s[d]}),n()},[g,_]=m(Le("ping")),[H,I]=m(Le("pong")),[M,N]=m(Le("signal")),[P,R]=m(Le("stream")),[J,b]=m(Le("track")),[x,se]=m(Le("leave"));return e((d,y)=>{s[y]||(s[y]=d,d.setHandlers({data:T=>S(y,T),stream:T=>{p.onPeerStream(T,y,c[y]),delete c[y]},track:(T,C)=>{p.onPeerTrack(T,C,y,h[y]),delete h[y]},signal:T=>M(T,y),close:()=>i(y),error:T=>{console.error(T),i(y)}}),p.onPeerJoin(y))}),_((d,y)=>H("",y)),I((d,y)=>{l[y]?.(),delete l[y]}),N((d,y)=>s[y]?.signal(d)),R((d,y)=>c[y]=d),b((d,y)=>h[y]=d),se((d,y)=>i(y)),Nn&&addEventListener("beforeunload",u),{makeAction:m,leave:u,ping:async d=>{if(!d)throw de("ping() must be called with target peer ID");const y=Date.now();return g("",d),await new Promise(T=>l[d]=T),Date.now()-y},getPeers:()=>Ln(Ft(s).map(([d,y])=>[d,y.connection])),addStream:(d,y,T)=>f(y,async(C,q)=>{T&&await P(T,C),q.addStream(d)}),removeStream:(d,y)=>f(y,(T,C)=>C.removeStream(d)),addTrack:(d,y,T,C)=>f(T,async(q,v)=>{C&&await J(C,q),v.addTrack(d,y)}),removeTrack:(d,y)=>f(y,(T,C)=>C.removeTrack(d)),replaceTrack:(d,y,T,C)=>f(T,async(q,v)=>{C&&await J(C,q),v.replaceTrack(d,y)}),onPeerJoin:d=>p.onPeerJoin=d,onPeerLeave:d=>p.onPeerLeave=d,onPeerStream:d=>p.onPeerStream=d,onPeerTrack:d=>p.onPeerTrack=d}},Cs=20,Rs=5333,dn=57333,_s=({init:e,subscribe:t,announce:n})=>{const s={};let r=!1,a,o,l,c;return(h,p,f)=>{const{appId:i}=h;if(s[i]?.[p])return s[i][p];const m={},S={},u=wt(lt,i,p),g=nt(u),_=nt(wt(u,Ue)),H=As(h.password||"",i,p),I=v=>async E=>({type:E.type,sdp:await v(H,E.sdp)}),M=I(Ms),N=I(Es),P=()=>pn(!0,h),R=(v,E,$)=>{if(S[E]){S[E]!==v&&v.destroy();return}S[E]=v,q(v,E),m[E]?.forEach((Z,W)=>{W!==$&&Z.destroy()}),delete m[E]},J=(v,E)=>{S[E]===v&&delete S[E]},b=(v,E)=>{if(S[v])return;const $=m[v]?.[E];$&&(delete m[v][E],$.destroy())},x=v=>(o.push(...ct(v,P)),Te(o.splice(0,v).map(E=>E.offerPromise.then(N).then($=>({peer:E,offer:$}))))),se=(v,E)=>f?.({error:`incorrect password (${h.password}) when decrypting ${E}`,appId:i,peerId:v,roomId:p}),d=v=>async(E,$,Z)=>{const[W,ie]=await Te([g,_]);if(E!==W&&E!==ie)return;const{peerId:L,offer:X,answer:ae,peer:B}=typeof $=="string"?ft($):$;if(!(L===Ue||S[L])){if(L&&!X&&!ae){if(m[L]?.[v])return;const[[{peer:z,offer:K}],Y]=await Te([x(1),nt(wt(u,L))]);m[L]||=[],m[L][v]=z,setTimeout(()=>b(L,v),y[v]*.9),z.setHandlers({connect:()=>R(z,L,v),close:()=>J(z,L)}),Z(Y,ut({peerId:Ue,offer:K}))}else if(X){if(m[L]?.[v]&&Ue>L)return;const K=pn(!1,h);K.setHandlers({connect:()=>R(K,L,v),close:()=>J(K,L)});let Y;try{Y=await M(X)}catch{se(L,"offer");return}if(K.isDead)return;const[le,ce]=await Te([nt(wt(u,L)),K.signal(Y)]);Z(le,ut({peerId:Ue,answer:await N(ce)}))}else if(ae){let z;try{z=await M(ae)}catch{se(L,"answer");return}if(B)B.setHandlers({connect:()=>R(B,L,v),close:()=>J(B,L)}),B.signal(z);else{const K=m[L]?.[v];K&&!K.isDead&&K.signal(z)}}}};if(!h)throw de("requires a config map as the first argument");if(!i&&!h.firebaseApp)throw de("config map is missing appId field");if(!p)throw de("roomId argument required");if(!r){const v=e(h);o=ct(Cs,P),a=Array.isArray(v)?v:[v],r=!0,l=setInterval(()=>o=o.filter(E=>{const $=Date.now()-E.created<dn;return $||E.destroy(),$}),dn*1.03),c=h.manualRelayReconnection?he:gs()}const y=a.map(()=>Rs),T=[],C=a.map(async(v,E)=>t(await v,await g,await _,d(E),x));Te([g,_]).then(([v,E])=>{const $=async(Z,W)=>{const ie=await n(Z,v,E);typeof ie=="number"&&(y[W]=ie),T[W]=setTimeout(()=>$(Z,W),y[W])};C.forEach(async(Z,W)=>{await Z,$(await a[W],W)})});let q=he;return s[i]||={},s[i][p]=Os(v=>q=v,v=>delete S[v],()=>{delete s[i][p],T.forEach(clearTimeout),C.forEach(async v=>(await v)()),clearInterval(l),c(),r=!1})}},qt={},Hn={},Ze={},et={},tt={},mn={},Et={},Is="announce",Vn=20,gn=10,Ps=33333,Ns=120333,Ls=3,Us=async e=>{if(qt[e])return qt[e];const t=(await nt(e)).slice(0,Vn);return qt[e]=t,Hn[t]=e,t},yn=async(e,t,n)=>e.send(ut({action:Is,info_hash:await Us(t),peer_id:Ue,...n})),vn=(e,t,n)=>console.warn(`${lt}: torrent tracker ${n?"failure":"warning"} from ${e} - ${t}`),$n=_s({init:e=>ps(e,Ds,Ls).map(t=>{const n=ms(t,r=>{const a=ft(r),o=a["failure reason"],l=a["warning message"],{interval:c}=a,h=Hn[a.info_hash];if(o){vn(s,o,!0);return}if(l&&vn(s,l),c&&c*1e3>tt[s]&&et[s][h]){const p=Math.min(c*1e3,Ns);clearInterval(Ze[s][h]),tt[s]=p,Ze[s][h]=setInterval(et[s][h],p)}mn[a.offer_id]||(a.offer||a.answer)&&(mn[a.offer_id]=!0,Et[s][h]?.(a))}),{url:s}=n;return Et[s]={},n.ready}),subscribe:(e,t,n,s,r)=>{const{url:a}=e,o=async()=>{const l=Ln((await r(gn)).map(c=>[Pn(Vn),c]));Et[e.url][t]=c=>{if(c.offer)s(t,{offer:c.offer,peerId:c.peer_id},(h,p)=>yn(e,t,{answer:ft(p).answer,offer_id:c.offer_id,to_peer_id:c.peer_id}));else if(c.answer){const h=l[c.offer_id];h&&s(t,{answer:c.answer,peerId:c.peer_id,peer:h.peer})}},yn(e,t,{numwant:gn,offers:Ft(l).map(([c,{offer:h}])=>({offer_id:c,offer:h}))})};return tt[a]=Ps,et[a]||={},et[a][t]=o,Ze[a]||={},Ze[a][t]=setInterval(o,tt[a]),o(),()=>{clearInterval(Ze[a][t]),delete Et[a][t],delete et[a][t]}},announce:e=>tt[e.url]}),Ds=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(e=>"wss://"+e);var ne="INUMBER",We="IOP1",ze="IOP2",Ke="IOP3",ye="IVAR",_e="IVARNAME",Be="IFUNCALL",Ot="IFUNDEF",ee="IEXPR",zt="IEXPREVAL",Ie="IMEMBER",Ct="IENDSTATEMENT",je="IARRAY";function O(e,t){this.type=e,this.value=t??0}O.prototype.toString=function(){switch(this.type){case ne:case We:case ze:case Ke:case ye:case _e:case Ct:return this.value;case Be:return"CALL "+this.value;case Ot:return"DEF "+this.value;case je:return"ARRAY "+this.value;case Ie:return"."+this.value;default:return"Invalid Instruction"}};function Rt(e){return new O(We,e)}function we(e){return new O(ze,e)}function Fn(e){return new O(Ke,e)}function jt(e,t,n,s,r){for(var a=[],o=[],l,c,h,p,f=0;f<e.length;f++){var i=e[f],m=i.type;if(m===ne||m===_e)Array.isArray(i.value)?a.push.apply(a,jt(i.value.map(function(S){return new O(ne,S)}).concat(new O(je,i.value.length)),t,n,s,r)):a.push(i);else if(m===ye&&r.hasOwnProperty(i.value))i=new O(ne,r[i.value]),a.push(i);else if(m===ze&&a.length>1)c=a.pop(),l=a.pop(),p=n[i.value],i=new O(ne,p(l.value,c.value)),a.push(i);else if(m===Ke&&a.length>2)h=a.pop(),c=a.pop(),l=a.pop(),i.value==="?"?a.push(l.value?c.value:h.value):(p=s[i.value],i=new O(ne,p(l.value,c.value,h.value)),a.push(i));else if(m===We&&a.length>0)l=a.pop(),p=t[i.value],i=new O(ne,p(l.value)),a.push(i);else if(m===ee){for(;a.length>0;)o.push(a.shift());o.push(new O(ee,jt(i.value,t,n,s,r)))}else if(m===Ie&&a.length>0)l=a.pop(),a.push(new O(ne,l.value[i.value]));else{for(;a.length>0;)o.push(a.shift());o.push(i)}}for(;a.length>0;)o.push(a.shift());return o}function Bn(e,t,n){for(var s=[],r=0;r<e.length;r++){var a=e[r],o=a.type;if(o===ye&&a.value===t)for(var l=0;l<n.tokens.length;l++){var c=n.tokens[l],h;c.type===We?h=Rt(c.value):c.type===ze?h=we(c.value):c.type===Ke?h=Fn(c.value):h=new O(c.type,c.value),s.push(h)}else o===ee?s.push(new O(ee,Bn(a.value,t,n))):s.push(a)}return s}function ke(e,t,n){var s=[],r,a,o,l,c,h;if(Kt(e))return fe(e,n);for(var p=e.length,f=0;f<p;f++){var i=e[f],m=i.type;if(m===ne||m===_e)s.push(i.value);else if(m===ze)a=s.pop(),r=s.pop(),i.value==="and"?s.push(r?!!ke(a,t,n):!1):i.value==="or"?s.push(r?!0:!!ke(a,t,n)):i.value==="="?(l=t.binaryOps[i.value],s.push(l(r,ke(a,t,n),n))):(l=t.binaryOps[i.value],s.push(l(fe(r,n),fe(a,n))));else if(m===Ke)o=s.pop(),a=s.pop(),r=s.pop(),i.value==="?"?s.push(ke(r?a:o,t,n)):(l=t.ternaryOps[i.value],s.push(l(fe(r,n),fe(a,n),fe(o,n))));else if(m===ye)if(i.value in t.functions)s.push(t.functions[i.value]);else if(i.value in t.unaryOps&&t.parser.isOperatorEnabled(i.value))s.push(t.unaryOps[i.value]);else{var S=n[i.value];if(S!==void 0)s.push(S);else throw new Error("undefined variable: "+i.value)}else if(m===We)r=s.pop(),l=t.unaryOps[i.value],s.push(l(fe(r,n)));else if(m===Be){for(h=i.value,c=[];h-- >0;)c.unshift(fe(s.pop(),n));if(l=s.pop(),l.apply&&l.call)s.push(l.apply(void 0,c));else throw new Error(l+" is not a function")}else if(m===Ot)s.push((function(){for(var u=s.pop(),g=[],_=i.value;_-- >0;)g.unshift(s.pop());var H=s.pop(),I=function(){for(var M=Object.assign({},n),N=0,P=g.length;N<P;N++)M[g[N]]=arguments[N];return ke(u,t,M)};return Object.defineProperty(I,"name",{value:H,writable:!1}),n[H]=I,I})());else if(m===ee)s.push(qs(i,t));else if(m===zt)s.push(i);else if(m===Ie)r=s.pop(),s.push(r[i.value]);else if(m===Ct)s.pop();else if(m===je){for(h=i.value,c=[];h-- >0;)c.unshift(s.pop());s.push(c)}else throw new Error("invalid Expression")}if(s.length>1)throw new Error("invalid Expression (parity)");return s[0]===0?0:fe(s[0],n)}function qs(e,t,n){return Kt(e)?e:{type:zt,value:function(s){return ke(e.value,t,s)}}}function Kt(e){return e&&e.type===zt}function fe(e,t){return Kt(e)?e.value(t):e}function Xt(e,t){for(var n=[],s,r,a,o,l,c,h=0;h<e.length;h++){var p=e[h],f=p.type;if(f===ne)typeof p.value=="number"&&p.value<0?n.push("("+p.value+")"):Array.isArray(p.value)?n.push("["+p.value.map(wn).join(", ")+"]"):n.push(wn(p.value));else if(f===ze)r=n.pop(),s=n.pop(),o=p.value,t?o==="^"?n.push("Math.pow("+s+", "+r+")"):o==="and"?n.push("(!!"+s+" && !!"+r+")"):o==="or"?n.push("(!!"+s+" || !!"+r+")"):o==="||"?n.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+s+"),("+r+")))"):o==="=="?n.push("("+s+" === "+r+")"):o==="!="?n.push("("+s+" !== "+r+")"):o==="["?n.push(s+"[("+r+") | 0]"):n.push("("+s+" "+o+" "+r+")"):o==="["?n.push(s+"["+r+"]"):n.push("("+s+" "+o+" "+r+")");else if(f===Ke)if(a=n.pop(),r=n.pop(),s=n.pop(),o=p.value,o==="?")n.push("("+s+" ? "+r+" : "+a+")");else throw new Error("invalid Expression");else if(f===ye||f===_e)n.push(p.value);else if(f===We)s=n.pop(),o=p.value,o==="-"||o==="+"?n.push("("+o+s+")"):t?o==="not"?n.push("(!"+s+")"):o==="!"?n.push("fac("+s+")"):n.push(o+"("+s+")"):o==="!"?n.push("("+s+"!)"):n.push("("+o+" "+s+")");else if(f===Be){for(c=p.value,l=[];c-- >0;)l.unshift(n.pop());o=n.pop(),n.push(o+"("+l.join(", ")+")")}else if(f===Ot){for(r=n.pop(),c=p.value,l=[];c-- >0;)l.unshift(n.pop());s=n.pop(),t?n.push("("+s+" = function("+l.join(", ")+") { return "+r+" })"):n.push("("+s+"("+l.join(", ")+") = "+r+")")}else if(f===Ie)s=n.pop(),n.push(s+"."+p.value);else if(f===je){for(c=p.value,l=[];c-- >0;)l.unshift(n.pop());n.push("["+l.join(", ")+"]")}else if(f===ee)n.push("("+Xt(p.value,t)+")");else if(f!==Ct)throw new Error("invalid Expression")}return n.length>1&&(t?n=[n.join(",")]:n=[n.join(";")]),String(n[0])}function wn(e){return typeof e=="string"?JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):e}function De(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1}function Yt(e,t,n){n=n||{};for(var s=!!n.withMembers,r=null,a=0;a<e.length;a++){var o=e[a];o.type===ye||o.type===_e?!s&&!De(t,o.value)?t.push(o.value):(r!==null&&(De(t,r)||t.push(r)),r=o.value):o.type===Ie&&s&&r!==null?r+="."+o.value:o.type===ee?Yt(o.value,t,n):r!==null&&(De(t,r)||t.push(r),r=null)}r!==null&&!De(t,r)&&t.push(r)}function re(e,t){this.tokens=e,this.parser=t,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.functions=t.functions}re.prototype.simplify=function(e){return e=e||{},new re(jt(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,e),this.parser)};re.prototype.substitute=function(e,t){return t instanceof re||(t=this.parser.parse(String(t))),new re(Bn(this.tokens,e,t),this.parser)};re.prototype.evaluate=function(e){return e=e||{},ke(this.tokens,this,e)};re.prototype.toString=function(){return Xt(this.tokens,!1)};re.prototype.symbols=function(e){e=e||{};var t=[];return Yt(this.tokens,t,e),t};re.prototype.variables=function(e){e=e||{};var t=[];Yt(this.tokens,t,e);var n=this.functions;return t.filter(function(s){return!(s in n)})};re.prototype.toJSFunction=function(e,t){var n=this,s=new Function(e,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+Xt(this.simplify(t).tokens,!0)+"; }");return function(){return s.apply(n,arguments)}};var pt="TEOF",U="TOP",_t="TNUMBER",jn="TSTRING",ve="TPAREN",Je="TBRACKET",It="TCOMMA",Qt="TNAME",Zt="TSEMICOLON";function Jn(e,t,n){this.type=e,this.value=t,this.index=n}Jn.prototype.toString=function(){return this.type+": "+this.value};function V(e,t){this.pos=0,this.current=null,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.consts=e.consts,this.expression=t,this.savedPosition=0,this.savedCurrent=null,this.options=e.options,this.parser=e}V.prototype.newToken=function(e,t,n){return new Jn(e,t,n??this.pos)};V.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};V.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};V.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(pt,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};V.prototype.isString=function(){var e=!1,t=this.pos,n=this.expression.charAt(t);if(n==="'"||n==='"')for(var s=this.expression.indexOf(n,t+1);s>=0&&this.pos<this.expression.length;){if(this.pos=s+1,this.expression.charAt(s-1)!=="\\"){var r=this.expression.substring(t+1,s);this.current=this.newToken(jn,this.unescape(r),t),e=!0;break}s=this.expression.indexOf(n,s+1)}return e};V.prototype.isParen=function(){var e=this.expression.charAt(this.pos);return e==="("||e===")"?(this.current=this.newToken(ve,e),this.pos++,!0):!1};V.prototype.isBracket=function(){var e=this.expression.charAt(this.pos);return(e==="["||e==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(Je,e),this.pos++,!0):!1};V.prototype.isComma=function(){var e=this.expression.charAt(this.pos);return e===","?(this.current=this.newToken(It,","),this.pos++,!0):!1};V.prototype.isSemicolon=function(){var e=this.expression.charAt(this.pos);return e===";"?(this.current=this.newToken(Zt,";"),this.pos++,!0):!1};V.prototype.isConst=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()&&(t===this.pos||n!=="_"&&n!=="."&&(n<"0"||n>"9")))break}if(t>e){var s=this.expression.substring(e,t);if(s in this.consts)return this.current=this.newToken(_t,this.consts[s]),this.pos+=s.length,!0}return!1};V.prototype.isNamedOp=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()&&(t===this.pos||n!=="_"&&(n<"0"||n>"9")))break}if(t>e){var s=this.expression.substring(e,t);if(this.isOperatorEnabled(s)&&(s in this.binaryOps||s in this.unaryOps||s in this.ternaryOps))return this.current=this.newToken(U,s),this.pos+=s.length,!0}return!1};V.prototype.isName=function(){for(var e=this.pos,t=e,n=!1;t<this.expression.length;t++){var s=this.expression.charAt(t);if(s.toUpperCase()===s.toLowerCase()){if(t===this.pos&&(s==="$"||s==="_")){s==="_"&&(n=!0);continue}else if(t===this.pos||!n||s!=="_"&&(s<"0"||s>"9"))break}else n=!0}if(n){var r=this.expression.substring(e,t);return this.current=this.newToken(Qt,r),this.pos+=r.length,!0}return!1};V.prototype.isWhitespace=function(){for(var e=!1,t=this.expression.charAt(this.pos);(t===" "||t==="	"||t===`
`||t==="\r")&&(e=!0,this.pos++,!(this.pos>=this.expression.length));)t=this.expression.charAt(this.pos);return e};var Hs=/^[0-9a-f]{4}$/i;V.prototype.unescape=function(e){var t=e.indexOf("\\");if(t<0)return e;for(var n=e.substring(0,t);t>=0;){var s=e.charAt(++t);switch(s){case"'":n+="'";break;case'"':n+='"';break;case"\\":n+="\\";break;case"/":n+="/";break;case"b":n+="\b";break;case"f":n+="\f";break;case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"u":var r=e.substring(t+1,t+5);Hs.test(r)||this.parseError("Illegal escape sequence: \\u"+r),n+=String.fromCharCode(parseInt(r,16)),t+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+s+'"')}++t;var a=e.indexOf("\\",t);n+=e.substring(t,a<0?e.length:a),t=a}return n};V.prototype.isComment=function(){var e=this.expression.charAt(this.pos);return e==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};V.prototype.isRadixInteger=function(){var e=this.pos;if(e>=this.expression.length-2||this.expression.charAt(e)!=="0")return!1;++e;var t,n;if(this.expression.charAt(e)==="x")t=16,n=/^[0-9a-f]$/i,++e;else if(this.expression.charAt(e)==="b")t=2,n=/^[01]$/i,++e;else return!1;for(var s=!1,r=e;e<this.expression.length;){var a=this.expression.charAt(e);if(n.test(a))e++,s=!0;else break}return s&&(this.current=this.newToken(_t,parseInt(this.expression.substring(r,e),t)),this.pos=e),s};V.prototype.isNumber=function(){for(var e=!1,t=this.pos,n=t,s=t,r=!1,a=!1,o;t<this.expression.length&&(o=this.expression.charAt(t),o>="0"&&o<="9"||!r&&o===".");)o==="."?r=!0:a=!0,t++,e=a;if(e&&(s=t),o==="e"||o==="E"){t++;for(var l=!0,c=!1;t<this.expression.length;){if(o=this.expression.charAt(t),l&&(o==="+"||o==="-"))l=!1;else if(o>="0"&&o<="9")c=!0,l=!1;else break;t++}c||(t=s)}return e?(this.current=this.newToken(_t,parseFloat(this.expression.substring(n,t))),this.pos=t):this.pos=s,e};V.prototype.isOperator=function(){var e=this.pos,t=this.expression.charAt(this.pos);if(t==="+"||t==="-"||t==="*"||t==="/"||t==="%"||t==="^"||t==="?"||t===":"||t===".")this.current=this.newToken(U,t);else if(t==="∙"||t==="•")this.current=this.newToken(U,"*");else if(t===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(U,">="),this.pos++):this.current=this.newToken(U,">");else if(t==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(U,"<="),this.pos++):this.current=this.newToken(U,"<");else if(t==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(U,"||"),this.pos++;else return!1;else if(t==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(U,"=="),this.pos++):this.current=this.newToken(U,t);else if(t==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(U,"!="),this.pos++):this.current=this.newToken(U,t);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=e,!1)};V.prototype.isOperatorEnabled=function(e){return this.parser.isOperatorEnabled(e)};V.prototype.getCoordinates=function(){var e=0,t,n=-1;do e++,t=this.pos-n,n=this.expression.indexOf(`
`,n+1);while(n>=0&&n<this.pos);return{line:e,column:t}};V.prototype.parseError=function(e){var t=this.getCoordinates();throw new Error("parse error ["+t.line+":"+t.column+"]: "+e)};function D(e,t,n){this.parser=e,this.tokens=t,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=n.allowMemberAccess!==!1}D.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};D.prototype.tokenMatches=function(e,t){return typeof t>"u"?!0:Array.isArray(t)?De(t,e.value):typeof t=="function"?t(e):e.value===t};D.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};D.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};D.prototype.accept=function(e,t){return this.nextToken.type===e&&this.tokenMatches(this.nextToken,t)?(this.next(),!0):!1};D.prototype.expect=function(e,t){if(!this.accept(e,t)){var n=this.tokens.getCoordinates();throw new Error("parse error ["+n.line+":"+n.column+"]: Expected "+(t||e))}};D.prototype.parseAtom=function(e){var t=this.tokens.unaryOps;function n(r){return r.value in t}if(this.accept(Qt)||this.accept(U,n))e.push(new O(ye,this.current.value));else if(this.accept(_t))e.push(new O(ne,this.current.value));else if(this.accept(jn))e.push(new O(ne,this.current.value));else if(this.accept(ve,"("))this.parseExpression(e),this.expect(ve,")");else if(this.accept(Je,"["))if(this.accept(Je,"]"))e.push(new O(je,0));else{var s=this.parseArrayList(e);e.push(new O(je,s))}else throw new Error("unexpected "+this.nextToken)};D.prototype.parseExpression=function(e){var t=[];this.parseUntilEndStatement(e,t)||(this.parseVariableAssignmentExpression(t),!this.parseUntilEndStatement(e,t)&&this.pushExpression(e,t))};D.prototype.pushExpression=function(e,t){for(var n=0,s=t.length;n<s;n++)e.push(t[n])};D.prototype.parseUntilEndStatement=function(e,t){return this.accept(Zt)?(this.nextToken&&this.nextToken.type!==pt&&!(this.nextToken.type===ve&&this.nextToken.value===")")&&t.push(new O(Ct)),this.nextToken.type!==pt&&this.parseExpression(t),e.push(new O(ee,t)),!0):!1};D.prototype.parseArrayList=function(e){for(var t=0;!this.accept(Je,"]");)for(this.parseExpression(e),++t;this.accept(It);)this.parseExpression(e),++t;return t};D.prototype.parseVariableAssignmentExpression=function(e){for(this.parseConditionalExpression(e);this.accept(U,"=");){var t=e.pop(),n=[],s=e.length-1;if(t.type===Be){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var r=0,a=t.value+1;r<a;r++){var o=s-r;e[o].type===ye&&(e[o]=new O(_e,e[o].value))}this.parseVariableAssignmentExpression(n),e.push(new O(ee,n)),e.push(new O(Ot,t.value));continue}if(t.type!==ye&&t.type!==Ie)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(n),e.push(new O(_e,t.value)),e.push(new O(ee,n)),e.push(we("="))}};D.prototype.parseConditionalExpression=function(e){for(this.parseOrExpression(e);this.accept(U,"?");){var t=[],n=[];this.parseConditionalExpression(t),this.expect(U,":"),this.parseConditionalExpression(n),e.push(new O(ee,t)),e.push(new O(ee,n)),e.push(Fn("?"))}};D.prototype.parseOrExpression=function(e){for(this.parseAndExpression(e);this.accept(U,"or");){var t=[];this.parseAndExpression(t),e.push(new O(ee,t)),e.push(we("or"))}};D.prototype.parseAndExpression=function(e){for(this.parseComparison(e);this.accept(U,"and");){var t=[];this.parseComparison(t),e.push(new O(ee,t)),e.push(we("and"))}};var Vs=["==","!=","<","<=",">=",">","in"];D.prototype.parseComparison=function(e){for(this.parseAddSub(e);this.accept(U,Vs);){var t=this.current;this.parseAddSub(e),e.push(we(t.value))}};var $s=["+","-","||"];D.prototype.parseAddSub=function(e){for(this.parseTerm(e);this.accept(U,$s);){var t=this.current;this.parseTerm(e),e.push(we(t.value))}};var Fs=["*","/","%"];D.prototype.parseTerm=function(e){for(this.parseFactor(e);this.accept(U,Fs);){var t=this.current;this.parseFactor(e),e.push(we(t.value))}};D.prototype.parseFactor=function(e){var t=this.tokens.unaryOps;function n(r){return r.value in t}if(this.save(),this.accept(U,n)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===ve&&this.nextToken.value==="("){this.restore(),this.parseExponential(e);return}else if(this.nextToken.type===Zt||this.nextToken.type===It||this.nextToken.type===pt||this.nextToken.type===ve&&this.nextToken.value===")"){this.restore(),this.parseAtom(e);return}}var s=this.current;this.parseFactor(e),e.push(Rt(s.value))}else this.parseExponential(e)};D.prototype.parseExponential=function(e){for(this.parsePostfixExpression(e);this.accept(U,"^");)this.parseFactor(e),e.push(we("^"))};D.prototype.parsePostfixExpression=function(e){for(this.parseFunctionCall(e);this.accept(U,"!");)e.push(Rt("!"))};D.prototype.parseFunctionCall=function(e){var t=this.tokens.unaryOps;function n(a){return a.value in t}if(this.accept(U,n)){var s=this.current;this.parseAtom(e),e.push(Rt(s.value))}else for(this.parseMemberExpression(e);this.accept(ve,"(");)if(this.accept(ve,")"))e.push(new O(Be,0));else{var r=this.parseArgumentList(e);e.push(new O(Be,r))}};D.prototype.parseArgumentList=function(e){for(var t=0;!this.accept(ve,")");)for(this.parseExpression(e),++t;this.accept(It);)this.parseExpression(e),++t;return t};D.prototype.parseMemberExpression=function(e){for(this.parseAtom(e);this.accept(U,".")||this.accept(Je,"[");){var t=this.current;if(t.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(Qt),e.push(new O(Ie,this.current.value))}else if(t.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(e),this.expect(Je,"]"),e.push(we("["))}else throw new Error("unexpected symbol: "+t.value)}};function Bs(e,t){return Number(e)+Number(t)}function js(e,t){return e-t}function Js(e,t){return e*t}function Gs(e,t){return e/t}function Ws(e,t){return e%t}function zs(e,t){return Array.isArray(e)&&Array.isArray(t)?e.concat(t):""+e+t}function Ks(e,t){return e===t}function Xs(e,t){return e!==t}function Ys(e,t){return e>t}function Qs(e,t){return e<t}function Zs(e,t){return e>=t}function er(e,t){return e<=t}function tr(e,t){return!!(e&&t)}function nr(e,t){return!!(e||t)}function sr(e,t){return De(t,e)}function rr(e){return(Math.exp(e)-Math.exp(-e))/2}function ar(e){return(Math.exp(e)+Math.exp(-e))/2}function or(e){return e===1/0?1:e===-1/0?-1:(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function ir(e){return e===-1/0?e:Math.log(e+Math.sqrt(e*e+1))}function lr(e){return Math.log(e+Math.sqrt(e*e-1))}function cr(e){return Math.log((1+e)/(1-e))/2}function bn(e){return Math.log(e)*Math.LOG10E}function ur(e){return-e}function fr(e){return!e}function pr(e){return e<0?Math.ceil(e):Math.floor(e)}function hr(e){return Math.random()*(e||1)}function An(e){return en(e+1)}function dr(e){return isFinite(e)&&e===Math.round(e)}var mr=4.7421875,Ht=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function en(e){var t,n;if(dr(e)){if(e<=0)return isFinite(e)?1/0:NaN;if(e>171)return 1/0;for(var s=e-2,r=e-1;s>1;)r*=s,s--;return r===0&&(r=1),r}if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*en(1-e));if(e>=171.35)return 1/0;if(e>85){var a=e*e,o=a*e,l=o*e,c=l*e;return Math.sqrt(2*Math.PI/e)*Math.pow(e/Math.E,e)*(1+1/(12*e)+1/(288*a)-139/(51840*o)-571/(2488320*l)+163879/(209018880*c)+5246819/(75246796800*c*e))}--e,n=Ht[0];for(var h=1;h<Ht.length;++h)n+=Ht[h]/(e+h);return t=e+mr+.5,Math.sqrt(2*Math.PI)*Math.pow(t,e+.5)*Math.exp(-t)*n}function gr(e){return Array.isArray(e)?e.length:String(e).length}function En(){for(var e=0,t=0,n=0;n<arguments.length;n++){var s=Math.abs(arguments[n]),r;t<s?(r=t/s,e=e*r*r+1,t=s):s>0?(r=s/t,e+=r*r):e+=s}return t===1/0?1/0:t*Math.sqrt(e)}function Mn(e,t,n){return e?t:n}function yr(e,t){return typeof t>"u"||+t==0?Math.round(e):(e=+e,t=-+t,isNaN(e)||!(typeof t=="number"&&t%1===0)?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]+t:t))))}function vr(e,t,n){return n&&(n[e]=t),t}function wr(e,t){return e[t|0]}function br(e){return arguments.length===1&&Array.isArray(e)?Math.max.apply(Math,e):Math.max.apply(Math,arguments)}function Ar(e){return arguments.length===1&&Array.isArray(e)?Math.min.apply(Math,e):Math.min.apply(Math,arguments)}function Er(e,t){if(typeof e!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(t))throw new Error("Second argument to map is not an array");return t.map(function(n,s){return e(n,s)})}function Mr(e,t,n){if(typeof e!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(n))throw new Error("Second argument to fold is not an array");return n.reduce(function(s,r,a){return e(s,r,a)},t)}function Sr(e,t){if(typeof e!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(t))throw new Error("Second argument to filter is not an array");return t.filter(function(n,s){return e(n,s)})}function Tr(e,t){if(!(Array.isArray(t)||typeof t=="string"))throw new Error("Second argument to indexOf is not a string or array");return t.indexOf(e)}function kr(e,t){if(!Array.isArray(t))throw new Error("Second argument to join is not an array");return t.join(e)}function xr(e){return(e>0)-(e<0)||+e}var Sn=1/3;function Or(e){return e<0?-Math.pow(-e,Sn):Math.pow(e,Sn)}function Cr(e){return Math.exp(e)-1}function Rr(e){return Math.log(1+e)}function _r(e){return Math.log(e)/Math.LN2}function Ee(e){this.options=e||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||rr,cosh:Math.cosh||ar,tanh:Math.tanh||or,asinh:Math.asinh||ir,acosh:Math.acosh||lr,atanh:Math.atanh||cr,sqrt:Math.sqrt,cbrt:Math.cbrt||Or,log:Math.log,log2:Math.log2||_r,ln:Math.log,lg:Math.log10||bn,log10:Math.log10||bn,expm1:Math.expm1||Cr,log1p:Math.log1p||Rr,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||pr,"-":ur,"+":Number,exp:Math.exp,not:fr,length:gr,"!":An,sign:Math.sign||xr},this.binaryOps={"+":Bs,"-":js,"*":Js,"/":Gs,"%":Ws,"^":Math.pow,"||":zs,"==":Ks,"!=":Xs,">":Ys,"<":Qs,">=":Zs,"<=":er,and:tr,or:nr,in:sr,"=":vr,"[":wr},this.ternaryOps={"?":Mn},this.functions={random:hr,fac:An,min:Ar,max:br,hypot:Math.hypot||En,pyt:Math.hypot||En,pow:Math.pow,atan2:Math.atan2,if:Mn,gamma:en,roundTo:yr,map:Er,fold:Mr,filter:Sr,indexOf:Tr,join:kr},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}Ee.prototype.parse=function(e){var t=[],n=new D(this,new V(this,e),{allowMemberAccess:this.options.allowMemberAccess});return n.parseExpression(t),n.expect(pt,"EOF"),new re(t,this)};Ee.prototype.evaluate=function(e,t){return this.parse(e).evaluate(t)};var Gn=new Ee;Ee.parse=function(e){return Gn.parse(e)};Ee.evaluate=function(e,t){return Gn.parse(e).evaluate(t)};var Tn={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function Ir(e){return Tn.hasOwnProperty(e)?Tn[e]:e}Ee.prototype.isOperatorEnabled=function(e){var t=Ir(e),n=this.options.operators||{};return!(t in n)||!!n[t]};const ha={NEXT_ROLL:"Próxima Rolagem",ROUNDS:"Rodadas",MINUTES:"Minutos",HOURS:"Horas",DAYS:"Dias",LUCK_ENDS:"Sorte Encerra",PERMANENT:"Indeterminado",END_OF_ROUND:"Fim da Rodada",CONCENTRATION:"Concentração"},Ve={ADD:"ADD",SET:"SET",MULT:"MULT"},da={str:"Força",agi:"Agilidade",int:"Intelecto",wil:"Vontade",defense:"Defesa",speed:"Deslocamento",health:"Vida",damage:"Dano (Dados)",boons:"Boons/Banes",healing_rate:"Taxa de Cura"},be={WEAPON:"Weapon",ARMOR:"Armor",SHIELD:"Shield",CONSUMABLE:"Consumable",EXPLOSIVE:"Explosive",OTHER:"Other"},ma=["Aeromancy","Alchemy","Alteration","Animism","Astromancy","Chaos","Chronomancy","Conjuration","Cryomancy","Dark Arts","Destruction","Divination","Eldritch","Enchantment","Evocation","Geomancy","Hydromancy","Illusion","Invocation","Necromancy","Oneiromancy","Order","Primal","Protection","Psychomancy","Pyromancy","Shadowmancy","Skullduggery","Spiritualism","Symbolism","Technomancy","Teleportation","War"],Pr=[[1,0,0,0,0,0,0,0,0,0,0],[2,1,0,0,0,0,0,0,0,0,0],[3,2,1,0,0,0,0,0,0,0,0],[4,2,1,1,0,0,0,0,0,0,0],[5,2,2,1,1,0,0,0,0,0,0],[6,3,2,2,1,1,0,0,0,0,0],[7,3,2,2,2,1,1,0,0,0,0],[8,3,2,2,2,1,1,1,0,0,0],[9,3,3,2,2,2,1,1,1,0,0],[10,3,3,3,2,2,1,1,1,1,0],[11,3,3,3,3,2,1,1,1,1,1]],ga=["Air","Alteration","Arcana","Battle","Celestial","Chaos","Conjuration","Curse","Death","Demonology","Destruction","Divination","Enchantment","Ether","Fey","Fire","Forbidden","Illusion","Life","Metal","Nature","Necromancy","Order","Primal","Protection","Rune","Shadow","Song","Soul","Spiritualism","Storm","Technomancy","Telekinesis","Telepathy","Teleportation","Theurgy","Time","Transformation","Water"];function ya(e,t){return e<0||e>10||t<0||t>10?0:Pr[e]?.[t]??0}const Nr=new Ee,Wn={name:"",level:1,ancestry:"",paths:{novice:"",expert:"",master:""},attributes:[{name:"Strength",value:10,key:"str"},{name:"Agility",value:10,key:"agi"},{name:"Intellect",value:10,key:"int"},{name:"Will",value:10,key:"wil"}],currency:{gp:0,sp:0,cp:0},naturalDefense:10,bonusDamage:0,size:1,speed:10,currentRound:1,languages:[],professions:[],senses:[],afflictions:[],effects:[],notes:"",campaignId:null,campaignName:null,gmName:null,combatActive:!1,initiative:!1,acted:!1,spells:[],talents:[],equipment:[]},w=Q(JSON.parse(JSON.stringify(Wn))),it=Q([]),$e=Q({type:null,isOpen:!1,data:null}),Lr=Q("acoes"),Pt=Q(24),Pe=Q(24),Xe=Q(0),Ge=Q(!1),Nt=Q(!1),kn={autoOpenHistory:!1,stickyHistory:!1,theme:"dark",userName:"",enable3DDice:!1,diceTheme:"default"};function Ur(){const e=typeof localStorage<"u"?localStorage.getItem("wwv_app_settings"):null,{subscribe:t,set:n,update:s}=Q(e?{...kn,...JSON.parse(e)}:kn);return{subscribe:t,set:r=>{typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(r)),n(r)},update:r=>{s(a=>{const o=r(a);return typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(o)),o})}}}const tn=Ur();Ge.subscribe(e=>{e&&Nt.set(!1)});const Ye=j(w,e=>{const t=e.effects.filter(s=>s.isActive),n=e.talents.filter(s=>(s.isPassive||s.activityType==="Passive")&&s.effect).map(s=>({...s.effect,id:`talent-effect-${s.id}`,name:s.name,sourceType:"talent",sourceId:s.id}));return[...t,...n]});function Re(e,t){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim();if(!isNaN(Number(n)))return Number(n);try{const s={};Array.isArray(t.attributes)&&t.attributes.forEach(a=>{s[a.key]=a.value}),s.level=t.level||0,s.defense=t.naturalDefense||0,s.speed=t.speed||0,s.bonusDamage=t.bonusDamage||0,s.currentRound=t.currentRound||0;const r=n.replace(/@(\w+)/g,"$1");return Nr.evaluate(r,s)}catch{return 0}}function Lt(e,t,n,s){let r=t||0;const a=n.flatMap(h=>Array.isArray(h.modifiers)?h.modifiers:[]),o=a.filter(h=>h.target===e&&h.type===Ve.SET);return o.length>0&&(r=Re(o[o.length-1].value,s)),a.filter(h=>h.target===e&&h.type===Ve.ADD).forEach(h=>{r+=Re(h.value,s)}),a.filter(h=>h.target===e&&h.type===Ve.MULT).forEach(h=>{r*=Re(h.value,s)}),Math.floor(r)}const nn=j([w,Ye],([e,t])=>{const n={};return Array.isArray(e.attributes)&&e.attributes.forEach(s=>{n[s.key]=Lt(s.key,s.value,t,e)}),n}),zn=j([w,Pe,Ye],([e,t,n])=>Lt("health",t,n,e)),Dr=j([zn,Pt],([e,t])=>Math.max(0,e-t)),qr=j([Xe,Pe],([e,t])=>t>0?Math.min(100,e/t*100):100),Kn=j([Xe,Pe],([e,t])=>e>=t),Hr=j([Xe,Pe,Kn],([e,t,n])=>e>=t/2&&!n),Vr=j([w,nn,Ye],([e,t,n])=>{let s=Lt("speed",e.speed,n,e);const r=e.afflictions;return r.includes("Held")||r.includes("Stunned")||r.includes("Unconscious")||r.includes("Incapacitated")?0:((r.includes("Blinded")||r.includes("Weakened"))&&(s=Math.floor(s/2)),r.includes("Slowed")&&(s=Math.min(s,2)),Math.max(0,s))}),$r=j([w,Ye],([e,t])=>{let n=e.naturalDefense,s=0;const r=e.equipment.find(a=>a.type===be.ARMOR&&a.equipped);if(r){const a=r.defenseFixed||0,o=e.naturalDefense+(r.defenseMod||0);r.defenseFixed&&r.defenseMod?n=Math.max(a,o):r.defenseFixed?n=a:r.defenseMod&&(n=e.naturalDefense+r.defenseMod)}return e.equipment.filter(a=>a.type===be.SHIELD&&a.equippedState).forEach(a=>{s+=a.defenseMod||0}),Lt("defense",n+s,t,e)});j([w,Ye],([e,t])=>{const s=t.flatMap(r=>Array.isArray(r.modifiers)?r.modifiers:[]).filter(r=>r.target==="damage"&&r.type===Ve.ADD).reduce((r,a)=>r+Re(a.value,e),0);return(e.bonusDamage||0)+s});const te={updateCurrency:(e,t)=>{w.update(n=>{let s=n.currency.gp*100+n.currency.sp*10+n.currency.cp,r=0;return e==="gp"&&(r=t*100),e==="sp"&&(r=t*10),e==="cp"&&(r=t),s+=r,s<0&&(s=0),{...n,currency:{gp:Math.floor(s/100),sp:Math.floor(s%100/10),cp:s%100%10}}})},advanceRound:e=>{w.update(t=>{const n=t.currentRound||1;if(e==="next"){const s=(t.effects||[]).map(r=>{if(r.isActive&&r.duration==="ROUNDS"&&r.roundsLeft>0){const a=r.roundsLeft-1;return a<=0?{...r,roundsLeft:0,isActive:!1}:{...r,roundsLeft:a}}return r});return{...t,currentRound:n+1,effects:s}}else return{...t,currentRound:Math.max(1,n-1)}})},addToHistory:(e,t=!0)=>{const n=k(w),s=k(it);if(e.id&&s.find(o=>o.id===e.id))return;const r={id:e.id||at(),timestamp:e.timestamp||new Date,charName:n.name,source:e.source||"gm",name:e.name||"Action",...e};it.update(o=>[r,...o]),k(tn).autoOpenHistory?Ge.set(!0):k(Ge)||Nt.set(!0),t&&n.campaignId&&$t(async()=>{const{syncRoll:o}=await Promise.resolve().then(()=>Gt);return{syncRoll:o}},void 0,import.meta.url).then(({syncRoll:o})=>{o(r)})},clearHistory:()=>it.set([]),addItem:e=>w.update(t=>({...t,equipment:[...t.equipment,e]})),updateItem:e=>w.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?e:n)})),deleteItem:e=>w.update(t=>({...t,equipment:t.equipment.filter(n=>n.id!==e)})),useConsumable:e=>{if(e.quantity>0){const t=k(me);te.updateItem({...e,quantity:e.quantity-1}),te.addToHistory({source:"item",name:e.name,description:t("sofww.item_types.consumable")+`: ${e.name}`})}},equipItem:(e,t=null)=>{w.update(n=>{let s=[...n.equipment];return e.type===be.ARMOR?s=s.map(r=>r.id===e.id?{...r,equipped:!r.equipped}:r.type===be.ARMOR&&e.type===be.ARMOR&&!e.equipped?{...r,equipped:!1}:r):(e.type===be.WEAPON||e.type===be.SHIELD)&&(s=s.map(r=>r.id===e.id?{...r,equippedState:t}:r)),{...n,equipment:s}})},toggleAffliction:e=>{w.update(t=>t.afflictions.includes(e)?{...t,afflictions:t.afflictions.filter(n=>n!==e)}:{...t,afflictions:[...t.afflictions,e]})},addLanguage:e=>w.update(t=>({...t,languages:[...t.languages,e]})),removeLanguage:e=>w.update(t=>({...t,languages:t.languages.filter((n,s)=>s!==e)})),addSense:e=>w.update(t=>({...t,senses:[...t.senses||[],e]})),removeSense:e=>w.update(t=>({...t,senses:(t.senses||[]).filter((n,s)=>s!==e)})),confirmRest:()=>{w.update(t=>{const n=t.spells.map(r=>({...r,castings:r.maxCastings})),s=t.talents.map(r=>({...r,uses:r.maxUses}));return{...t,spells:n,talents:s}}),Xe.set(0);const e=k(Pt);Pe.set(e),$e.set({type:null,isOpen:!1,data:null})},finalizeRoll:(e,t,n=[],s={})=>{const r=k(w),a=k(nn),o=k(me),l=e.type==="weapon_attack",c=e.type==="luck",h=e.type==="weapon_damage",p=e?.source,f=p?.name||o("common.labels.action"),i=(u,g)=>u.traits&&u.traits.toLowerCase().includes(g.toLowerCase());let m={},S=()=>{};if(h){let u=parseInt(p.damageDice)||0;const g=p.grip&&p.grip.toLowerCase()==="two"||p.equippedState&&p.equippedState.toLowerCase()==="two";i(p,"Versatile")&&g&&(u+=1);let _=r.bonusDamage||0;i(p,"Light")&&_>1&&(_-=1);const H=n.flatMap(b=>Array.isArray(b.modifiers)?b.modifiers:[]).filter(b=>b.target==="damage"&&b.type===Ve.ADD).reduce((b,x)=>b+Re(x.value,r),0),I=_+H,M=Math.max(0,u+I+t);let N=[],P=0,R=[];for(let b=0;b<M;b++){let x=Math.floor(Math.random()*6)+1;if(x===1&&i(p,"Brutal")){const se=Math.floor(Math.random()*6)+1;R.push(`1->${se}`),x=se}else R.push(`${x}`);N.push(x),P+=x}const J=`${M}d6 [${N.join(", ")}] ${R.some(b=>b.includes("->"))?`(Rolagens: ${R.join(", ")})`:""}`;m={damageDice:N,total:P,formula:J},S=()=>{te.addToHistory({source:"damage",name:p.name,description:`${o("history.source.damage")}: ${M}d6 ${i(p,"Brutal")?"(Brutal)":""}`,formula:J,total:P,effectsApplied:n.map(b=>b.name)}),p.type===be.EXPLOSIVE&&te.useConsumable(p)}}else{const u=Math.floor(Math.random()*20)+1;let g=0,_=o("history.source.luck");if(e.type==="attribute")g=(a[e.source.key]||e.source.value)-10,_=o(`sofww.attributes.${e.source.key}`);else if(l){let b="str",x=o("sofww.attributes.str");p.range==="Ranged"&&(b="agi",x=o("sofww.attributes.agi"),i(p,"Thrown")&&(b="str",x=o("sofww.attributes.str"))),i(p,"Nimble")&&(b="agi",x=o("sofww.attributes.agi")),g=(a[b]||10)-10,_=x}const H=Math.floor(n.flatMap(b=>Array.isArray(b.modifiers)?b.modifiers:[]).filter(b=>b.target==="boons"&&b.type===Ve.ADD).reduce((b,x)=>b+Re(x.value,r),0));t+=H;let I=0,M="",N=[];if(t!==0){const b=Math.abs(t);for(let se=0;se<b;se++)N.push(Math.floor(Math.random()*6)+1);const x=Math.max(...N);t>0?(I=x,M=` + ${x} [${o("sofdl.rolls.boon")}]`):(I=-x,M=` - ${x} [${o("sofdl.rolls.bane")}]`)}const P=u+g+I;let R="";if(l?R=`${o("history.source.attack")} (${_})`:c?R=o("history.source.luck"):R=`${o("history.source.attribute")}: ${f}`,t!==0&&(R+=` ${o("sofdl.rolls.attribute_test",{values:{attr:"",modifier:t}}).replace(/^[^ ]+ /,"")}`),l&&u===20){let b=[];i(p,"Bludgeoning")&&b.push(o("sofww.afflictions.vulnerable.name")),i(p,"Piercing")&&b.push(o("sofww.afflictions.weakened.name")),i(p,"Slashing")&&b.push("+1d6 Dmg"),b.length>0&&(R+=`
CRÍTICO! ${b.join(" ")} `)}const J=`d20(${u})${g!==0?(g>=0?"+":"")+g:""}${M}`;m={d20:u,boonBaneDice:N,total:P,formula:J},S=()=>{te.addToHistory({source:l?"attack":c?"luck":"attribute",name:f,description:R,formula:J,total:P,crit:u===20,effectsApplied:n.map(b=>b.name)}),w.update(b=>({...b,effects:b.effects.map(x=>x.isActive&&x.duration==="NEXT_ROLL"?{...x,isActive:!1}:x)})),l&&i(p,"Reload")&&w.update(b=>({...b,equipment:b.equipment.map(x=>x.id===p.id?{...x,isLoaded:!1}:x)}))}}return s.suppressHistory||S(),{...m,commit:S}},reloadWeapon:e=>{const t=k(me);w.update(n=>({...n,equipment:n.equipment.map(s=>s.id===e.id?{...s,isLoaded:!0}:s)})),te.addToHistory({source:"attribute",name:t("actions.reload"),description:`${t("actions.reload")}: ${e.name}`})},addSpell:e=>w.update(t=>({...t,spells:[...t.spells,e]})),updateSpell:e=>w.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?e:n)})),deleteSpell:e=>w.update(t=>({...t,spells:t.spells.filter(n=>n.id!==e)})),commitSpellCast:e=>{e.castings>0&&(w.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?{...n,castings:n.castings-1}:n)})),te.addToHistory({source:"spell",name:e.name,description:e.description}),$e.set({type:null,isOpen:!1,data:null}))},addTalent:e=>w.update(t=>({...t,talents:[...t.talents,e]})),updateTalent:e=>w.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?e:n)})),deleteTalent:e=>w.update(t=>({...t,talents:t.talents.filter(n=>n.id!==e)})),commitTalentUse:e=>{e.activityType==="Duration"&&e.duration==="LUCK_ENDS"?w.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?{...n,uses:0}:n)})):e.maxUses&&w.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?{...n,uses:n.uses-1}:n)})),te.addToHistory({source:"talent",name:e.name,description:e.description}),$e.set({type:null,isOpen:!1,data:null})},recoverTalent:e=>{w.update(t=>({...t,talents:t.talents.map(n=>n.id===e&&n.uses<n.maxUses?{...n,uses:(n.uses||0)+1}:n)}))},rollLuckTalent:e=>{const t=k(me),n=Math.floor(Math.random()*20)+1,s=n>=10,a=k(w).talents.find(o=>o.id===e);te.addToHistory({source:"luck",name:`${t("character.history.source.luck")} - ${a?.name||t("character.talents.title")}`,formula:`d20(${n})`,total:n,description:s?t("character.dice_roll.luck_success",{values:{total:n}}):t("character.dice_roll.luck_failure",{values:{total:n}})}),s&&w.update(o=>({...o,talents:o.talents.map(l=>l.id===e?{...l,uses:1}:l)}))},addEffect:e=>w.update(t=>({...t,effects:[...t.effects,e]})),updateEffect:e=>w.update(t=>({...t,effects:t.effects.map(n=>n.id===e.id?e:n)})),deleteEffect:e=>w.update(t=>({...t,effects:t.effects.filter(n=>n.id!==e)})),toggleEffect:e=>w.update(t=>({...t,effects:t.effects.map(n=>{if(n.id===e){const s=!n.isActive;return{...n,isActive:s,roundsLeft:s&&n.duration==="ROUNDS"&&n.initialRounds||n.roundsLeft}}return n})})),cleanInactiveEffects:()=>w.update(e=>({...e,effects:e.effects.filter(t=>t.isActive)})),applyEffectToCharacter:(e,t)=>{const n=e.name||(t?t.name:"Effect"),s=e.description||(t?t.description:""),r={id:at(),isActive:!0,name:n,description:s,roundsLeft:0,duration:"PERMANENT",modifiers:[],...e};r.duration==="ROUNDS"&&!r.initialRounds&&(r.initialRounds=r.roundsLeft),w.update(a=>({...a,effects:[...a.effects,r]}))},checkLuckEnds:e=>{const t=k(me),n=Math.floor(Math.random()*20)+1,s=n>=10;te.addToHistory({source:"luck",name:t("sofww.duration.luck_ends"),description:s?t("character.dice_roll.luck_success",{values:{total:n}}):t("character.dice_roll.luck_failure",{values:{total:n}})}),s&&w.update(r=>({...r,effects:r.effects.map(a=>a.id===e?{...a,isActive:!1}:a)}))},joinCampaign:e=>{w.update(t=>({...t,campaignId:e.id,campaignName:e.name,gmName:e.gmName||"Game Master"})),$t(async()=>{const{joinCampaignRoom:t}=await Promise.resolve().then(()=>Gt);return{joinCampaignRoom:t}},void 0,import.meta.url).then(({joinCampaignRoom:t})=>{t(e.id,!1)})},leaveCampaign:()=>{w.update(e=>({...e,campaignId:null,campaignName:null,gmName:null,combatActive:!1}))}},va=Object.freeze(Object.defineProperty({__proto__:null,activeEffects:Ye,activeTab:Lr,appSettings:tn,character:w,characterActions:te,currentHealth:Pe,damage:Xe,damagePercentage:qr,defaultCharacter:Wn,derivedStats:nn,effectiveMaxHealth:zn,effectiveSpeed:Vr,evaluateModifierValue:Re,hasUnreadRolls:Nt,isHistoryOpen:Ge,isIncapacitated:Kn,isInjured:Hr,modalState:$e,normalHealth:Pt,rollHistory:it,tempHealth:Dr,totalDefense:$r},Symbol.toStringTag,{value:"Module"})),Fr=new Ee,Br={id:"",system:"sofdl",name:"",ancestry:"",level:0,paths:{novice:"",expert:"",master:""},imageUrl:"",attributes:{strength:10,agility:10,intellect:10,will:10},perception:10,defense:10,health:10,healingRate:2,size:1,speed:10,power:0,damage:0,insanity:0,corruption:0,description:"",notes:"",professions:[],languages:["Comum"],senses:[],afflictions:[],talents:[],spells:[],equipment:[],currency:{gc:0,ss:0,cp:0,bits:0},effects:[],campaignId:null,campaignName:null,gmName:null,campaignApproval:null,combatActive:!1,currentRound:1,initiative:!1,acted:!1,magicSystem:"standard"},A=Q(JSON.parse(JSON.stringify(Br))),jr=j(A,e=>e.effects.filter(t=>t.isActive)),Ne=j([A,jr],([e,t])=>{const n={strength:e.attributes.strength,agility:e.attributes.agility,intellect:e.attributes.intellect,will:e.attributes.will,perception:e.perception,defense:e.defense,health:e.health,speed:e.speed,healingRate:e.healingRate,power:e.power,boons:0},s=[];t.forEach(o=>{o.modifiers&&o.modifiers.forEach(l=>{s.push(l)})});const r=o=>o==="healing_rate"?"healingRate":o;return Object.keys(n).forEach(o=>{const l=s.filter(p=>r(p.target)===o);if(l.length===0)return;const c=l.filter(p=>p.type==="SET");if(c.length>0){const p=c[c.length-1];n[o]=Vt(p.value,e)}c.length===0&&l.filter(f=>f.type==="ADD").forEach(f=>{n[o]+=Vt(f.value,e)}),l.filter(p=>p.type==="MULT").forEach(p=>{n[o]*=Vt(p.value,e)}),n[o]=Math.floor(n[o])}),{strength:n.strength,agility:n.agility,intellect:n.intellect,will:n.will,perception:n.perception,defense:n.defense,health:n.health,speed:n.speed,healingRate:n.healingRate,power:n.power,boons:n.boons}}),wa=j(Ne,e=>({strength:e.strength,agility:e.agility,intellect:e.intellect,will:e.will})),Jr=j(Ne,e=>({strength:e.strength-10,agility:e.agility-10,intellect:e.intellect-10,will:e.will-10}));j([A,Ne],([e,t])=>t.health-e.damage);j([A,Ne],([e,t])=>e.damage>=t.health/2);j([A,Ne],([e,t])=>e.damage>=t.health);function Vt(e,t){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim();if(!isNaN(Number(n)))return Number(n);try{const s={};t.attributes&&Object.entries(t.attributes).forEach(([a,o])=>{s[a]=o}),s.level=t.level||0,s.perception=t.perception||0,s.defense=t.defense||0,s.health=t.health||0,s.healingRate=t.healingRate||0,s.size=t.size||0,s.speed=t.speed||0,s.power=t.power||0,s.damage=t.damage||0,s.insanity=t.insanity||0,s.corruption=t.corruption||0;const r=n.replace(/@(\w+)/g,"$1");return Fr.evaluate(r,s)}catch{return 0}}const ba=j(Ne,e=>Math.max(0,e.healingRate)),qe={set:e=>{A.update(t=>{const n={...t,...e};return e.health!==void 0&&e.healingRate===void 0&&(n.healingRate=Math.floor(n.health/4)),n})},updateAttribute:(e,t)=>{A.update(n=>({...n,attributes:{...n.attributes,[e]:t}}))},takeDamage:e=>{A.update(t=>{const n=Math.max(0,Math.min(t.health,t.damage+e));return{...t,damage:n}})},heal:e=>{A.update(t=>{const n=Math.max(0,t.damage-e);return{...t,damage:n}})},updateStat:(e,t)=>{A.update(n=>({...n,[e]:Math.max(0,t)}))},toggleEffect:e=>{A.update(t=>({...t,effects:t.effects.map(n=>n.id===e?{...n,isActive:!n.isActive}:n)}))},deleteEffect:e=>{A.update(t=>({...t,effects:t.effects.filter(n=>n.id!==e)}))},cleanInactiveEffects:()=>{A.update(e=>({...e,effects:e.effects.filter(t=>t.isActive)}))},advanceRound:e=>{A.update(t=>{if(e==="next"){const n=t.effects.map(s=>s.isActive&&s.duration==="END_OF_ROUND"?{...s,isActive:!1}:s);return{...t,currentRound:t.currentRound+1,effects:n}}return{...t,currentRound:Math.max(1,t.currentRound-1)}})},checkLuckEnds:e=>{const n=k(A).effects.find(r=>r.id===e),s=k(me);$e.set({type:"pre_roll",isOpen:!0,data:{type:"luck_ends",system:"sofdl",effectId:e,source:{name:n?.name||s("sofdl.rolls.effect")}}})},checkConcentration:e=>{const n=k(A).effects.find(r=>r.id===e),s=k(me);$e.set({type:"pre_roll",isOpen:!0,data:{type:"concentration",system:"sofdl",effectId:e,key:"will",source:{name:n?.name||s("sofdl.rolls.concentration")}}})},addSpell:e=>{A.update(t=>({...t,spells:[...t.spells,{...e,id:e.id||at()}]}))},updateSpell:e=>{A.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?e:n)}))},deleteSpell:e=>{A.update(t=>({...t,spells:t.spells.filter(n=>n.id!==e)}))},castSpell:e=>{const n=k(A).spells.find(s=>s.id===e);n&&(A.update(s=>({...s,spells:s.spells.map(r=>r.id===e?{...r,castingsUsed:(r.castingsUsed||0)+1}:r)})),qe.addToHistory({source:"spell",name:n.name,description:n.description,type:"spell"}))},resetSpellCastings:()=>{A.update(e=>({...e,spells:e.spells.map(t=>({...t,castingsUsed:0}))}))},addTalent:e=>{A.update(t=>({...t,talents:[...t.talents,{...e,id:e.id||at()}]}))},updateTalent:e=>{A.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?e:n)}))},deleteTalent:e=>{A.update(t=>({...t,talents:t.talents.filter(n=>n.id!==e)}))},useTalent:e=>{const n=k(A).talents.find(s=>s.id===e);n&&(A.update(s=>({...s,talents:s.talents.map(r=>r.id===e&&r.uses>0?{...r,uses:r.uses-1}:r)})),qe.addToHistory({source:"talent",name:n.name,description:n.description,type:"talent"}))},resetTalentUses:()=>{A.update(e=>({...e,talents:e.talents.map(t=>({...t,uses:t.maxUses}))}))},addSense:e=>{A.update(t=>({...t,senses:t.senses.includes(e)?t.senses:[...t.senses,e]}))},removeSense:e=>{A.update(t=>({...t,senses:t.senses.filter((n,s)=>s!==e)}))},toggleAffliction:e=>{A.update(t=>({...t,afflictions:t.afflictions.includes(e)?t.afflictions.filter(n=>n!==e):[...t.afflictions,e]}))},leaveCampaign:()=>{A.update(e=>({...e,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}))},addToHistory:(e,t=!0)=>{const n=k(A),s={id:e.id||at(),timestamp:e.timestamp||new Date,charName:n.name,...e};it.update(a=>[s,...a]),k(tn).autoOpenHistory?Ge.set(!0):k(Ge)||Nt.set(!0),t&&n.campaignId&&$t(async()=>{const{syncRoll:a}=await Promise.resolve().then(()=>Gt);return{syncRoll:a}},void 0,import.meta.url).then(({syncRoll:a})=>{a(s)})},addLanguage:e=>A.update(t=>({...t,languages:[...t.languages,e]})),removeLanguage:e=>A.update(t=>({...t,languages:t.languages.filter((n,s)=>s!==e)})),addProfession:e=>A.update(t=>({...t,professions:[...t.professions,e]})),removeProfession:e=>A.update(t=>({...t,professions:t.professions.filter((n,s)=>s!==e)})),updateCurrency:(e,t)=>{A.update(n=>{const s=Math.max(0,(n.currency[e]||0)+t);return{...n,currency:{...n.currency,[e]:s}}})},addItem:e=>A.update(t=>({...t,equipment:[...t.equipment,e]})),updateItem:e=>A.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?e:n)})),deleteItem:e=>A.update(t=>({...t,equipment:t.equipment.filter(n=>n.id!==e)})),useConsumable:e=>{A.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?{...n,quantity:Math.max(0,n.quantity-1)}:n)}))},reloadWeapon:e=>A.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?{...n,isLoaded:!0}:n)})),finalizeRoll:(e,t,n=[],s={})=>{k(A);const r=k(Jr),a=k(Ne),o=e?.type==="weapon_damage"||e?.type==="spell_damage",l=k(me),c=e?.source?.name||e?.key||l("character.modals.attribute");let h={},p=()=>{};if(o){const f=e.source?.damage??e.source?.damageDice??"1d6",i=String(f),m=Number(e.source?.damageMod)||0;let S=0,u=[],g="";if(i==="0")S=0,g="0";else if(!i.includes("d"))S=parseInt(i)||0,g=`${S}`,u=[S];else{const M=i.match(/(\d+)d(\d+)/);if(M){const N=parseInt(M[1])||1,P=parseInt(M[2])||6;for(let R=0;R<N;R++){const J=Math.floor(Math.random()*P)+1;S+=J,u.push(J)}g=`${i} [${u.join(", ")}]`}else S=1,g="1"}const _=S+t+m,H=t+m!==0?`${t+m>0?"+":""}${t+m}`:"",I=`${g}${H}`;h={damageDice:u,total:_,formula:I},p=()=>{const M=k(me);qe.addToHistory({source:"damage",name:c,description:M("sofdl.rolls.damage_description",{values:{source:c}}),formula:I,total:_,effectsApplied:n})}}else{const f=Math.floor(Math.random()*20)+1;let i=0,m=c;e.type==="attribute"?(i=r[e.key]||0,m=l(`sofdl.attributes.${e.key}`)):e.type==="luck"&&(i=0,m=l("character.luck_test"));let S=t+(a.boons||0),u=0,g="",_=[];if(S!==0){const N=Math.abs(S);for(let R=0;R<N;R++)_.push(Math.floor(Math.random()*6)+1);const P=Math.max(..._);S>0?(u=P,g=` + ${P} [${l("sofdl.rolls.boon")}]`):(u=-P,g=` - ${P} [${l("sofdl.rolls.bane")}]`)}let H="attribute";e.type==="weapon_attack"?H="attack":(e.type==="luck"||e.type==="luck_ends")&&(H="luck");const I=f+i+u,M=`d20(${f})${i!==0?(i>=0?"+":"")+i:""}${g}`;h={d20:f,boonBaneDice:_,total:I,formula:M},p=()=>{qe.addToHistory({source:H,name:m,description:e.type==="luck_ends"?l("sofdl.rolls.luck_ends",{values:{effect:c}}):l("sofdl.rolls.attribute_test",{values:{attr:m,modifier:t}}),formula:M,total:I,crit:f===20,effectsApplied:n}),e.type==="luck_ends"&&I>=10&&A.update(N=>({...N,effects:N.effects.map(P=>P.id===e.effectId?{...P,isActive:!1}:P)}))}}return s.suppressHistory||p(),{...h,commit:p}},rest:()=>{A.update(e=>{const t=e.spells.map(r=>({...r,castingsUsed:0})),n=e.talents.map(r=>({...r,uses:r.isPassive?0:r.maxUses})),s=Math.max(0,e.damage-e.healingRate);return{...e,spells:t,talents:n,damage:s}})}},Gr="wss://tracker.openwebtorrent.com",Aa=[{label:"OpenWebTorrent (Standard)",value:"wss://tracker.openwebtorrent.com"},{label:"Files.fm",value:"wss://tracker.files.fm:7073/announce"},{label:"WebTorrent Dev",value:"wss://tracker.webtorrent.dev"},{label:"Vibe Community",value:"wss://toad.vibe.community:443/announce"},{label:"BTorrent",value:"wss://tracker.btorrent.xyz"}],Wr=(e,t)=>{let n=t;if(typeof window<"u"){const o=localStorage.getItem(e);o&&(n=JSON.parse(o))}const{subscribe:s,set:r,update:a}=Q(n);return{subscribe:s,set:o=>{typeof window<"u"&&localStorage.setItem(e,JSON.stringify(o)),r(o)},update:o=>{a(l=>{const c=o(l);return typeof window<"u"&&localStorage.setItem(e,JSON.stringify(c)),c})}}},xt=Wr("app_tracker_url",Gr);function sn(){const e=k(xt);return{appId:ns,trackerUrls:[e]}}const F=Q({roomId:null,peers:[],currentCharacterId:null,lastGmUpdate:0,isGM:!1,isConnected:!1,connectionStatus:"disconnected"}),zr=j(F,e=>e.lastGmUpdate?Date.now()-e.lastGmUpdate<6e4:!1);let G=null,pe=null,ht=null,dt=null,Fe=null,mt=null,Ce=null,oe=null,ge=null,xn=0,On=0;const Kr=2e3,Jt=Q([]),xe=Q("disconnected");async function rn(e,t=5e3){return e?new Promise(n=>{let s=null;try{s=new WebSocket(e);const r=setTimeout(()=>{if(s){s.onopen=null,s.onerror=null;try{s.close()}catch{}}n(!1)},t);s.onopen=()=>{if(clearTimeout(r),s)try{s.close()}catch{}n(!0)},s.onerror=()=>{clearTimeout(r),n(!1)}}catch{n(!1)}}):!1}function Xr(e){ge&&clearInterval(ge),ge=setInterval(async()=>{const t=await rn(e,3e3);F.update(n=>!t&&n.connectionStatus==="connected"?{...n,connectionStatus:"reconnecting"}:t&&n.connectionStatus==="reconnecting"?{...n,connectionStatus:"connected"}:n)},15e3)}function gt(e,t){if(!e)return!0;try{return e.leave(),!0}catch(n){return console.warn(`Failed to leave ${t}:`,n),!1}}function Xn(e){return Date.now()-e>=Kr}let Ae;async function Yn(){if(pe&&Ae)return k(xt),console.log("Lobby already connected, reusing existing connection"),xe.set("connected"),Ae;if(!Xn(xn))return console.warn("Lobby join rate limited. Skipping duplicate join attempt."),null;xn=Date.now(),Ce&&(clearInterval(Ce),Ce=null),gt(pe,"existing lobby"),pe=null,xe.set("connecting");const e=k(xt);if(!await rn(e))return console.warn(`Tracker ${e} appears offline.`),xe.set("error"),pe=null,null;try{const n=sn();pe=$n(n,"public-discovery");const[s,r]=pe.makeAction("discovery");return r(a=>{Jt.update(o=>{const l=o.findIndex(c=>c.id===a.id);if(l!==-1){const c=[...o];return c[l]={...a,lastSeen:Date.now()},c}return[...o,{...a,lastSeen:Date.now()}]})}),Ce=setInterval(()=>{const a=Date.now();Jt.update(o=>o.filter(l=>a-l.lastSeen<12e4))},6e4),xe.set("connected"),Ae=s,s}catch(n){return console.error("Failed to join lobby:",n),pe=null,xe.set("error"),null}}function Yr(e){return Ae?(Ae({id:e.id,name:e.name,gmName:e.gmName||"Mestre",description:e.description,system:e.system}),!0):(console.warn("Cannot announce campaign: lobby not initialized"),!1)}function Qr(){typeof window<"u"&&Yn().catch(e=>console.error("Error initializing lobby:",e))}typeof window<"u"&&(Qr(),window.addEventListener("beforeunload",()=>{Zr()}),window.addEventListener("online",()=>{F.update(e=>e.isConnected?{...e,connectionStatus:"reconnecting"}:e),setTimeout(()=>{k(F).isConnected&&F.update(e=>({...e,connectionStatus:"connected"}))},2e3)}),window.addEventListener("offline",()=>{F.update(e=>e.isConnected?{...e,connectionStatus:"disconnected"}:e)}));function Zr(){Ce&&(clearInterval(Ce),Ce=null),oe&&(clearInterval(oe),oe=null),ge&&(clearInterval(ge),ge=null),gt(pe,"lobby"),gt(G,"room"),pe=null,G=null,Ae=null,xe.set("disconnected"),F.update(e=>({...e,isConnected:!1,connectionStatus:"disconnected"}))}let Se=null;async function Qn(e,t=!1,n=null){const s=`campaign-${e}`;if(Se===s&&G)return F.update(o=>({...o,isGM:t,currentCharacterId:n,connectionStatus:"connected"})),G;if(!Xn(On)&&Se!==s)return console.warn("Campaign join rate limited. Skipping duplicate join attempt."),G;On=Date.now(),oe&&(clearInterval(oe),oe=null),gt(G,"existing campaign room"),G=null,Se=null,F.update(o=>({...o,connectionStatus:"connecting"})),ht=null,dt=null,Fe=null,mt=null;const r=k(xt);if(!await rn(r))return console.warn(`Tracker ${r} appears offline.`),F.update(o=>({...o,connectionStatus:"error",isConnected:!1})),null;try{Se=s;const o=sn();G=$n(o,Se),F.set({isConnected:!0,connectionStatus:"connected",isGM:t,currentCharacterId:n,peers:[],roomId:e,lastGmUpdate:0}),Xr(r);const[l,c]=G.makeAction("combat"),[h,p]=G.makeAction("history"),[f,i]=G.makeAction("charUpdate"),[m,S]=G.makeAction("campaign");return ht=l,dt=h,Fe=f,mt=m,c(u=>{t||w.update(g=>({...g,currentRound:u.round,combatActive:u.active}))}),S(u=>{F.update(g=>({...g,lastGmUpdate:Date.now()})),t||w.update(g=>({...g,campaignName:u.name,gmName:u.gmName,passwordHash:u.passwordHash,system:u.system}))}),t&&(oe=setInterval(()=>{if(!Ae)return;const u=yt.get(e);u&&u.isPublished&&Ae({id:e,name:u.name,gmName:u.gmName||"Mestre",description:u.description,system:u.system})},3e4)),p(u=>{te.addToHistory(u,!1)}),i(u=>{if(t){const g=yt.get(e);if(g){const _=g.members||[],H=_.findIndex(R=>R.id===u.id);let I;if(H!==-1){I=[..._];const R=I[H],J={...u};R.campaignApproval==="approved"&&u.campaignApproval==="pending"&&delete J.campaignApproval,I[H]={...R,...J,lastUpdate:Date.now()}}else I=[..._,{...u,lastUpdate:Date.now()}];const M=g.activeEnemies||[],N=M.findIndex(R=>R.id===u.id&&R.type==="player");let P=M;N!==-1&&(P=[...M],P[N]={...P[N],...u}),yt.set(e,{...g,members:I,activeEnemies:P})}}else{const g=k(F),_=k(w),H=g.currentCharacterId||_?.id;if(H&&H===u.id){const I=u.system==="sofdl";if(u.campaignApproval==="rejected"||u.campaignId===null){I?qe.leaveCampaign():w.update(M=>({...M,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}));return}I?qe.set({name:u.name,afflictions:u.afflictions,senses:u.senses,initiative:u.initiative,acted:u.acted,campaignApproval:u.campaignApproval,imageUrl:u.imageUrl,notes:u.notes,damage:u.damage,health:u.health,healingRate:u.healingRate,insanity:u.insanity,corruption:u.corruption,defense:u.defense,speed:u.speed,power:u.power,attributes:u.attributes}):(w.update(M=>({...M,name:u.name||M.name,afflictions:u.afflictions||M.afflictions,senses:u.senses||M.senses,initiative:u.initiative!==void 0?u.initiative:M.initiative??!1,acted:u.acted!==void 0?u.acted:M.acted??!1,campaignApproval:u.campaignApproval||M.campaignApproval,imageUrl:u.imageUrl||M.imageUrl,notes:u.notes!==void 0?u.notes:M.notes})),u.damage!==void 0&&Xe.set(u.damage),u.currentHealth!==void 0&&Pe.set(u.currentHealth),u.normalHealth!==void 0&&Pt.set(u.normalHealth))}}}),G.onPeerJoin(u=>{if(console.log("Peer joined:",u),!t&&n&&Fe({type:"full",character:k(appSettings).characters?.[n]}),F.update(g=>({...g,peers:[...g.peers,u]})),t){const g=yt.get(e);g&&(g.combat&&l(g.combat),m({name:g.name,gmName:g.gmName||"Mestre",passwordHash:g.passwordHash,system:g.system}))}}),G.onPeerLeave(u=>{console.log("Peer left:",u),F.update(g=>({...g,peers:g.peers.filter(_=>_!==u)}))}),G}catch(o){return console.error("Failed to join campaign room:",o),G=null,Se=null,F.update(l=>({...l,isConnected:!1,connectionStatus:"error"})),null}}function ea(e,t){ht&&ht(t)}function ta(e,t){mt&&mt({name:t.name,gmName:t.gmName||"Mestre",passwordHash:t.passwordHash,system:t.system})}function na(e){dt&&dt(e)}function sa(e){Fe&&Fe(e)}function ra(){oe&&(clearInterval(oe),oe=null),ge&&(clearInterval(ge),ge=null),gt(G,"campaign room"),G=null,Se=null,ht=null,dt=null,Fe=null,mt=null,F.set({isConnected:!1,connectionStatus:"disconnected",isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0})}function aa(){const e=k(F);e.roomId?(console.log("Manual reconnection triggered"),F.update(t=>({...t,connectionStatus:"connecting"})),setTimeout(()=>{Qn(e.roomId,e.isGM,e.currentCharacterId)},100)):console.warn("Cannot reconnect: no active campaign session found")}const Gt=Object.freeze(Object.defineProperty({__proto__:null,announceCampaign:Yr,getTrackerConfig:sn,isGmOnline:zr,joinCampaignRoom:Qn,joinLobby:Yn,leaveCampaignRoom:ra,lobbyStatus:xe,publicCampaigns:Jt,reconnectCampaign:aa,syncCampaign:ta,syncCharacter:sa,syncCombat:ea,syncRoll:na,syncState:F},Symbol.toStringTag,{value:"Module"}));export{ba as $,Aa as A,Dr as B,Hr as C,Gr as D,Kn as E,qr as F,$e as G,ha as H,be as I,Ve as J,qe as K,wa as L,ma as M,nn as N,Vt as O,Re as P,jr as Q,Ye as R,A as S,Ne as T,Pt as U,Pe as V,$r as W,Vr as X,Lr as Y,da as Z,Jr as _,$n as a,ya as a0,ga as a1,Br as a2,Wn as a3,va as a4,fa as b,w as c,tn as d,te as e,sa as f,sn as g,ta as h,zr as i,Qn as j,Ge as k,ra as l,Yr as m,ea as n,pa as o,F as p,Nt as q,it as r,Ue as s,aa as t,at as u,xt as v,xe as w,Jt as x,zn as y,Xe as z};
