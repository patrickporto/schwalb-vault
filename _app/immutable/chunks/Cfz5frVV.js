import{ba as kn,aV as Ke,aw as Kn,L as Tn,K as xn,h as Sn,bb as Xn}from"./DfayzYqb.js";import{w as Z,j as B,g as C}from"./Cx0o8vWd.js";import{_ as qt}from"./PPVm8Dsz.js";import{$ as de}from"./Bs3V2B0j.js";import{d as Yn,a as mt}from"./CdkHlkWG.js";function ra(e,t,n=t){var s=new WeakSet;kn(e,"input",async r=>{var a=r?e.defaultValue:e.value;if(a=Pt(e)?Nt(a):a,n(a),Ke!==null&&s.add(Ke),await Kn(),a!==(a=t())){var i=e.selectionStart,l=e.selectionEnd,u=e.value.length;if(e.value=a??"",l!==null){var h=e.value.length;i===l&&l===u&&h>u?(e.selectionStart=h,e.selectionEnd=h):(e.selectionStart=i,e.selectionEnd=Math.min(l,h))}}}),(Sn&&e.defaultValue!==e.value||Tn(t)==null&&e.value)&&(n(Pt(e)?Nt(e.value):e.value),Ke!==null&&s.add(Ke)),xn(()=>{var r=t();if(e===document.activeElement){var a=Xn??Ke;if(s.has(a))return}Pt(e)&&r===Nt(e.value)||e.type==="date"&&!r&&!e.value||r!==e.value&&(e.value=r??"")})}function aa(e,t,n=t){kn(e,"change",s=>{var r=s?e.defaultChecked:e.checked;n(r)}),(Sn&&e.defaultChecked!==e.checked||Tn(t)==null)&&n(e.checked),xn(()=>{var s=t();e.checked=!!s})}function Pt(e){var t=e.type;return t==="number"||t==="range"}function Nt(e){return e===""?null:+e}const gt="0123456789abcdef";class Te{constructor(t){this.bytes=t}static ofInner(t){if(t.length!==16)throw new TypeError("not 128-bit length");return new Te(t)}static fromFieldsV7(t,n,s,r){if(!Number.isInteger(t)||!Number.isInteger(n)||!Number.isInteger(s)||!Number.isInteger(r)||t<0||n<0||s<0||r<0||t>0xffffffffffff||n>4095||s>1073741823||r>4294967295)throw new RangeError("invalid field value");const a=new Uint8Array(16);return a[0]=t/2**40,a[1]=t/2**32,a[2]=t/2**24,a[3]=t/2**16,a[4]=t/2**8,a[5]=t,a[6]=112|n>>>8,a[7]=n,a[8]=128|s>>>24,a[9]=s>>>16,a[10]=s>>>8,a[11]=s,a[12]=r>>>24,a[13]=r>>>16,a[14]=r>>>8,a[15]=r,new Te(a)}static parse(t){var n,s,r,a;let i;switch(t.length){case 32:i=(n=/^[0-9a-f]{32}$/i.exec(t))===null||n===void 0?void 0:n[0];break;case 36:i=(s=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(t))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 38:i=(r=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(t))===null||r===void 0?void 0:r.slice(1,6).join("");break;case 45:i=(a=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(t))===null||a===void 0?void 0:a.slice(1,6).join("");break}if(i){const l=new Uint8Array(16);for(let u=0;u<16;u+=4){const h=parseInt(i.substring(2*u,2*u+8),16);l[u+0]=h>>>24,l[u+1]=h>>>16,l[u+2]=h>>>8,l[u+3]=h}return new Te(l)}else throw new SyntaxError("could not parse UUID string")}toString(){let t="";for(let n=0;n<this.bytes.length;n++)t+=gt.charAt(this.bytes[n]>>>4),t+=gt.charAt(this.bytes[n]&15),(n===3||n===5||n===7||n===9)&&(t+="-");return t}toHex(){let t="";for(let n=0;n<this.bytes.length;n++)t+=gt.charAt(this.bytes[n]>>>4),t+=gt.charAt(this.bytes[n]&15);return t}toJSON(){return this.toString()}getVariant(){const t=this.bytes[8]>>>4;if(t<0)throw new Error("unreachable");if(t<=7)return this.bytes.every(n=>n===0)?"NIL":"VAR_0";if(t<=11)return"VAR_10";if(t<=13)return"VAR_110";if(t<=15)return this.bytes.every(n=>n===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new Te(this.bytes.slice(0))}equals(t){return this.compareTo(t)===0}compareTo(t){for(let n=0;n<16;n++){const s=this.bytes[n]-t.bytes[n];if(s!==0)return Math.sign(s)}return 0}}class Qn{constructor(t){this.timestamp_biased=0,this.counter=0,this.random=t??Zn()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(t,n){let s=this.generateOrAbortCore(t,n);return s===void 0&&(this.timestamp_biased=0,s=this.generateOrAbortCore(t,n)),s}generateOrAbortCore(t,n){if(!Number.isInteger(t)||t<0||t>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(t++,t>this.timestamp_biased)this.timestamp_biased=t,this.resetCounter();else if(t+n>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return Te.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const t=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return t[6]=64|t[6]>>>4,t[8]=128|t[8]>>>2,Te.ofInner(t)}}const Zn=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new es;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class es{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let tn;const nt=()=>ts().toString(),ts=()=>(tn||(tn=new Qn)).generate(),{floor:ns,random:ss}=Math,at="Trystero",ot=(e,t)=>Array(e).fill().map(t),nn="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",On=e=>ot(e,()=>nn[ns(ss()*nn.length)]).join(""),Pe=On(20),Me=Promise.all.bind(Promise),Rn=typeof window<"u",{entries:Ht,fromEntries:Cn,keys:rs}=Object,pe=()=>{},he=e=>new Error(`${at}: ${e}`),as=new TextEncoder,os=new TextDecoder,De=e=>as.encode(e),At=e=>os.decode(e),yt=(...e)=>e.join("@"),is=(e,t,n,s)=>(e.relayUrls||t).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||n),it=JSON.stringify,lt=JSON.parse,sn=3333,vt={};let st=null,Ft=null;const ls=()=>{st||(st=new Promise(e=>{Ft=e}).finally(()=>{Ft=null,st=null}))},us=()=>Ft?.(),cs=(e,t)=>{const n={},s=()=>{const r=new WebSocket(e);r.onclose=()=>{if(st){st.then(s);return}vt[e]??=sn,setTimeout(s,vt[e]),vt[e]*=2},r.onmessage=a=>t(a.data),n.socket=r,n.url=r.url,n.ready=new Promise(a=>r.onopen=()=>{a(n),vt[e]=sn}),n.send=a=>{r.readyState===1&&r.send(a)}};return s(),n},fs=()=>{if(Rn){const e=new AbortController;return addEventListener("online",us,{signal:e.signal}),addEventListener("offline",ls,{signal:e.signal}),()=>e.abort()}return pe},jt="AES-GCM",ps={},hs=e=>btoa(String.fromCharCode.apply(null,new Uint8Array(e))),ds=e=>{const t=atob(e);return new Uint8Array(t.length).map((n,s)=>t.charCodeAt(s)).buffer},ms=async(e,t)=>new Uint8Array(await crypto.subtle.digest(e,De(t))),Ze=async e=>ps[e]||=Array.from(await ms("SHA-1",e)).map(t=>t.toString(36)).join(""),gs=async(e,t,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},De(`${e}:${t}:${n}`)),{name:jt},!1,["encrypt","decrypt"]),_n="$",In=",",ys=async(e,t)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(In)+_n+hs(await crypto.subtle.encrypt({name:jt,iv:n},await e,De(t)))},vs=async(e,t)=>{const[n,s]=t.split(_n);return At(await crypto.subtle.decrypt({name:jt,iv:new Uint8Array(n.split(In))},await e,ds(s)))},ws=5e3,rn="icegatheringstatechange",an="offer",bs="answer",on=(e,{rtcConfig:t,rtcPolyfill:n,turnConfig:s})=>{const r=new(n||RTCPeerConnection)({iceServers:As.concat(s||[]),...t}),a={};let i=!1,l=!1,u=null;const h=c=>{c.binaryType="arraybuffer",c.bufferedAmountLowThreshold=65535,c.onmessage=o=>a.data?.(o.data),c.onopen=()=>a.connect?.(),c.onclose=()=>a.close?.(),c.onerror=o=>a.error?.(o)},f=c=>Promise.race([new Promise(o=>{const p=()=>{c.iceGatheringState==="complete"&&(c.removeEventListener(rn,p),o())};c.addEventListener(rn,p),p()}),new Promise(o=>setTimeout(o,ws))]).then(()=>({type:c.localDescription.type,sdp:c.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return e?(u=r.createDataChannel("data"),h(u)):r.ondatachannel=({channel:c})=>{u=c,h(c)},r.onnegotiationneeded=async()=>{try{i=!0,await r.setLocalDescription();const c=await f(r);a.signal?.(c)}catch(c){a.error?.(c)}finally{i=!1}},r.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(r.connectionState)&&a.close?.()},r.ontrack=c=>{a.track?.(c.track,c.streams[0]),a.stream?.(c.streams[0])},r.onremovestream=c=>a.stream?.(c.stream),e&&(r.canTrickleIceCandidates||r.onnegotiationneeded()),{created:Date.now(),connection:r,get channel(){return u},get isDead(){return r.connectionState==="closed"},async signal(c){if(!(u?.readyState==="open"&&!c.sdp?.includes("a=rtpmap")))try{if(c.type===an){if(i||r.signalingState!=="stable"&&!l){if(e)return;await Me([r.setLocalDescription({type:"rollback"}),r.setRemoteDescription(c)])}else await r.setRemoteDescription(c);await r.setLocalDescription();const o=await f(r);return a.signal?.(o),o}else if(c.type===bs){l=!0;try{await r.setRemoteDescription(c)}finally{l=!1}}}catch(o){a.error?.(o)}},sendData:c=>u.send(c),destroy:()=>{u?.close(),r.close(),i=!1,l=!1},setHandlers:c=>Object.assign(a,c),offerPromise:e?new Promise(c=>a.signal=o=>{o.type===an&&c(o)}):Promise.resolve(),addStream:c=>c.getTracks().forEach(o=>r.addTrack(o,c)),removeStream:c=>r.getSenders().filter(o=>c.getTracks().includes(o.track)).forEach(o=>r.removeTrack(o)),addTrack:(c,o)=>r.addTrack(c,o),removeTrack:c=>{const o=r.getSenders().find(p=>p.track===c);o&&r.removeTrack(o)},replaceTrack:(c,o)=>{const p=r.getSenders().find(A=>A.track===c);if(p)return p.replaceTrack(o)}}},As=[...ot(3,(e,t)=>`stun:stun${t||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(e=>({urls:e})),Es=Object.getPrototypeOf(Uint8Array),Et=12,Pn=0,Mt=Pn+Et,kt=Mt+1,et=kt+1,tt=et+1,Ee=16*2**10-tt,wt=255,ln="bufferedamountlow",Ie=e=>"@_"+e,Ms=(e,t,n)=>{const s={},r={},a={},i={},l={},u={},h={},f={onPeerJoin:pe,onPeerLeave:pe,onPeerStream:pe,onPeerTrack:pe},c=(d,m)=>(d?Array.isArray(d)?d:[d]:rs(s)).flatMap(T=>{const R=s[T];return R?m(T,R):(console.warn(`${at}: no peer with id ${T} found`),[])}),o=d=>{s[d]&&(s[d].destroy(),delete s[d],delete i[d],delete l[d],f.onPeerLeave(d),t(d))},p=d=>{if(r[d])return a[d];if(!d)throw he("action type argument is required");const m=De(d);if(m.byteLength>Et)throw he(`action type string "${d}" (${m.byteLength}b) exceeds byte limit (${Et}). Hint: choose a shorter name.`);const T=new Uint8Array(Et);T.set(m);let R=0;return r[d]={onComplete:pe,onProgress:pe,setOnComplete:D=>r[d]={...r[d],onComplete:D},setOnProgress:D=>r[d]={...r[d],onProgress:D},send:async(D,g,b,F)=>{if(b&&typeof b!="object")throw he("action meta argument must be an object");const Y=typeof D;if(Y==="undefined")throw he("action data cannot be undefined");const J=Y!=="string",ie=D instanceof Blob,P=ie||D instanceof ArrayBuffer||D instanceof Es;if(b&&!P)throw he("action meta argument can only be used with binary data");const K=P?new Uint8Array(ie?await D.arrayBuffer():D):De(J?it(D):D),re=b?De(it(b)):null,$=Math.ceil(K.byteLength/Ee)+(b?1:0)||1,G=ot($,(W,X)=>{const le=X===$-1,ue=b&&X===0,ce=new Uint8Array(tt+(ue?re.byteLength:le?K.byteLength-Ee*($-(b?2:1)):Ee));return ce.set(T),ce.set([R],Mt),ce.set([le|ue<<1|P<<2|J<<3],kt),ce.set([Math.round((X+1)/$*wt)],et),ce.set(b?ue?re:K.subarray((X-1)*Ee,X*Ee):K.subarray(X*Ee,(X+1)*Ee),tt),ce});return R=R+1&wt,Me(c(g,async(W,X)=>{const{channel:le}=X;let ue=0;for(;ue<$;){const ce=G[ue];if(le.bufferedAmount>le.bufferedAmountLowThreshold&&await new Promise(zn=>{const en=()=>{le.removeEventListener(ln,en),zn()};le.addEventListener(ln,en)}),!s[W])break;X.sendData(ce),ue++,F?.(ce[et]/wt,W,b)}}))}},a[d]||=[r[d].send,r[d].setOnComplete,r[d].setOnProgress]},A=(d,m)=>{const T=new Uint8Array(m),R=At(T.subarray(Pn,Mt)).replaceAll("\0",""),[D]=T.subarray(Mt,kt),[g]=T.subarray(kt,et),[b]=T.subarray(et,tt),F=T.subarray(tt),Y=!!(g&1),J=!!(g&2),ie=!!(g&4),P=!!(g&8);if(!r[R]){console.warn(`${at}: received message with unregistered type (${R})`);return}i[d]||={},i[d][R]||={};const K=i[d][R][D]||={chunks:[]};if(J?K.meta=lt(At(F)):K.chunks.push(F),r[R].onProgress(b/wt,d,K.meta),!Y)return;const re=new Uint8Array(K.chunks.reduce(($,G)=>$+G.byteLength,0));if(K.chunks.reduce(($,G)=>(re.set(G,$),$+G.byteLength),0),delete i[d][R][D],ie)r[R].onComplete(re,d,K.meta);else{const $=At(re);r[R].onComplete(P?lt($):$,d)}},k=async()=>{await x(""),await new Promise(d=>setTimeout(d,99)),Ht(s).forEach(([d,m])=>{m.destroy(),delete s[d]}),n()},[E,M]=p(Ie("ping")),[V,I]=p(Ie("pong")),[O,_]=p(Ie("signal")),[U,q]=p(Ie("stream")),[z,v]=p(Ie("track")),[x,ne]=p(Ie("leave"));return e((d,m)=>{s[m]||(s[m]=d,d.setHandlers({data:T=>A(m,T),stream:T=>{f.onPeerStream(T,m,u[m]),delete u[m]},track:(T,R)=>{f.onPeerTrack(T,R,m,h[m]),delete h[m]},signal:T=>O(T,m),close:()=>o(m),error:T=>{console.error(T),o(m)}}),f.onPeerJoin(m))}),M((d,m)=>V("",m)),I((d,m)=>{l[m]?.(),delete l[m]}),_((d,m)=>s[m]?.signal(d)),q((d,m)=>u[m]=d),v((d,m)=>h[m]=d),ne((d,m)=>o(m)),Rn&&addEventListener("beforeunload",k),{makeAction:p,leave:k,ping:async d=>{if(!d)throw he("ping() must be called with target peer ID");const m=Date.now();return E("",d),await new Promise(T=>l[d]=T),Date.now()-m},getPeers:()=>Cn(Ht(s).map(([d,m])=>[d,m.connection])),addStream:(d,m,T)=>c(m,async(R,D)=>{T&&await U(T,R),D.addStream(d)}),removeStream:(d,m)=>c(m,(T,R)=>R.removeStream(d)),addTrack:(d,m,T,R)=>c(T,async(D,g)=>{R&&await z(R,D),g.addTrack(d,m)}),removeTrack:(d,m)=>c(m,(T,R)=>R.removeTrack(d)),replaceTrack:(d,m,T,R)=>c(T,async(D,g)=>{R&&await z(R,D),g.replaceTrack(d,m)}),onPeerJoin:d=>f.onPeerJoin=d,onPeerLeave:d=>f.onPeerLeave=d,onPeerStream:d=>f.onPeerStream=d,onPeerTrack:d=>f.onPeerTrack=d}},ks=20,Ts=5333,un=57333,xs=({init:e,subscribe:t,announce:n})=>{const s={};let r=!1,a,i,l,u;return(h,f,c)=>{const{appId:o}=h;if(s[o]?.[f])return s[o][f];const p={},A={},k=yt(at,o,f),E=Ze(k),M=Ze(yt(k,Pe)),V=gs(h.password||"",o,f),I=g=>async b=>({type:b.type,sdp:await g(V,b.sdp)}),O=I(vs),_=I(ys),U=()=>on(!0,h),q=(g,b,F)=>{if(A[b]){A[b]!==g&&g.destroy();return}A[b]=g,D(g,b),p[b]?.forEach((Y,J)=>{J!==F&&Y.destroy()}),delete p[b]},z=(g,b)=>{A[b]===g&&delete A[b]},v=(g,b)=>{if(A[g])return;const F=p[g]?.[b];F&&(delete p[g][b],F.destroy())},x=g=>(i.push(...ot(g,U)),Me(i.splice(0,g).map(b=>b.offerPromise.then(_).then(F=>({peer:b,offer:F}))))),ne=(g,b)=>c?.({error:`incorrect password (${h.password}) when decrypting ${b}`,appId:o,peerId:g,roomId:f}),d=g=>async(b,F,Y)=>{const[J,ie]=await Me([E,M]);if(b!==J&&b!==ie)return;const{peerId:P,offer:K,answer:re,peer:$}=typeof F=="string"?lt(F):F;if(!(P===Pe||A[P])){if(P&&!K&&!re){if(p[P]?.[g])return;const[[{peer:G,offer:W}],X]=await Me([x(1),Ze(yt(k,P))]);p[P]||=[],p[P][g]=G,setTimeout(()=>v(P,g),m[g]*.9),G.setHandlers({connect:()=>q(G,P,g),close:()=>z(G,P)}),Y(X,it({peerId:Pe,offer:W}))}else if(K){if(p[P]?.[g]&&Pe>P)return;const W=on(!1,h);W.setHandlers({connect:()=>q(W,P,g),close:()=>z(W,P)});let X;try{X=await O(K)}catch{ne(P,"offer");return}if(W.isDead)return;const[le,ue]=await Me([Ze(yt(k,P)),W.signal(X)]);Y(le,it({peerId:Pe,answer:await _(ue)}))}else if(re){let G;try{G=await O(re)}catch{ne(P,"answer");return}if($)$.setHandlers({connect:()=>q($,P,g),close:()=>z($,P)}),$.signal(G);else{const W=p[P]?.[g];W&&!W.isDead&&W.signal(G)}}}};if(!h)throw he("requires a config map as the first argument");if(!o&&!h.firebaseApp)throw he("config map is missing appId field");if(!f)throw he("roomId argument required");if(!r){const g=e(h);i=ot(ks,U),a=Array.isArray(g)?g:[g],r=!0,l=setInterval(()=>i=i.filter(b=>{const F=Date.now()-b.created<un;return F||b.destroy(),F}),un*1.03),u=h.manualRelayReconnection?pe:fs()}const m=a.map(()=>Ts),T=[],R=a.map(async(g,b)=>t(await g,await E,await M,d(b),x));Me([E,M]).then(([g,b])=>{const F=async(Y,J)=>{const ie=await n(Y,g,b);typeof ie=="number"&&(m[J]=ie),T[J]=setTimeout(()=>F(Y,J),m[J])};R.forEach(async(Y,J)=>{await Y,F(await a[J],J)})});let D=pe;return s[o]||={},s[o][f]=Ms(g=>D=g,g=>delete A[g],()=>{delete s[o][f],T.forEach(clearTimeout),R.forEach(async g=>(await g)()),clearInterval(l),u(),r=!1})}},Lt={},Nn={},Xe={},Ye={},Qe={},cn={},bt={},Ss="announce",Ln=20,fn=10,Os=33333,Rs=120333,Cs=3,_s=async e=>{if(Lt[e])return Lt[e];const t=(await Ze(e)).slice(0,Ln);return Lt[e]=t,Nn[t]=e,t},pn=async(e,t,n)=>e.send(it({action:Ss,info_hash:await _s(t),peer_id:Pe,...n})),hn=(e,t,n)=>console.warn(`${at}: torrent tracker ${n?"failure":"warning"} from ${e} - ${t}`),Un=xs({init:e=>is(e,Is,Cs).map(t=>{const n=cs(t,r=>{const a=lt(r),i=a["failure reason"],l=a["warning message"],{interval:u}=a,h=Nn[a.info_hash];if(i){hn(s,i,!0);return}if(l&&hn(s,l),u&&u*1e3>Qe[s]&&Ye[s][h]){const f=Math.min(u*1e3,Rs);clearInterval(Xe[s][h]),Qe[s]=f,Xe[s][h]=setInterval(Ye[s][h],f)}cn[a.offer_id]||(a.offer||a.answer)&&(cn[a.offer_id]=!0,bt[s][h]?.(a))}),{url:s}=n;return bt[s]={},n.ready}),subscribe:(e,t,n,s,r)=>{const{url:a}=e,i=async()=>{const l=Cn((await r(fn)).map(u=>[On(Ln),u]));bt[e.url][t]=u=>{if(u.offer)s(t,{offer:u.offer,peerId:u.peer_id},(h,f)=>pn(e,t,{answer:lt(f).answer,offer_id:u.offer_id,to_peer_id:u.peer_id}));else if(u.answer){const h=l[u.offer_id];h&&s(t,{answer:u.answer,peerId:u.peer_id,peer:h.peer})}},pn(e,t,{numwant:fn,offers:Ht(l).map(([u,{offer:h}])=>({offer_id:u,offer:h}))})};return Qe[a]=Os,Ye[a]||={},Ye[a][t]=i,Xe[a]||={},Xe[a][t]=setInterval(i,Qe[a]),i(),()=>{clearInterval(Xe[a][t]),delete bt[a][t],delete Ye[a][t]}},announce:e=>Qe[e.url]}),Is=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(e=>"wss://"+e);var te="INUMBER",je="IOP1",Je="IOP2",Ge="IOP3",me="IVAR",Oe="IVARNAME",Fe="IFUNCALL",Tt="IFUNDEF",Q="IEXPR",Jt="IEXPREVAL",Re="IMEMBER",xt="IENDSTATEMENT",Ve="IARRAY";function S(e,t){this.type=e,this.value=t??0}S.prototype.toString=function(){switch(this.type){case te:case je:case Je:case Ge:case me:case Oe:case xt:return this.value;case Fe:return"CALL "+this.value;case Tt:return"DEF "+this.value;case Ve:return"ARRAY "+this.value;case Re:return"."+this.value;default:return"Invalid Instruction"}};function St(e){return new S(je,e)}function ye(e){return new S(Je,e)}function Dn(e){return new S(Ge,e)}function Vt(e,t,n,s,r){for(var a=[],i=[],l,u,h,f,c=0;c<e.length;c++){var o=e[c],p=o.type;if(p===te||p===Oe)Array.isArray(o.value)?a.push.apply(a,Vt(o.value.map(function(A){return new S(te,A)}).concat(new S(Ve,o.value.length)),t,n,s,r)):a.push(o);else if(p===me&&r.hasOwnProperty(o.value))o=new S(te,r[o.value]),a.push(o);else if(p===Je&&a.length>1)u=a.pop(),l=a.pop(),f=n[o.value],o=new S(te,f(l.value,u.value)),a.push(o);else if(p===Ge&&a.length>2)h=a.pop(),u=a.pop(),l=a.pop(),o.value==="?"?a.push(l.value?u.value:h.value):(f=s[o.value],o=new S(te,f(l.value,u.value,h.value)),a.push(o));else if(p===je&&a.length>0)l=a.pop(),f=t[o.value],o=new S(te,f(l.value)),a.push(o);else if(p===Q){for(;a.length>0;)i.push(a.shift());i.push(new S(Q,Vt(o.value,t,n,s,r)))}else if(p===Re&&a.length>0)l=a.pop(),a.push(new S(te,l.value[o.value]));else{for(;a.length>0;)i.push(a.shift());i.push(o)}}for(;a.length>0;)i.push(a.shift());return i}function qn(e,t,n){for(var s=[],r=0;r<e.length;r++){var a=e[r],i=a.type;if(i===me&&a.value===t)for(var l=0;l<n.tokens.length;l++){var u=n.tokens[l],h;u.type===je?h=St(u.value):u.type===Je?h=ye(u.value):u.type===Ge?h=Dn(u.value):h=new S(u.type,u.value),s.push(h)}else i===Q?s.push(new S(Q,qn(a.value,t,n))):s.push(a)}return s}function ke(e,t,n){var s=[],r,a,i,l,u,h;if(Gt(e))return fe(e,n);for(var f=e.length,c=0;c<f;c++){var o=e[c],p=o.type;if(p===te||p===Oe)s.push(o.value);else if(p===Je)a=s.pop(),r=s.pop(),o.value==="and"?s.push(r?!!ke(a,t,n):!1):o.value==="or"?s.push(r?!0:!!ke(a,t,n)):o.value==="="?(l=t.binaryOps[o.value],s.push(l(r,ke(a,t,n),n))):(l=t.binaryOps[o.value],s.push(l(fe(r,n),fe(a,n))));else if(p===Ge)i=s.pop(),a=s.pop(),r=s.pop(),o.value==="?"?s.push(ke(r?a:i,t,n)):(l=t.ternaryOps[o.value],s.push(l(fe(r,n),fe(a,n),fe(i,n))));else if(p===me)if(o.value in t.functions)s.push(t.functions[o.value]);else if(o.value in t.unaryOps&&t.parser.isOperatorEnabled(o.value))s.push(t.unaryOps[o.value]);else{var A=n[o.value];if(A!==void 0)s.push(A);else throw new Error("undefined variable: "+o.value)}else if(p===je)r=s.pop(),l=t.unaryOps[o.value],s.push(l(fe(r,n)));else if(p===Fe){for(h=o.value,u=[];h-- >0;)u.unshift(fe(s.pop(),n));if(l=s.pop(),l.apply&&l.call)s.push(l.apply(void 0,u));else throw new Error(l+" is not a function")}else if(p===Tt)s.push((function(){for(var k=s.pop(),E=[],M=o.value;M-- >0;)E.unshift(s.pop());var V=s.pop(),I=function(){for(var O=Object.assign({},n),_=0,U=E.length;_<U;_++)O[E[_]]=arguments[_];return ke(k,t,O)};return Object.defineProperty(I,"name",{value:V,writable:!1}),n[V]=I,I})());else if(p===Q)s.push(Ps(o,t));else if(p===Jt)s.push(o);else if(p===Re)r=s.pop(),s.push(r[o.value]);else if(p===xt)s.pop();else if(p===Ve){for(h=o.value,u=[];h-- >0;)u.unshift(s.pop());s.push(u)}else throw new Error("invalid Expression")}if(s.length>1)throw new Error("invalid Expression (parity)");return s[0]===0?0:fe(s[0],n)}function Ps(e,t,n){return Gt(e)?e:{type:Jt,value:function(s){return ke(e.value,t,s)}}}function Gt(e){return e&&e.type===Jt}function fe(e,t){return Gt(e)?e.value(t):e}function Wt(e,t){for(var n=[],s,r,a,i,l,u,h=0;h<e.length;h++){var f=e[h],c=f.type;if(c===te)typeof f.value=="number"&&f.value<0?n.push("("+f.value+")"):Array.isArray(f.value)?n.push("["+f.value.map(dn).join(", ")+"]"):n.push(dn(f.value));else if(c===Je)r=n.pop(),s=n.pop(),i=f.value,t?i==="^"?n.push("Math.pow("+s+", "+r+")"):i==="and"?n.push("(!!"+s+" && !!"+r+")"):i==="or"?n.push("(!!"+s+" || !!"+r+")"):i==="||"?n.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+s+"),("+r+")))"):i==="=="?n.push("("+s+" === "+r+")"):i==="!="?n.push("("+s+" !== "+r+")"):i==="["?n.push(s+"[("+r+") | 0]"):n.push("("+s+" "+i+" "+r+")"):i==="["?n.push(s+"["+r+"]"):n.push("("+s+" "+i+" "+r+")");else if(c===Ge)if(a=n.pop(),r=n.pop(),s=n.pop(),i=f.value,i==="?")n.push("("+s+" ? "+r+" : "+a+")");else throw new Error("invalid Expression");else if(c===me||c===Oe)n.push(f.value);else if(c===je)s=n.pop(),i=f.value,i==="-"||i==="+"?n.push("("+i+s+")"):t?i==="not"?n.push("(!"+s+")"):i==="!"?n.push("fac("+s+")"):n.push(i+"("+s+")"):i==="!"?n.push("("+s+"!)"):n.push("("+i+" "+s+")");else if(c===Fe){for(u=f.value,l=[];u-- >0;)l.unshift(n.pop());i=n.pop(),n.push(i+"("+l.join(", ")+")")}else if(c===Tt){for(r=n.pop(),u=f.value,l=[];u-- >0;)l.unshift(n.pop());s=n.pop(),t?n.push("("+s+" = function("+l.join(", ")+") { return "+r+" })"):n.push("("+s+"("+l.join(", ")+") = "+r+")")}else if(c===Re)s=n.pop(),n.push(s+"."+f.value);else if(c===Ve){for(u=f.value,l=[];u-- >0;)l.unshift(n.pop());n.push("["+l.join(", ")+"]")}else if(c===Q)n.push("("+Wt(f.value,t)+")");else if(c!==xt)throw new Error("invalid Expression")}return n.length>1&&(t?n=[n.join(",")]:n=[n.join(";")]),String(n[0])}function dn(e){return typeof e=="string"?JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):e}function Le(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1}function zt(e,t,n){n=n||{};for(var s=!!n.withMembers,r=null,a=0;a<e.length;a++){var i=e[a];i.type===me||i.type===Oe?!s&&!Le(t,i.value)?t.push(i.value):(r!==null&&(Le(t,r)||t.push(r)),r=i.value):i.type===Re&&s&&r!==null?r+="."+i.value:i.type===Q?zt(i.value,t,n):r!==null&&(Le(t,r)||t.push(r),r=null)}r!==null&&!Le(t,r)&&t.push(r)}function se(e,t){this.tokens=e,this.parser=t,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.functions=t.functions}se.prototype.simplify=function(e){return e=e||{},new se(Vt(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,e),this.parser)};se.prototype.substitute=function(e,t){return t instanceof se||(t=this.parser.parse(String(t))),new se(qn(this.tokens,e,t),this.parser)};se.prototype.evaluate=function(e){return e=e||{},ke(this.tokens,this,e)};se.prototype.toString=function(){return Wt(this.tokens,!1)};se.prototype.symbols=function(e){e=e||{};var t=[];return zt(this.tokens,t,e),t};se.prototype.variables=function(e){e=e||{};var t=[];zt(this.tokens,t,e);var n=this.functions;return t.filter(function(s){return!(s in n)})};se.prototype.toJSFunction=function(e,t){var n=this,s=new Function(e,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+Wt(this.simplify(t).tokens,!0)+"; }");return function(){return s.apply(n,arguments)}};var ut="TEOF",N="TOP",Ot="TNUMBER",Hn="TSTRING",ge="TPAREN",$e="TBRACKET",Rt="TCOMMA",Kt="TNAME",Xt="TSEMICOLON";function Fn(e,t,n){this.type=e,this.value=t,this.index=n}Fn.prototype.toString=function(){return this.type+": "+this.value};function H(e,t){this.pos=0,this.current=null,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.consts=e.consts,this.expression=t,this.savedPosition=0,this.savedCurrent=null,this.options=e.options,this.parser=e}H.prototype.newToken=function(e,t,n){return new Fn(e,t,n??this.pos)};H.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};H.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};H.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(ut,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};H.prototype.isString=function(){var e=!1,t=this.pos,n=this.expression.charAt(t);if(n==="'"||n==='"')for(var s=this.expression.indexOf(n,t+1);s>=0&&this.pos<this.expression.length;){if(this.pos=s+1,this.expression.charAt(s-1)!=="\\"){var r=this.expression.substring(t+1,s);this.current=this.newToken(Hn,this.unescape(r),t),e=!0;break}s=this.expression.indexOf(n,s+1)}return e};H.prototype.isParen=function(){var e=this.expression.charAt(this.pos);return e==="("||e===")"?(this.current=this.newToken(ge,e),this.pos++,!0):!1};H.prototype.isBracket=function(){var e=this.expression.charAt(this.pos);return(e==="["||e==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken($e,e),this.pos++,!0):!1};H.prototype.isComma=function(){var e=this.expression.charAt(this.pos);return e===","?(this.current=this.newToken(Rt,","),this.pos++,!0):!1};H.prototype.isSemicolon=function(){var e=this.expression.charAt(this.pos);return e===";"?(this.current=this.newToken(Xt,";"),this.pos++,!0):!1};H.prototype.isConst=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()&&(t===this.pos||n!=="_"&&n!=="."&&(n<"0"||n>"9")))break}if(t>e){var s=this.expression.substring(e,t);if(s in this.consts)return this.current=this.newToken(Ot,this.consts[s]),this.pos+=s.length,!0}return!1};H.prototype.isNamedOp=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()&&(t===this.pos||n!=="_"&&(n<"0"||n>"9")))break}if(t>e){var s=this.expression.substring(e,t);if(this.isOperatorEnabled(s)&&(s in this.binaryOps||s in this.unaryOps||s in this.ternaryOps))return this.current=this.newToken(N,s),this.pos+=s.length,!0}return!1};H.prototype.isName=function(){for(var e=this.pos,t=e,n=!1;t<this.expression.length;t++){var s=this.expression.charAt(t);if(s.toUpperCase()===s.toLowerCase()){if(t===this.pos&&(s==="$"||s==="_")){s==="_"&&(n=!0);continue}else if(t===this.pos||!n||s!=="_"&&(s<"0"||s>"9"))break}else n=!0}if(n){var r=this.expression.substring(e,t);return this.current=this.newToken(Kt,r),this.pos+=r.length,!0}return!1};H.prototype.isWhitespace=function(){for(var e=!1,t=this.expression.charAt(this.pos);(t===" "||t==="	"||t===`
`||t==="\r")&&(e=!0,this.pos++,!(this.pos>=this.expression.length));)t=this.expression.charAt(this.pos);return e};var Ns=/^[0-9a-f]{4}$/i;H.prototype.unescape=function(e){var t=e.indexOf("\\");if(t<0)return e;for(var n=e.substring(0,t);t>=0;){var s=e.charAt(++t);switch(s){case"'":n+="'";break;case'"':n+='"';break;case"\\":n+="\\";break;case"/":n+="/";break;case"b":n+="\b";break;case"f":n+="\f";break;case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"u":var r=e.substring(t+1,t+5);Ns.test(r)||this.parseError("Illegal escape sequence: \\u"+r),n+=String.fromCharCode(parseInt(r,16)),t+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+s+'"')}++t;var a=e.indexOf("\\",t);n+=e.substring(t,a<0?e.length:a),t=a}return n};H.prototype.isComment=function(){var e=this.expression.charAt(this.pos);return e==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};H.prototype.isRadixInteger=function(){var e=this.pos;if(e>=this.expression.length-2||this.expression.charAt(e)!=="0")return!1;++e;var t,n;if(this.expression.charAt(e)==="x")t=16,n=/^[0-9a-f]$/i,++e;else if(this.expression.charAt(e)==="b")t=2,n=/^[01]$/i,++e;else return!1;for(var s=!1,r=e;e<this.expression.length;){var a=this.expression.charAt(e);if(n.test(a))e++,s=!0;else break}return s&&(this.current=this.newToken(Ot,parseInt(this.expression.substring(r,e),t)),this.pos=e),s};H.prototype.isNumber=function(){for(var e=!1,t=this.pos,n=t,s=t,r=!1,a=!1,i;t<this.expression.length&&(i=this.expression.charAt(t),i>="0"&&i<="9"||!r&&i===".");)i==="."?r=!0:a=!0,t++,e=a;if(e&&(s=t),i==="e"||i==="E"){t++;for(var l=!0,u=!1;t<this.expression.length;){if(i=this.expression.charAt(t),l&&(i==="+"||i==="-"))l=!1;else if(i>="0"&&i<="9")u=!0,l=!1;else break;t++}u||(t=s)}return e?(this.current=this.newToken(Ot,parseFloat(this.expression.substring(n,t))),this.pos=t):this.pos=s,e};H.prototype.isOperator=function(){var e=this.pos,t=this.expression.charAt(this.pos);if(t==="+"||t==="-"||t==="*"||t==="/"||t==="%"||t==="^"||t==="?"||t===":"||t===".")this.current=this.newToken(N,t);else if(t==="∙"||t==="•")this.current=this.newToken(N,"*");else if(t===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(N,">="),this.pos++):this.current=this.newToken(N,">");else if(t==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(N,"<="),this.pos++):this.current=this.newToken(N,"<");else if(t==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(N,"||"),this.pos++;else return!1;else if(t==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(N,"=="),this.pos++):this.current=this.newToken(N,t);else if(t==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(N,"!="),this.pos++):this.current=this.newToken(N,t);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=e,!1)};H.prototype.isOperatorEnabled=function(e){return this.parser.isOperatorEnabled(e)};H.prototype.getCoordinates=function(){var e=0,t,n=-1;do e++,t=this.pos-n,n=this.expression.indexOf(`
`,n+1);while(n>=0&&n<this.pos);return{line:e,column:t}};H.prototype.parseError=function(e){var t=this.getCoordinates();throw new Error("parse error ["+t.line+":"+t.column+"]: "+e)};function L(e,t,n){this.parser=e,this.tokens=t,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=n.allowMemberAccess!==!1}L.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};L.prototype.tokenMatches=function(e,t){return typeof t>"u"?!0:Array.isArray(t)?Le(t,e.value):typeof t=="function"?t(e):e.value===t};L.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};L.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};L.prototype.accept=function(e,t){return this.nextToken.type===e&&this.tokenMatches(this.nextToken,t)?(this.next(),!0):!1};L.prototype.expect=function(e,t){if(!this.accept(e,t)){var n=this.tokens.getCoordinates();throw new Error("parse error ["+n.line+":"+n.column+"]: Expected "+(t||e))}};L.prototype.parseAtom=function(e){var t=this.tokens.unaryOps;function n(r){return r.value in t}if(this.accept(Kt)||this.accept(N,n))e.push(new S(me,this.current.value));else if(this.accept(Ot))e.push(new S(te,this.current.value));else if(this.accept(Hn))e.push(new S(te,this.current.value));else if(this.accept(ge,"("))this.parseExpression(e),this.expect(ge,")");else if(this.accept($e,"["))if(this.accept($e,"]"))e.push(new S(Ve,0));else{var s=this.parseArrayList(e);e.push(new S(Ve,s))}else throw new Error("unexpected "+this.nextToken)};L.prototype.parseExpression=function(e){var t=[];this.parseUntilEndStatement(e,t)||(this.parseVariableAssignmentExpression(t),!this.parseUntilEndStatement(e,t)&&this.pushExpression(e,t))};L.prototype.pushExpression=function(e,t){for(var n=0,s=t.length;n<s;n++)e.push(t[n])};L.prototype.parseUntilEndStatement=function(e,t){return this.accept(Xt)?(this.nextToken&&this.nextToken.type!==ut&&!(this.nextToken.type===ge&&this.nextToken.value===")")&&t.push(new S(xt)),this.nextToken.type!==ut&&this.parseExpression(t),e.push(new S(Q,t)),!0):!1};L.prototype.parseArrayList=function(e){for(var t=0;!this.accept($e,"]");)for(this.parseExpression(e),++t;this.accept(Rt);)this.parseExpression(e),++t;return t};L.prototype.parseVariableAssignmentExpression=function(e){for(this.parseConditionalExpression(e);this.accept(N,"=");){var t=e.pop(),n=[],s=e.length-1;if(t.type===Fe){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var r=0,a=t.value+1;r<a;r++){var i=s-r;e[i].type===me&&(e[i]=new S(Oe,e[i].value))}this.parseVariableAssignmentExpression(n),e.push(new S(Q,n)),e.push(new S(Tt,t.value));continue}if(t.type!==me&&t.type!==Re)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(n),e.push(new S(Oe,t.value)),e.push(new S(Q,n)),e.push(ye("="))}};L.prototype.parseConditionalExpression=function(e){for(this.parseOrExpression(e);this.accept(N,"?");){var t=[],n=[];this.parseConditionalExpression(t),this.expect(N,":"),this.parseConditionalExpression(n),e.push(new S(Q,t)),e.push(new S(Q,n)),e.push(Dn("?"))}};L.prototype.parseOrExpression=function(e){for(this.parseAndExpression(e);this.accept(N,"or");){var t=[];this.parseAndExpression(t),e.push(new S(Q,t)),e.push(ye("or"))}};L.prototype.parseAndExpression=function(e){for(this.parseComparison(e);this.accept(N,"and");){var t=[];this.parseComparison(t),e.push(new S(Q,t)),e.push(ye("and"))}};var Ls=["==","!=","<","<=",">=",">","in"];L.prototype.parseComparison=function(e){for(this.parseAddSub(e);this.accept(N,Ls);){var t=this.current;this.parseAddSub(e),e.push(ye(t.value))}};var Us=["+","-","||"];L.prototype.parseAddSub=function(e){for(this.parseTerm(e);this.accept(N,Us);){var t=this.current;this.parseTerm(e),e.push(ye(t.value))}};var Ds=["*","/","%"];L.prototype.parseTerm=function(e){for(this.parseFactor(e);this.accept(N,Ds);){var t=this.current;this.parseFactor(e),e.push(ye(t.value))}};L.prototype.parseFactor=function(e){var t=this.tokens.unaryOps;function n(r){return r.value in t}if(this.save(),this.accept(N,n)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===ge&&this.nextToken.value==="("){this.restore(),this.parseExponential(e);return}else if(this.nextToken.type===Xt||this.nextToken.type===Rt||this.nextToken.type===ut||this.nextToken.type===ge&&this.nextToken.value===")"){this.restore(),this.parseAtom(e);return}}var s=this.current;this.parseFactor(e),e.push(St(s.value))}else this.parseExponential(e)};L.prototype.parseExponential=function(e){for(this.parsePostfixExpression(e);this.accept(N,"^");)this.parseFactor(e),e.push(ye("^"))};L.prototype.parsePostfixExpression=function(e){for(this.parseFunctionCall(e);this.accept(N,"!");)e.push(St("!"))};L.prototype.parseFunctionCall=function(e){var t=this.tokens.unaryOps;function n(a){return a.value in t}if(this.accept(N,n)){var s=this.current;this.parseAtom(e),e.push(St(s.value))}else for(this.parseMemberExpression(e);this.accept(ge,"(");)if(this.accept(ge,")"))e.push(new S(Fe,0));else{var r=this.parseArgumentList(e);e.push(new S(Fe,r))}};L.prototype.parseArgumentList=function(e){for(var t=0;!this.accept(ge,")");)for(this.parseExpression(e),++t;this.accept(Rt);)this.parseExpression(e),++t;return t};L.prototype.parseMemberExpression=function(e){for(this.parseAtom(e);this.accept(N,".")||this.accept($e,"[");){var t=this.current;if(t.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(Kt),e.push(new S(Re,this.current.value))}else if(t.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(e),this.expect($e,"]"),e.push(ye("["))}else throw new Error("unexpected symbol: "+t.value)}};function qs(e,t){return Number(e)+Number(t)}function Hs(e,t){return e-t}function Fs(e,t){return e*t}function Vs(e,t){return e/t}function $s(e,t){return e%t}function Bs(e,t){return Array.isArray(e)&&Array.isArray(t)?e.concat(t):""+e+t}function js(e,t){return e===t}function Js(e,t){return e!==t}function Gs(e,t){return e>t}function Ws(e,t){return e<t}function zs(e,t){return e>=t}function Ks(e,t){return e<=t}function Xs(e,t){return!!(e&&t)}function Ys(e,t){return!!(e||t)}function Qs(e,t){return Le(t,e)}function Zs(e){return(Math.exp(e)-Math.exp(-e))/2}function er(e){return(Math.exp(e)+Math.exp(-e))/2}function tr(e){return e===1/0?1:e===-1/0?-1:(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function nr(e){return e===-1/0?e:Math.log(e+Math.sqrt(e*e+1))}function sr(e){return Math.log(e+Math.sqrt(e*e-1))}function rr(e){return Math.log((1+e)/(1-e))/2}function mn(e){return Math.log(e)*Math.LOG10E}function ar(e){return-e}function or(e){return!e}function ir(e){return e<0?Math.ceil(e):Math.floor(e)}function lr(e){return Math.random()*(e||1)}function gn(e){return Yt(e+1)}function ur(e){return isFinite(e)&&e===Math.round(e)}var cr=4.7421875,Ut=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Yt(e){var t,n;if(ur(e)){if(e<=0)return isFinite(e)?1/0:NaN;if(e>171)return 1/0;for(var s=e-2,r=e-1;s>1;)r*=s,s--;return r===0&&(r=1),r}if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*Yt(1-e));if(e>=171.35)return 1/0;if(e>85){var a=e*e,i=a*e,l=i*e,u=l*e;return Math.sqrt(2*Math.PI/e)*Math.pow(e/Math.E,e)*(1+1/(12*e)+1/(288*a)-139/(51840*i)-571/(2488320*l)+163879/(209018880*u)+5246819/(75246796800*u*e))}--e,n=Ut[0];for(var h=1;h<Ut.length;++h)n+=Ut[h]/(e+h);return t=e+cr+.5,Math.sqrt(2*Math.PI)*Math.pow(t,e+.5)*Math.exp(-t)*n}function fr(e){return Array.isArray(e)?e.length:String(e).length}function yn(){for(var e=0,t=0,n=0;n<arguments.length;n++){var s=Math.abs(arguments[n]),r;t<s?(r=t/s,e=e*r*r+1,t=s):s>0?(r=s/t,e+=r*r):e+=s}return t===1/0?1/0:t*Math.sqrt(e)}function vn(e,t,n){return e?t:n}function pr(e,t){return typeof t>"u"||+t==0?Math.round(e):(e=+e,t=-+t,isNaN(e)||!(typeof t=="number"&&t%1===0)?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]+t:t))))}function hr(e,t,n){return n&&(n[e]=t),t}function dr(e,t){return e[t|0]}function mr(e){return arguments.length===1&&Array.isArray(e)?Math.max.apply(Math,e):Math.max.apply(Math,arguments)}function gr(e){return arguments.length===1&&Array.isArray(e)?Math.min.apply(Math,e):Math.min.apply(Math,arguments)}function yr(e,t){if(typeof e!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(t))throw new Error("Second argument to map is not an array");return t.map(function(n,s){return e(n,s)})}function vr(e,t,n){if(typeof e!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(n))throw new Error("Second argument to fold is not an array");return n.reduce(function(s,r,a){return e(s,r,a)},t)}function wr(e,t){if(typeof e!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(t))throw new Error("Second argument to filter is not an array");return t.filter(function(n,s){return e(n,s)})}function br(e,t){if(!(Array.isArray(t)||typeof t=="string"))throw new Error("Second argument to indexOf is not a string or array");return t.indexOf(e)}function Ar(e,t){if(!Array.isArray(t))throw new Error("Second argument to join is not an array");return t.join(e)}function Er(e){return(e>0)-(e<0)||+e}var wn=1/3;function Mr(e){return e<0?-Math.pow(-e,wn):Math.pow(e,wn)}function kr(e){return Math.exp(e)-1}function Tr(e){return Math.log(1+e)}function xr(e){return Math.log(e)/Math.LN2}function Ae(e){this.options=e||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||Zs,cosh:Math.cosh||er,tanh:Math.tanh||tr,asinh:Math.asinh||nr,acosh:Math.acosh||sr,atanh:Math.atanh||rr,sqrt:Math.sqrt,cbrt:Math.cbrt||Mr,log:Math.log,log2:Math.log2||xr,ln:Math.log,lg:Math.log10||mn,log10:Math.log10||mn,expm1:Math.expm1||kr,log1p:Math.log1p||Tr,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||ir,"-":ar,"+":Number,exp:Math.exp,not:or,length:fr,"!":gn,sign:Math.sign||Er},this.binaryOps={"+":qs,"-":Hs,"*":Fs,"/":Vs,"%":$s,"^":Math.pow,"||":Bs,"==":js,"!=":Js,">":Gs,"<":Ws,">=":zs,"<=":Ks,and:Xs,or:Ys,in:Qs,"=":hr,"[":dr},this.ternaryOps={"?":vn},this.functions={random:lr,fac:gn,min:gr,max:mr,hypot:Math.hypot||yn,pyt:Math.hypot||yn,pow:Math.pow,atan2:Math.atan2,if:vn,gamma:Yt,roundTo:pr,map:yr,fold:vr,filter:wr,indexOf:br,join:Ar},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}Ae.prototype.parse=function(e){var t=[],n=new L(this,new H(this,e),{allowMemberAccess:this.options.allowMemberAccess});return n.parseExpression(t),n.expect(ut,"EOF"),new se(t,this)};Ae.prototype.evaluate=function(e,t){return this.parse(e).evaluate(t)};var Vn=new Ae;Ae.parse=function(e){return Vn.parse(e)};Ae.evaluate=function(e,t){return Vn.parse(e).evaluate(t)};var bn={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function Sr(e){return bn.hasOwnProperty(e)?bn[e]:e}Ae.prototype.isOperatorEnabled=function(e){var t=Sr(e),n=this.options.operators||{};return!(t in n)||!!n[t]};const oa={NEXT_ROLL:"Próxima Rolagem",ROUNDS:"Rodadas",MINUTES:"Minutos",HOURS:"Horas",DAYS:"Dias",LUCK_ENDS:"Sorte Encerra",PERMANENT:"Indeterminado",END_OF_ROUND:"Fim da Rodada",CONCENTRATION:"Concentração"},qe={ADD:"ADD",SET:"SET",MULT:"MULT"},ia={str:"Força",agi:"Agilidade",int:"Intelecto",wil:"Vontade",defense:"Defesa",speed:"Deslocamento",health:"Vida",damage:"Dano (Dados)",boons:"Boons/Banes",healing_rate:"Taxa de Cura"},ve={WEAPON:"Weapon",ARMOR:"Armor",SHIELD:"Shield",CONSUMABLE:"Consumable",EXPLOSIVE:"Explosive",OTHER:"Other"},la=["Aeromancy","Alchemy","Alteration","Animism","Astromancy","Chaos","Chronomancy","Conjuration","Cryomancy","Dark Arts","Destruction","Divination","Eldritch","Enchantment","Evocation","Geomancy","Hydromancy","Illusion","Invocation","Necromancy","Oneiromancy","Order","Primal","Protection","Psychomancy","Pyromancy","Shadowmancy","Skullduggery","Spiritualism","Symbolism","Technomancy","Teleportation","War"],Or=[[1,0,0,0,0,0,0,0,0,0,0],[2,1,0,0,0,0,0,0,0,0,0],[3,2,1,0,0,0,0,0,0,0,0],[4,2,1,1,0,0,0,0,0,0,0],[5,2,2,1,1,0,0,0,0,0,0],[6,3,2,2,1,1,0,0,0,0,0],[7,3,2,2,2,1,1,0,0,0,0],[8,3,2,2,2,1,1,1,0,0,0],[9,3,3,2,2,2,1,1,1,0,0],[10,3,3,3,2,2,1,1,1,1,0],[11,3,3,3,3,2,1,1,1,1,1]],ua=["Air","Alteration","Arcana","Battle","Celestial","Chaos","Conjuration","Curse","Death","Demonology","Destruction","Divination","Enchantment","Ether","Fey","Fire","Forbidden","Illusion","Life","Metal","Nature","Necromancy","Order","Primal","Protection","Rune","Shadow","Song","Soul","Spiritualism","Storm","Technomancy","Telekinesis","Telepathy","Teleportation","Theurgy","Time","Transformation","Water"];function ca(e,t){return e<0||e>10||t<0||t>10?0:Or[e]?.[t]??0}const Rr=new Ae,$n={name:"",level:1,ancestry:"",paths:{novice:"",expert:"",master:""},attributes:[{name:"Strength",value:10,key:"str"},{name:"Agility",value:10,key:"agi"},{name:"Intellect",value:10,key:"int"},{name:"Will",value:10,key:"wil"}],currency:{gp:0,sp:0,cp:0},naturalDefense:10,bonusDamage:0,size:1,speed:10,currentRound:1,languages:[],professions:[],senses:[],afflictions:[],effects:[],notes:"",campaignId:null,campaignName:null,gmName:null,combatActive:!1,initiative:!1,acted:!1,spells:[],talents:[],equipment:[]},y=Z(JSON.parse(JSON.stringify($n))),rt=Z([]),He=Z({type:null,isOpen:!1,data:null}),Cr=Z("acoes"),Ct=Z(24),Ce=Z(24),We=Z(0),Be=Z(!1),_t=Z(!1),An={autoOpenHistory:!1,stickyHistory:!1,theme:"dark",userName:"",enable3DDice:!1,diceTheme:"default"};function _r(){const e=typeof localStorage<"u"?localStorage.getItem("wwv_app_settings"):null,{subscribe:t,set:n,update:s}=Z(e?{...An,...JSON.parse(e)}:An);return{subscribe:t,set:r=>{typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(r)),n(r)},update:r=>{s(a=>{const i=r(a);return typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(i)),i})}}}const Qt=_r();Be.subscribe(e=>{e&&_t.set(!1)});const ze=B(y,e=>{const t=e.effects.filter(s=>s.isActive),n=e.talents.filter(s=>(s.isPassive||s.activityType==="Passive")&&s.effect).map(s=>({...s.effect,id:`talent-effect-${s.id}`,name:s.name,sourceType:"talent",sourceId:s.id}));return[...t,...n]});function Se(e,t){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim();if(!isNaN(Number(n)))return Number(n);try{const s={};Array.isArray(t.attributes)&&t.attributes.forEach(a=>{s[a.key]=a.value}),s.level=t.level||0,s.defense=t.naturalDefense||0,s.speed=t.speed||0,s.bonusDamage=t.bonusDamage||0,s.currentRound=t.currentRound||0;const r=n.replace(/@(\w+)/g,"$1");return Rr.evaluate(r,s)}catch{return 0}}function It(e,t,n,s){let r=t||0;const a=n.flatMap(h=>Array.isArray(h.modifiers)?h.modifiers:[]),i=a.filter(h=>h.target===e&&h.type===qe.SET);return i.length>0&&(r=Se(i[i.length-1].value,s)),a.filter(h=>h.target===e&&h.type===qe.ADD).forEach(h=>{r+=Se(h.value,s)}),a.filter(h=>h.target===e&&h.type===qe.MULT).forEach(h=>{r*=Se(h.value,s)}),Math.floor(r)}const Zt=B([y,ze],([e,t])=>{const n={};return Array.isArray(e.attributes)&&e.attributes.forEach(s=>{n[s.key]=It(s.key,s.value,t,e)}),n}),Bn=B([y,Ce,ze],([e,t,n])=>It("health",t,n,e)),Ir=B([Bn,Ct],([e,t])=>Math.max(0,e-t)),Pr=B([We,Ce],([e,t])=>t>0?Math.min(100,e/t*100):100),jn=B([We,Ce],([e,t])=>e>=t),Nr=B([We,Ce,jn],([e,t,n])=>e>=t/2&&!n),Lr=B([y,Zt,ze],([e,t,n])=>{let s=It("speed",e.speed,n,e);const r=e.afflictions;return r.includes("Held")||r.includes("Stunned")||r.includes("Unconscious")||r.includes("Incapacitated")?0:((r.includes("Blinded")||r.includes("Weakened"))&&(s=Math.floor(s/2)),r.includes("Slowed")&&(s=Math.min(s,2)),Math.max(0,s))}),Ur=B([y,ze],([e,t])=>{let n=e.naturalDefense,s=0;const r=e.equipment.find(a=>a.type===ve.ARMOR&&a.equipped);if(r){const a=r.defenseFixed||0,i=e.naturalDefense+(r.defenseMod||0);r.defenseFixed&&r.defenseMod?n=Math.max(a,i):r.defenseFixed?n=a:r.defenseMod&&(n=e.naturalDefense+r.defenseMod)}return e.equipment.filter(a=>a.type===ve.SHIELD&&a.equippedState).forEach(a=>{s+=a.defenseMod||0}),It("defense",n+s,t,e)});B([y,ze],([e,t])=>{const s=t.flatMap(r=>Array.isArray(r.modifiers)?r.modifiers:[]).filter(r=>r.target==="damage"&&r.type===qe.ADD).reduce((r,a)=>r+Se(a.value,e),0);return(e.bonusDamage||0)+s});const ee={updateCurrency:(e,t)=>{y.update(n=>{let s=n.currency.gp*100+n.currency.sp*10+n.currency.cp,r=0;return e==="gp"&&(r=t*100),e==="sp"&&(r=t*10),e==="cp"&&(r=t),s+=r,s<0&&(s=0),{...n,currency:{gp:Math.floor(s/100),sp:Math.floor(s%100/10),cp:s%100%10}}})},advanceRound:e=>{y.update(t=>{const n=t.currentRound||1;if(e==="next"){const s=(t.effects||[]).map(r=>{if(r.isActive&&r.duration==="ROUNDS"&&r.roundsLeft>0){const a=r.roundsLeft-1;return a<=0?{...r,roundsLeft:0,isActive:!1}:{...r,roundsLeft:a}}return r});return{...t,currentRound:n+1,effects:s}}else return{...t,currentRound:Math.max(1,n-1)}})},addToHistory:(e,t=!0)=>{const n=C(y),s=C(rt);if(e.id&&s.find(i=>i.id===e.id))return;const r={id:e.id||nt(),timestamp:e.timestamp||new Date,charName:n.name,source:e.source||"gm",name:e.name||"Action",...e};rt.update(i=>[r,...i]),C(Qt).autoOpenHistory?Be.set(!0):C(Be)||_t.set(!0),t&&n.campaignId&&qt(async()=>{const{syncRoll:i}=await Promise.resolve().then(()=>Bt);return{syncRoll:i}},void 0,import.meta.url).then(({syncRoll:i})=>{i(r)})},clearHistory:()=>rt.set([]),addItem:e=>y.update(t=>({...t,equipment:[...t.equipment,e]})),updateItem:e=>y.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?e:n)})),deleteItem:e=>y.update(t=>({...t,equipment:t.equipment.filter(n=>n.id!==e)})),useConsumable:e=>{if(e.quantity>0){const t=C(de);ee.updateItem({...e,quantity:e.quantity-1}),ee.addToHistory({source:"item",name:e.name,description:t("sofww.item_types.consumable")+`: ${e.name}`})}},equipItem:(e,t=null)=>{y.update(n=>{let s=[...n.equipment];return e.type===ve.ARMOR?s=s.map(r=>r.id===e.id?{...r,equipped:!r.equipped}:r.type===ve.ARMOR&&e.type===ve.ARMOR&&!e.equipped?{...r,equipped:!1}:r):(e.type===ve.WEAPON||e.type===ve.SHIELD)&&(s=s.map(r=>r.id===e.id?{...r,equippedState:t}:r)),{...n,equipment:s}})},toggleAffliction:e=>{y.update(t=>t.afflictions.includes(e)?{...t,afflictions:t.afflictions.filter(n=>n!==e)}:{...t,afflictions:[...t.afflictions,e]})},addLanguage:e=>y.update(t=>({...t,languages:[...t.languages,e]})),removeLanguage:e=>y.update(t=>({...t,languages:t.languages.filter((n,s)=>s!==e)})),addSense:e=>y.update(t=>({...t,senses:[...t.senses||[],e]})),removeSense:e=>y.update(t=>({...t,senses:(t.senses||[]).filter((n,s)=>s!==e)})),confirmRest:()=>{y.update(t=>{const n=t.spells.map(r=>({...r,castings:r.maxCastings})),s=t.talents.map(r=>({...r,uses:r.maxUses}));return{...t,spells:n,talents:s}}),We.set(0);const e=C(Ct);Ce.set(e),He.set({type:null,isOpen:!1,data:null})},finalizeRoll:(e,t,n=[],s={})=>{const r=C(y),a=C(Zt),i=C(de),l=e.type==="weapon_attack",u=e.type==="luck",h=e.type==="weapon_damage",f=e?.source,c=f?.name||i("common.labels.action"),o=(k,E)=>k.traits&&k.traits.toLowerCase().includes(E.toLowerCase());let p={},A=()=>{};if(h){let k=parseInt(f.damageDice)||0;const E=f.grip&&f.grip.toLowerCase()==="two"||f.equippedState&&f.equippedState.toLowerCase()==="two";o(f,"Versatile")&&E&&(k+=1);let M=r.bonusDamage||0;o(f,"Light")&&M>1&&(M-=1);const V=n.flatMap(v=>Array.isArray(v.modifiers)?v.modifiers:[]).filter(v=>v.target==="damage"&&v.type===qe.ADD).reduce((v,x)=>v+Se(x.value,r),0),I=M+V,O=Math.max(0,k+I+t);let _=[],U=0,q=[];for(let v=0;v<O;v++){let x=Math.floor(Math.random()*6)+1;if(x===1&&o(f,"Brutal")){const ne=Math.floor(Math.random()*6)+1;q.push(`1->${ne}`),x=ne}else q.push(`${x}`);_.push(x),U+=x}const z=`${O}d6 [${_.join(", ")}] ${q.some(v=>v.includes("->"))?`(Rolagens: ${q.join(", ")})`:""}`;p={damageDice:_,total:U,formula:z},A=()=>{ee.addToHistory({source:"damage",name:f.name,description:`${i("history.source.damage")}: ${O}d6 ${o(f,"Brutal")?"(Brutal)":""}`,formula:z,total:U,effectsApplied:n.map(v=>v.name)}),f.type===ve.EXPLOSIVE&&ee.useConsumable(f)}}else{const k=Math.floor(Math.random()*20)+1;let E=0,M=i("history.source.luck");if(e.type==="attribute")E=(a[e.source.key]||e.source.value)-10,M=i(`sofww.attributes.${e.source.key}`);else if(l){let v="str",x=i("sofww.attributes.str");f.range==="Ranged"&&(v="agi",x=i("sofww.attributes.agi"),o(f,"Thrown")&&(v="str",x=i("sofww.attributes.str"))),o(f,"Nimble")&&(v="agi",x=i("sofww.attributes.agi")),E=(a[v]||10)-10,M=x}const V=Math.floor(n.flatMap(v=>Array.isArray(v.modifiers)?v.modifiers:[]).filter(v=>v.target==="boons"&&v.type===qe.ADD).reduce((v,x)=>v+Se(x.value,r),0));t+=V;let I=0,O="",_=[];if(t!==0){const v=Math.abs(t);for(let ne=0;ne<v;ne++)_.push(Math.floor(Math.random()*6)+1);const x=Math.max(..._);t>0?(I=x,O=` + ${x} [${i("sofdl.rolls.boon")}]`):(I=-x,O=` - ${x} [${i("sofdl.rolls.bane")}]`)}const U=k+E+I;let q="";if(l?q=`${i("history.source.attack")} (${M})`:u?q=i("history.source.luck"):q=`${i("history.source.attribute")}: ${c}`,t!==0&&(q+=` ${i("sofdl.rolls.attribute_test",{values:{attr:"",modifier:t}}).replace(/^[^ ]+ /,"")}`),l&&k===20){let v=[];o(f,"Bludgeoning")&&v.push(i("sofww.afflictions.vulnerable.name")),o(f,"Piercing")&&v.push(i("sofww.afflictions.weakened.name")),o(f,"Slashing")&&v.push("+1d6 Dmg"),v.length>0&&(q+=`
CRÍTICO! ${v.join(" ")} `)}const z=`d20(${k})${E!==0?(E>=0?"+":"")+E:""}${O}`;p={d20:k,boonBaneDice:_,total:U,formula:z},A=()=>{ee.addToHistory({source:l?"attack":u?"luck":"attribute",name:c,description:q,formula:z,total:U,crit:k===20,effectsApplied:n.map(v=>v.name)}),y.update(v=>({...v,effects:v.effects.map(x=>x.isActive&&x.duration==="NEXT_ROLL"?{...x,isActive:!1}:x)})),l&&o(f,"Reload")&&y.update(v=>({...v,equipment:v.equipment.map(x=>x.id===f.id?{...x,isLoaded:!1}:x)}))}}return s.suppressHistory||A(),{...p,commit:A}},reloadWeapon:e=>{const t=C(de);y.update(n=>({...n,equipment:n.equipment.map(s=>s.id===e.id?{...s,isLoaded:!0}:s)})),ee.addToHistory({source:"attribute",name:t("actions.reload"),description:`${t("actions.reload")}: ${e.name}`})},addSpell:e=>y.update(t=>({...t,spells:[...t.spells,e]})),updateSpell:e=>y.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?e:n)})),deleteSpell:e=>y.update(t=>({...t,spells:t.spells.filter(n=>n.id!==e)})),commitSpellCast:e=>{e.castings>0&&(y.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?{...n,castings:n.castings-1}:n)})),ee.addToHistory({source:"spell",name:e.name,description:e.description}),He.set({type:null,isOpen:!1,data:null}))},addTalent:e=>y.update(t=>({...t,talents:[...t.talents,e]})),updateTalent:e=>y.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?e:n)})),deleteTalent:e=>y.update(t=>({...t,talents:t.talents.filter(n=>n.id!==e)})),commitTalentUse:e=>{e.activityType==="Duration"&&e.duration==="LUCK_ENDS"?y.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?{...n,uses:0}:n)})):e.maxUses&&y.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?{...n,uses:n.uses-1}:n)})),ee.addToHistory({source:"talent",name:e.name,description:e.description}),He.set({type:null,isOpen:!1,data:null})},recoverTalent:e=>{y.update(t=>({...t,talents:t.talents.map(n=>n.id===e&&n.uses<n.maxUses?{...n,uses:(n.uses||0)+1}:n)}))},rollLuckTalent:e=>{const t=C(de),n=Math.floor(Math.random()*20)+1,s=n>=10,a=C(y).talents.find(i=>i.id===e);ee.addToHistory({source:"luck",name:`${t("character.history.source.luck")} - ${a?.name||t("character.talents.title")}`,formula:`d20(${n})`,total:n,description:s?t("character.dice_roll.luck_success",{values:{total:n}}):t("character.dice_roll.luck_failure",{values:{total:n}})}),s&&y.update(i=>({...i,talents:i.talents.map(l=>l.id===e?{...l,uses:1}:l)}))},addEffect:e=>y.update(t=>({...t,effects:[...t.effects,e]})),updateEffect:e=>y.update(t=>({...t,effects:t.effects.map(n=>n.id===e.id?e:n)})),deleteEffect:e=>y.update(t=>({...t,effects:t.effects.filter(n=>n.id!==e)})),toggleEffect:e=>y.update(t=>({...t,effects:t.effects.map(n=>{if(n.id===e){const s=!n.isActive;return{...n,isActive:s,roundsLeft:s&&n.duration==="ROUNDS"&&n.initialRounds||n.roundsLeft}}return n})})),cleanInactiveEffects:()=>y.update(e=>({...e,effects:e.effects.filter(t=>t.isActive)})),applyEffectToCharacter:(e,t)=>{const n=e.name||(t?t.name:"Effect"),s=e.description||(t?t.description:""),r={id:nt(),isActive:!0,name:n,description:s,roundsLeft:0,duration:"PERMANENT",modifiers:[],...e};r.duration==="ROUNDS"&&!r.initialRounds&&(r.initialRounds=r.roundsLeft),y.update(a=>({...a,effects:[...a.effects,r]}))},checkLuckEnds:e=>{const t=C(de),n=Math.floor(Math.random()*20)+1,s=n>=10;ee.addToHistory({source:"luck",name:t("sofww.duration.luck_ends"),description:s?t("character.dice_roll.luck_success",{values:{total:n}}):t("character.dice_roll.luck_failure",{values:{total:n}})}),s&&y.update(r=>({...r,effects:r.effects.map(a=>a.id===e?{...a,isActive:!1}:a)}))},joinCampaign:e=>{y.update(t=>({...t,campaignId:e.id,campaignName:e.name,gmName:e.gmName||"Game Master"})),qt(async()=>{const{joinCampaignRoom:t}=await Promise.resolve().then(()=>Bt);return{joinCampaignRoom:t}},void 0,import.meta.url).then(({joinCampaignRoom:t})=>{t(e.id,!1)})},leaveCampaign:()=>{y.update(e=>({...e,campaignId:null,campaignName:null,gmName:null,combatActive:!1}))}},fa=Object.freeze(Object.defineProperty({__proto__:null,activeEffects:ze,activeTab:Cr,appSettings:Qt,character:y,characterActions:ee,currentHealth:Ce,damage:We,damagePercentage:Pr,defaultCharacter:$n,derivedStats:Zt,effectiveMaxHealth:Bn,effectiveSpeed:Lr,evaluateModifierValue:Se,hasUnreadRolls:_t,isHistoryOpen:Be,isIncapacitated:jn,isInjured:Nr,modalState:He,normalHealth:Ct,rollHistory:rt,tempHealth:Ir,totalDefense:Ur},Symbol.toStringTag,{value:"Module"})),Dr=new Ae,qr={id:"",system:"sofdl",name:"",ancestry:"",level:0,paths:{novice:"",expert:"",master:""},imageUrl:"",attributes:{strength:10,agility:10,intellect:10,will:10},perception:10,defense:10,health:10,healingRate:2,size:1,speed:10,power:0,damage:0,insanity:0,corruption:0,description:"",notes:"",professions:[],languages:["Comum"],senses:[],afflictions:[],talents:[],spells:[],equipment:[],currency:{gc:0,ss:0,cp:0,bits:0},effects:[],campaignId:null,campaignName:null,gmName:null,campaignApproval:null,combatActive:!1,currentRound:1,initiative:!1,acted:!1,magicSystem:"standard"},w=Z(JSON.parse(JSON.stringify(qr))),Hr=B(w,e=>e.effects.filter(t=>t.isActive)),_e=B([w,Hr],([e,t])=>{const n={strength:e.attributes.strength,agility:e.attributes.agility,intellect:e.attributes.intellect,will:e.attributes.will,perception:e.perception,defense:e.defense,health:e.health,speed:e.speed,healingRate:e.healingRate,power:e.power,boons:0},s=[];t.forEach(i=>{i.modifiers&&i.modifiers.forEach(l=>{s.push(l)})});const r=i=>i==="healing_rate"?"healingRate":i;return Object.keys(n).forEach(i=>{const l=s.filter(f=>r(f.target)===i);if(l.length===0)return;const u=l.filter(f=>f.type==="SET");if(u.length>0){const f=u[u.length-1];n[i]=Dt(f.value,e)}u.length===0&&l.filter(c=>c.type==="ADD").forEach(c=>{n[i]+=Dt(c.value,e)}),l.filter(f=>f.type==="MULT").forEach(f=>{n[i]*=Dt(f.value,e)}),n[i]=Math.floor(n[i])}),{strength:n.strength,agility:n.agility,intellect:n.intellect,will:n.will,perception:n.perception,defense:n.defense,health:n.health,speed:n.speed,healingRate:n.healingRate,power:n.power,boons:n.boons}}),pa=B(_e,e=>({strength:e.strength,agility:e.agility,intellect:e.intellect,will:e.will})),Fr=B(_e,e=>({strength:e.strength-10,agility:e.agility-10,intellect:e.intellect-10,will:e.will-10}));B([w,_e],([e,t])=>t.health-e.damage);B([w,_e],([e,t])=>e.damage>=t.health/2);B([w,_e],([e,t])=>e.damage>=t.health);function Dt(e,t){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim();if(!isNaN(Number(n)))return Number(n);try{const s={};t.attributes&&Object.entries(t.attributes).forEach(([a,i])=>{s[a]=i}),s.level=t.level||0,s.perception=t.perception||0,s.defense=t.defense||0,s.health=t.health||0,s.healingRate=t.healingRate||0,s.size=t.size||0,s.speed=t.speed||0,s.power=t.power||0,s.damage=t.damage||0,s.insanity=t.insanity||0,s.corruption=t.corruption||0;const r=n.replace(/@(\w+)/g,"$1");return Dr.evaluate(r,s)}catch{return 0}}const ha=B(_e,e=>Math.max(0,e.healingRate)),Ue={set:e=>{w.update(t=>{const n={...t,...e};return e.health!==void 0&&e.healingRate===void 0&&(n.healingRate=Math.floor(n.health/4)),n})},updateAttribute:(e,t)=>{w.update(n=>({...n,attributes:{...n.attributes,[e]:t}}))},takeDamage:e=>{w.update(t=>{const n=Math.max(0,Math.min(t.health,t.damage+e));return{...t,damage:n}})},heal:e=>{w.update(t=>{const n=Math.max(0,t.damage-e);return{...t,damage:n}})},updateStat:(e,t)=>{w.update(n=>({...n,[e]:Math.max(0,t)}))},toggleEffect:e=>{w.update(t=>({...t,effects:t.effects.map(n=>n.id===e?{...n,isActive:!n.isActive}:n)}))},deleteEffect:e=>{w.update(t=>({...t,effects:t.effects.filter(n=>n.id!==e)}))},cleanInactiveEffects:()=>{w.update(e=>({...e,effects:e.effects.filter(t=>t.isActive)}))},advanceRound:e=>{w.update(t=>{if(e==="next"){const n=t.effects.map(s=>s.isActive&&s.duration==="END_OF_ROUND"?{...s,isActive:!1}:s);return{...t,currentRound:t.currentRound+1,effects:n}}return{...t,currentRound:Math.max(1,t.currentRound-1)}})},checkLuckEnds:e=>{const n=C(w).effects.find(r=>r.id===e),s=C(de);He.set({type:"pre_roll",isOpen:!0,data:{type:"luck_ends",system:"sofdl",effectId:e,source:{name:n?.name||s("sofdl.rolls.effect")}}})},checkConcentration:e=>{const n=C(w).effects.find(r=>r.id===e),s=C(de);He.set({type:"pre_roll",isOpen:!0,data:{type:"concentration",system:"sofdl",effectId:e,key:"will",source:{name:n?.name||s("sofdl.rolls.concentration")}}})},addSpell:e=>{w.update(t=>({...t,spells:[...t.spells,{...e,id:e.id||nt()}]}))},updateSpell:e=>{w.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?e:n)}))},deleteSpell:e=>{w.update(t=>({...t,spells:t.spells.filter(n=>n.id!==e)}))},castSpell:e=>{const n=C(w).spells.find(s=>s.id===e);n&&(w.update(s=>({...s,spells:s.spells.map(r=>r.id===e?{...r,castingsUsed:(r.castingsUsed||0)+1}:r)})),Ue.addToHistory({source:"spell",name:n.name,description:n.description,type:"spell"}))},resetSpellCastings:()=>{w.update(e=>({...e,spells:e.spells.map(t=>({...t,castingsUsed:0}))}))},addTalent:e=>{w.update(t=>({...t,talents:[...t.talents,{...e,id:e.id||nt()}]}))},updateTalent:e=>{w.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?e:n)}))},deleteTalent:e=>{w.update(t=>({...t,talents:t.talents.filter(n=>n.id!==e)}))},useTalent:e=>{const n=C(w).talents.find(s=>s.id===e);n&&(w.update(s=>({...s,talents:s.talents.map(r=>r.id===e&&r.uses>0?{...r,uses:r.uses-1}:r)})),Ue.addToHistory({source:"talent",name:n.name,description:n.description,type:"talent"}))},resetTalentUses:()=>{w.update(e=>({...e,talents:e.talents.map(t=>({...t,uses:t.maxUses}))}))},addSense:e=>{w.update(t=>({...t,senses:t.senses.includes(e)?t.senses:[...t.senses,e]}))},removeSense:e=>{w.update(t=>({...t,senses:t.senses.filter((n,s)=>s!==e)}))},toggleAffliction:e=>{w.update(t=>({...t,afflictions:t.afflictions.includes(e)?t.afflictions.filter(n=>n!==e):[...t.afflictions,e]}))},leaveCampaign:()=>{w.update(e=>({...e,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}))},addToHistory:(e,t=!0)=>{const n=C(w),s={id:e.id||nt(),timestamp:e.timestamp||new Date,charName:n.name,...e};rt.update(a=>[s,...a]),C(Qt).autoOpenHistory?Be.set(!0):C(Be)||_t.set(!0),t&&n.campaignId&&qt(async()=>{const{syncRoll:a}=await Promise.resolve().then(()=>Bt);return{syncRoll:a}},void 0,import.meta.url).then(({syncRoll:a})=>{a(s)})},addLanguage:e=>w.update(t=>({...t,languages:[...t.languages,e]})),removeLanguage:e=>w.update(t=>({...t,languages:t.languages.filter((n,s)=>s!==e)})),addProfession:e=>w.update(t=>({...t,professions:[...t.professions,e]})),removeProfession:e=>w.update(t=>({...t,professions:t.professions.filter((n,s)=>s!==e)})),updateCurrency:(e,t)=>{w.update(n=>{const s=Math.max(0,(n.currency[e]||0)+t);return{...n,currency:{...n.currency,[e]:s}}})},addItem:e=>w.update(t=>({...t,equipment:[...t.equipment,e]})),updateItem:e=>w.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?e:n)})),deleteItem:e=>w.update(t=>({...t,equipment:t.equipment.filter(n=>n.id!==e)})),useConsumable:e=>{w.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?{...n,quantity:Math.max(0,n.quantity-1)}:n)}))},reloadWeapon:e=>w.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?{...n,isLoaded:!0}:n)})),finalizeRoll:(e,t,n=[],s={})=>{C(w);const r=C(Fr),a=C(_e),i=e?.type==="weapon_damage"||e?.type==="spell_damage",l=C(de),u=e?.source?.name||e?.key||l("character.modals.attribute");let h={},f=()=>{};if(i){const c=e.source?.damage??e.source?.damageDice??"1d6",o=String(c),p=Number(e.source?.damageMod)||0;let A=0,k=[],E="";if(o==="0")A=0,E="0";else if(!o.includes("d"))A=parseInt(o)||0,E=`${A}`,k=[A];else{const O=o.match(/(\d+)d(\d+)/);if(O){const _=parseInt(O[1])||1,U=parseInt(O[2])||6;for(let q=0;q<_;q++){const z=Math.floor(Math.random()*U)+1;A+=z,k.push(z)}E=`${o} [${k.join(", ")}]`}else A=1,E="1"}const M=A+t+p,V=t+p!==0?`${t+p>0?"+":""}${t+p}`:"",I=`${E}${V}`;h={damageDice:k,total:M,formula:I},f=()=>{const O=C(de);Ue.addToHistory({source:"damage",name:u,description:O("sofdl.rolls.damage_description",{values:{source:u}}),formula:I,total:M,effectsApplied:n})}}else{const c=Math.floor(Math.random()*20)+1;let o=0,p=u;e.type==="attribute"?(o=r[e.key]||0,p=l(`sofdl.attributes.${e.key}`)):e.type==="luck"&&(o=0,p=l("character.luck_test"));let A=t+(a.boons||0),k=0,E="",M=[];if(A!==0){const _=Math.abs(A);for(let q=0;q<_;q++)M.push(Math.floor(Math.random()*6)+1);const U=Math.max(...M);A>0?(k=U,E=` + ${U} [${l("sofdl.rolls.boon")}]`):(k=-U,E=` - ${U} [${l("sofdl.rolls.bane")}]`)}let V="attribute";e.type==="weapon_attack"?V="attack":(e.type==="luck"||e.type==="luck_ends")&&(V="luck");const I=c+o+k,O=`d20(${c})${o!==0?(o>=0?"+":"")+o:""}${E}`;h={d20:c,boonBaneDice:M,total:I,formula:O},f=()=>{Ue.addToHistory({source:V,name:p,description:e.type==="luck_ends"?l("sofdl.rolls.luck_ends",{values:{effect:u}}):l("sofdl.rolls.attribute_test",{values:{attr:p,modifier:t}}),formula:O,total:I,crit:c===20,effectsApplied:n}),e.type==="luck_ends"&&I>=10&&w.update(_=>({..._,effects:_.effects.map(U=>U.id===e.effectId?{...U,isActive:!1}:U)}))}}return s.suppressHistory||f(),{...h,commit:f}},rest:()=>{w.update(e=>{const t=e.spells.map(r=>({...r,castingsUsed:0})),n=e.talents.map(r=>({...r,uses:r.isPassive?0:r.maxUses})),s=Math.max(0,e.damage-e.healingRate);return{...e,spells:t,talents:n,damage:s}})}},Jn={appId:Yn,trackerUrls:["wss://tracker.openwebtorrent.com","wss://tracker.files.fm:7073/announce","wss://tracker.webtorrent.dev","wss://toad.vibe.community:443/announce","wss://tracker.btorrent.xyz"]},ae=Z({roomId:null,peers:[],currentCharacterId:null,lastGmUpdate:0,isGM:!1,isConnected:!1}),Vr=B(ae,e=>e.lastGmUpdate?Date.now()-e.lastGmUpdate<6e4:!1);let j=null,we=null,ct=null,ft=null,pt=null,ht=null,xe=null,oe=null,En=0,Mn=0;const $r=2e3,Br={appId:"weird-wizard-vault-lobby"},$t=Z([]);function dt(e,t){if(!e)return!0;try{return e.leave(),!0}catch(n){return console.warn(`Failed to leave ${t}:`,n),!1}}function Gn(e){return Date.now()-e>=$r}function Wn(){if(we&&be)return console.log("Lobby already connected, reusing existing connection"),be;if(!Gn(En))return console.warn("Lobby join rate limited. Skipping duplicate join attempt."),null;En=Date.now(),xe&&(clearInterval(xe),xe=null),dt(we,"existing lobby"),we=null;try{we=Un(Br,"public-discovery");const[e,t]=we.makeAction("discovery");return t(n=>{$t.update(s=>{const r=s.findIndex(a=>a.id===n.id);if(r!==-1){const a=[...s];return a[r]={...n,lastSeen:Date.now()},a}return[...s,{...n,lastSeen:Date.now()}]})}),xe=setInterval(()=>{const n=Date.now();$t.update(s=>s.filter(r=>n-r.lastSeen<12e4))},6e4),e}catch(e){return console.error("Failed to join lobby:",e),we=null,null}}let be;function jr(e){return be?(be({id:e.id,name:e.name,gmName:e.gmName||"Mestre",description:e.description,system:e.system}),!0):(console.warn("Cannot announce campaign: lobby not initialized"),!1)}function Jr(){if(typeof window<"u"){const e=Wn();e&&(be=e)}}typeof window<"u"&&(Jr(),window.addEventListener("beforeunload",()=>{Gr()}));function Gr(){xe&&(clearInterval(xe),xe=null),oe&&(clearInterval(oe),oe=null),dt(we,"lobby"),dt(j,"room"),we=null,j=null,be=null}let Ne=null;function Wr(e,t=!1,n=null){const s=`campaign-${e}`;if(Ne===s&&j)return ae.update(r=>({...r,isGM:t,currentCharacterId:n})),j;if(!Gn(Mn))return console.warn("Campaign join rate limited. Skipping duplicate join attempt."),j;Mn=Date.now(),oe&&(clearInterval(oe),oe=null),dt(j,"existing campaign room"),j=null,Ne=null,ct=null,ft=null,pt=null,ht=null;try{Ne=s,j=Un(Jn,Ne),ae.set({isConnected:!0,isGM:t,currentCharacterId:n,peers:[],roomId:e,lastGmUpdate:0});const[r,a]=j.makeAction("combat"),[i,l]=j.makeAction("history"),[u,h]=j.makeAction("charUpdate"),[f,c]=j.makeAction("campaign");return ct=r,ft=i,pt=u,ht=f,a(o=>{t||y.update(p=>({...p,currentRound:o.round,combatActive:o.active}))}),c(o=>{ae.update(p=>({...p,lastGmUpdate:Date.now()})),t||y.update(p=>({...p,campaignName:o.name,gmName:o.gmName,passwordHash:o.passwordHash,system:o.system}))}),t&&(oe=setInterval(()=>{if(!be)return;const o=mt.get(e);o&&o.isPublished&&be({id:e,name:o.name,gmName:o.gmName||"Mestre",description:o.description})},3e4)),l(o=>{ee.addToHistory(o,!1)}),h(o=>{if(t){const p=mt.get(e);if(p){const A=p.members||[],k=A.findIndex(O=>O.id===o.id);let E;if(k!==-1){E=[...A];const O=E[k],_={...o};O.campaignApproval==="approved"&&o.campaignApproval==="pending"&&delete _.campaignApproval,E[k]={...O,..._,lastUpdate:Date.now()}}else E=[...A,{...o,lastUpdate:Date.now()}];const M=p.activeEnemies||[],V=M.findIndex(O=>O.id===o.id&&O.type==="player");let I=M;V!==-1&&(I=[...M],I[V]={...I[V],...o}),mt.set(e,{...p,members:E,activeEnemies:I})}}else{const p=C(ae),A=C(y),k=p.currentCharacterId||A?.id;if(k&&k===o.id){const E=o.system==="sofdl";if(o.campaignApproval==="rejected"||o.campaignId===null){E?Ue.leaveCampaign():y.update(M=>({...M,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}));return}E?Ue.set({name:o.name,afflictions:o.afflictions,senses:o.senses,initiative:o.initiative,acted:o.acted,campaignApproval:o.campaignApproval,imageUrl:o.imageUrl,notes:o.notes,damage:o.damage,health:o.health,healingRate:o.healingRate,insanity:o.insanity,corruption:o.corruption,defense:o.defense,speed:o.speed,power:o.power,attributes:o.attributes}):(y.update(M=>({...M,name:o.name||M.name,afflictions:o.afflictions||M.afflictions,senses:o.senses||M.senses,initiative:o.initiative!==void 0?o.initiative:M.initiative??!1,acted:o.acted!==void 0?o.acted:M.acted??!1,campaignApproval:o.campaignApproval||M.campaignApproval,imageUrl:o.imageUrl||M.imageUrl,notes:o.notes!==void 0?o.notes:M.notes})),o.damage!==void 0&&We.set(o.damage),o.currentHealth!==void 0&&Ce.set(o.currentHealth),o.normalHealth!==void 0&&Ct.set(o.normalHealth))}}}),j.onPeerJoin(o=>{if(ae.update(p=>({...p,peers:[...p.peers,o]})),t){const p=mt.get(e);p&&(p.combat&&r(p.combat),f({name:p.name,gmName:p.gmName||"Mestre",passwordHash:p.passwordHash,system:p.system}))}}),j.onPeerLeave(o=>{ae.update(p=>({...p,peers:p.peers.filter(A=>A!==o)}))}),j}catch(r){return console.error("Failed to join campaign room:",r),j=null,Ne=null,ae.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0}),null}}function zr(e,t){ct&&ct(t)}function Kr(e,t){ht&&ht({name:t.name,gmName:t.gmName||"Mestre",passwordHash:t.passwordHash,system:t.system})}function Xr(e){ft&&ft(e)}function Yr(e){pt&&pt(e)}function Qr(){oe&&(clearInterval(oe),oe=null),dt(j,"campaign room"),j=null,Ne=null,ct=null,ft=null,pt=null,ht=null,ae.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0})}const Bt=Object.freeze(Object.defineProperty({__proto__:null,announceCampaign:jr,isGmOnline:Vr,joinCampaignRoom:Wr,joinLobby:Wn,leaveCampaignRoom:Qr,publicCampaigns:$t,roomConfig:Jn,syncCampaign:Kr,syncCharacter:Yr,syncCombat:zr,syncRoll:Xr,syncState:ae},Symbol.toStringTag,{value:"Module"}));export{fa as $,Pr as A,He as B,qe as C,oa as D,Ue as E,pa as F,Zt as G,Dt as H,ve as I,Se as J,Hr as K,ze as L,la as M,w as N,_e as O,Ct as P,Ce as Q,Ur as R,Lr as S,Cr as T,ia as U,Fr as V,ha as W,ca as X,ua as Y,qr as Z,$n as _,Un as a,ra as b,y as c,Qt as d,ee as e,rt as f,Yr as g,Kr as h,Vr as i,Wr as j,Be as k,Qr as l,jr as m,zr as n,aa as o,ae as p,_t as q,Jn as r,Pe as s,$t as t,nt as u,Bn as v,We as w,Ir as x,Nr as y,jn as z};
